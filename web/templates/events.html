{% extends "base.html" %}

{% block title %}Events - Asset Monitor{% endblock %}

{% block content %}
<div class="events-page" style="padding: 1.5rem;">
    <!-- Page Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h2 style="margin: 0; font-size: 1.75rem; font-weight: 600; color: #1a202c;">
                <i class="fas fa-bell" style="color: #667eea;"></i> Security Events
            </h2>
            <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.875rem;">
                Monitor and track security events across all projects
            </p>
        </div>
        <button class="btn btn-primary" onclick="refreshEvents()"
            style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>

    <!-- Quick Stats Cards -->
    <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.25rem; margin-bottom: 2rem;">
        <div class="stat-card"
            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Events</div>
                    <div style="font-size: 2rem; font-weight: 700;">{{ total_events }}</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 8px;">
                    <i class="fas fa-list" style="font-size: 1.5rem;"></i>
                </div>
            </div>
        </div>

        <div class="stat-card"
            style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Vulnerabilities</div>
                    <div style="font-size: 2rem; font-weight: 700;">{{ vuln_count }}</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 8px;">
                    <i class="fas fa-bug" style="font-size: 1.5rem;"></i>
                </div>
            </div>
        </div>

        <div class="stat-card"
            style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">New Ports</div>
                    <div style="font-size: 2rem; font-weight: 700;">{{ port_count }}</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 8px;">
                    <i class="fas fa-network-wired" style="font-size: 1.5rem;"></i>
                </div>
            </div>
        </div>

        <div class="stat-card"
            style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">DNS Changes</div>
                    <div style="font-size: 2rem; font-weight: 700;">{{ dns_count }}</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 8px;">
                    <i class="fas fa-exchange-alt" style="font-size: 1.5rem;"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div
        style="background: white; padding: 1.25rem 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
        <!-- Header -->
        <div
            style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #f1f5f9;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-filter" style="color: #667eea;"></i>
                <span style="font-weight: 600; color: #1a202c;">Filters</span>
            </div>
            <button class="btn btn-sm" onclick="resetFilters()"
                style="background: #f1f5f9; color: #475569; border: none; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; cursor: pointer;">
                <i class="fas fa-redo"></i> Reset
            </button>
        </div>

        <!-- Row 1: Main Filters -->
        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.75rem; margin-bottom: 0.75rem;">
            <div>
                <label
                    style="display: block; font-size: 0.7rem; font-weight: 500; color: #64748b; margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.5px;">Project</label>
                <select id="project-filter" class="form-control" onchange="applyFilters()"
                    style="font-size: 0.8rem; padding: 0.5rem;">
                    <option value="">All Projects</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label
                    style="display: block; font-size: 0.7rem; font-weight: 500; color: #64748b; margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.5px;">Severity</label>
                <select id="severity-filter" class="form-control" onchange="applyFilters()"
                    style="font-size: 0.8rem; padding: 0.5rem;">
                    <option value="">All</option>
                    <option value="critical">Critical</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                    <option value="info">Info</option>
                </select>
            </div>
            <div>
                <label
                    style="display: block; font-size: 0.7rem; font-weight: 500; color: #64748b; margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.5px;">Event
                    Type</label>
                <select id="type-filter" class="form-control" onchange="applyFilters()"
                    style="font-size: 0.8rem; padding: 0.5rem;">
                    <option value="">All Types</option>
                    <option value="port_new">New Ports</option>
                    <option value="vulnerability_found">Vulnerabilities</option>
                    <option value="dns_changed">DNS Changes</option>
                    <option value="http_status_changed">HTTP Status</option>
                    <option value="subdomain_new">New Subdomains</option>
                    <option value="endpoint_new">New Endpoints</option>
                </select>
            </div>
            <div>
                <label
                    style="display: block; font-size: 0.7rem; font-weight: 500; color: #64748b; margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.5px;">Status</label>
                <select id="ack-filter" class="form-control" onchange="applyFilters()"
                    style="font-size: 0.8rem; padding: 0.5rem;">
                    <option value="">All</option>
                    <option value="unacknowledged">Unacknowledged</option>
                    <option value="acknowledged">Acknowledged</option>
                </select>
            </div>
            <div>
                <label
                    style="display: block; font-size: 0.7rem; font-weight: 500; color: #64748b; margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.5px;">Date
                    Range</label>
                <select id="date-filter" class="form-control" onchange="handleDateFilter()"
                    style="font-size: 0.8rem; padding: 0.5rem;">
                    <option value="7">Last 7 Days</option>
                    <option value="1">Today</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
            <div>
                <label
                    style="display: block; font-size: 0.7rem; font-weight: 500; color: #64748b; margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.5px;">Sort</label>
                <select id="sort-filter" class="form-control" onchange="applyFilters()"
                    style="font-size: 0.8rem; padding: 0.5rem;">
                    <option value="desc">Newest First</option>
                    <option value="asc">Oldest First</option>
                </select>
            </div>
        </div>

        <!-- Row 2: Search & Exclude -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
            <div style="position: relative;">
                <label
                    style="display: block; font-size: 0.7rem; font-weight: 500; color: #64748b; margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.5px;">Search</label>
                <i class="fas fa-search"
                    style="position: absolute; left: 0.75rem; top: 2rem; color: #94a3b8; font-size: 0.75rem;"></i>
                <input type="text" id="search-filter" class="form-control" placeholder="Search in event summary..."
                    oninput="applyFilters()" style="font-size: 0.8rem; padding: 0.5rem 0.75rem 0.5rem 2rem;">
            </div>
            <div style="position: relative;">
                <label
                    style="display: block; font-size: 0.7rem; font-weight: 500; color: #64748b; margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.5px;">Exclude
                    (comma-separated)</label>
                <i class="fas fa-ban"
                    style="position: absolute; left: 0.75rem; top: 2rem; color: #94a3b8; font-size: 0.75rem;"></i>
                <input type="text" id="exclude-filter" class="form-control" placeholder="e.g. favicon, robots.txt"
                    oninput="applyFilters()" style="font-size: 0.8rem; padding: 0.5rem 0.75rem 0.5rem 2rem;">
            </div>
        </div>

        <!-- Custom Date Range (hidden by default) -->
        <div id="custom-date-range"
            style="display: none; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed #e2e8f0;">
            <div style="display: flex; gap: 1rem; align-items: center;">
                <div>
                    <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase;">From</label>
                    <input type="date" id="date-from" class="form-control" onchange="applyFilters()"
                        style="font-size: 0.8rem; padding: 0.5rem;">
                </div>
                <div>
                    <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase;">To</label>
                    <input type="date" id="date-to" class="form-control" onchange="applyFilters()"
                        style="font-size: 0.8rem; padding: 0.5rem;">
                </div>
            </div>
        </div>

        <!-- Info Bar -->
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f1f5f9;">
            <span style="color: #64748b; font-size: 0.8rem;"><i class="fas fa-info-circle"></i> <span
                    id="event-count">Loading...</span></span>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 0.75rem; color: #64748b;">Show</span>
                <select id="page-size" class="form-control"
                    style="width: auto; font-size: 0.8rem; padding: 0.25rem 0.5rem;" onchange="changePageSize()">
                    <option value="25">25</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                </select>
                <span style="font-size: 0.75rem; color: #64748b;">per page</span>
            </div>
        </div>
    </div>

    <!-- Events Table -->
    <div style="background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;">
        <!-- Bulk Actions Bar (hidden by default) -->
        <div id="bulk-actions-bar"
            style="display: none; background: #f8fafc; padding: 0.75rem 1.25rem; border-bottom: 1px solid #e2e8f0; animation: slideDown 0.2s ease-out;">
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <span style="font-size: 0.875rem; color: #475569; font-weight: 500;">
                    <i class="fas fa-check-square"></i> <span id="selected-count">0</span> selected
                </span>
                <div style="height: 20px; width: 1px; background: #cbd5e1;"></div>
                <button class="btn btn-sm btn-success" onclick="bulkAcknowledge()"
                    style="display: flex; align-items: center; gap: 0.375rem;">
                    <i class="fas fa-check"></i> Acknowledge Selected
                </button>
                <button class="btn btn-sm btn-danger" onclick="bulkDelete()"
                    style="display: flex; align-items: center; gap: 0.375rem;">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
                <button class="btn btn-sm btn-secondary" onclick="clearSelection()"
                    style="display: flex; align-items: center; gap: 0.375rem; margin-left: auto;">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" style="display: none; padding: 3rem; text-align: center;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #667eea;"></i>
            <p style="margin-top: 1rem; color: #64748b;">Loading events...</p>
        </div>

        <!-- Table Container -->
        <div id="table-container" style="overflow-x: auto;">
            <table class="table" style="margin: 0; width: 100%;">
                <thead style="background: linear-gradient(to right, #667eea, #764ba2); color: white;">
                    <tr>
                        <th style="padding: 1rem; font-weight: 600; width: 40px;">
                            <input type="checkbox" id="select-all" onclick="toggleSelectAll()"
                                style="width: 16px; height: 16px; cursor: pointer;">
                        </th>
                        <th style="padding: 1rem; font-weight: 600;">Severity</th>
                        <th style="padding: 1rem; font-weight: 600;">Type</th>
                        <th style="padding: 1rem; font-weight: 600;">Summary</th>
                        <th style="padding: 1rem; font-weight: 600;">Project</th>
                        <th style="padding: 1rem; font-weight: 600;">Time</th>
                        <th style="padding: 1rem; font-weight: 600; text-align: center;">Actions</th>
                    </tr>
                </thead>
                <tbody id="events-tbody">
                    <!-- Events will be loaded here via AJAX -->
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div id="empty-state" style="display: none; padding: 3rem; text-align: center;">
            <i class="fas fa-inbox" style="font-size: 3rem; color: #cbd5e1;"></i>
            <p style="margin-top: 1rem; color: #64748b; font-size: 1rem; font-weight: 500;">No events found</p>
            <p style="color: #94a3b8; font-size: 0.875rem;">Try adjusting your filters or check back later</p>
        </div>

        <!-- Pagination -->
        <div
            style="padding: 1rem 1.5rem; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div id="pagination-info" style="color: #64748b; font-size: 0.875rem; font-weight: 500;">
                <!-- Pagination info will be inserted here -->
            </div>
            <div id="pagination-controls" style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                <!-- Pagination buttons will be inserted here -->
            </div>
        </div>
    </div>
</div>

<style>
    /* Event row hover effect */
    .event-row:hover {
        background: #f8fafc !important;
    }

    /* Improved detail box styles */
    .event-detail-box {
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .detail-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1rem;
    }

    .detail-column {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
    }

    .detail-column h5 {
        margin: 0 0 0.75rem 0;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e2e8f0;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .detail-column.old-value h5 {
        color: #dc2626;
    }

    .detail-column.new-value h5 {
        color: #10b981;
    }

    .detail-list {
        list-style: none;
        padding: 0;
        margin: 0.5rem 0;
    }

    .detail-list li {
        padding: 0.375rem 0;
        font-family: monospace;
        font-size: 0.875rem;
    }

    .detail-added {
        color: #10b981;
        font-weight: 600;
    }

    .detail-removed {
        color: #dc2626;
        font-weight: 600;
    }

    .detail-info {
        background: #eff6ff;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        border-left: 4px solid #3b82f6;
    }

    .detail-info strong {
        color: #1e40af;
    }

    /* Pagination button styles */
    .pagination-btn {
        padding: 0.5rem 0.75rem;
        border: 1px solid #e2e8f0;
        background: white;
        color: #475569;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .pagination-btn:hover:not(:disabled) {
        background: #f1f5f9;
        border-color: #cbd5e1;
    }

    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    /* Stat card hover effect */
    .stat-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }

        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
</style>

<script>
    // Pagination state
    let currentPage = 1;
    let pageSize = 50;
    let isLoading = false;
    let selectedEvents = new Set();

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadEvents();
    });

    function applyFilters() {
        currentPage = 1; // Reset to first page when filters change
        clearSelection();
        loadEvents();
    }

    function handleDateFilter() {
        const dateFilter = document.getElementById('date-filter').value;
        const customRange = document.getElementById('custom-date-range');

        if (dateFilter === 'custom') {
            customRange.style.display = 'block';
            // Set default dates to last 7 days
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            document.getElementById('date-to').value = today.toISOString().split('T')[0];
            document.getElementById('date-from').value = weekAgo.toISOString().split('T')[0];
        } else {
            customRange.style.display = 'none';
        }
        applyFilters();
    }

    function loadEvents() {
        if (isLoading) return;

        isLoading = true;
        showLoading();

        // Build query parameters
        const params = new URLSearchParams();
        params.append('page', currentPage);
        params.append('per_page', pageSize);

        const search = document.getElementById('search-filter').value;
        if (search) params.append('search', search);

        const projectId = document.getElementById('project-filter').value;
        if (projectId) params.append('project_id', projectId);

        const severity = document.getElementById('severity-filter').value;
        if (severity) params.append('severity', severity);

        const eventType = document.getElementById('type-filter').value;
        if (eventType) params.append('event_type', eventType);

        const acknowledged = document.getElementById('ack-filter').value;
        if (acknowledged) params.append('acknowledged', acknowledged);

        // Date filter
        const dateFilter = document.getElementById('date-filter').value;
        if (dateFilter === 'custom') {
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);
        } else {
            params.append('days', dateFilter);
        }

        // Exclude filter
        const excludeFilter = document.getElementById('exclude-filter').value;
        if (excludeFilter) params.append('exclude', excludeFilter);

        params.append('sort_order', document.getElementById('sort-filter').value);

        fetch(`/api/events?${params}`)
            .then(res => res.json())
            .then(data => {
                renderEvents(data);
                renderPagination(data);
                isLoading = false;
                hideLoading();
            })
            .catch(err => {
                console.error('Failed to load events:', err);
                showError('Failed to load events. Please try again.');
                isLoading = false;
                hideLoading();
            });
    }

    function showLoading() {
        document.getElementById('loading-indicator').style.display = 'block';
        document.getElementById('table-container').style.opacity = '0.5';
    }

    function hideLoading() {
        document.getElementById('loading-indicator').style.display = 'none';
        document.getElementById('table-container').style.opacity = '1';
    }

    function renderEvents(data) {
        const tbody = document.getElementById('events-tbody');
        const emptyState = document.getElementById('empty-state');
        const tableContainer = document.getElementById('table-container');

        // Update count
        if (data.total === 0) {
            document.getElementById('event-count').textContent = 'No events found';
            emptyState.style.display = 'block';
            tableContainer.style.display = 'none';
            return;
        }

        emptyState.style.display = 'none';
        tableContainer.style.display = 'block';
        document.getElementById('event-count').textContent = `Showing ${data.showing_start}-${data.showing_end} of ${data.total} events`;

        // Clear tbody
        tbody.innerHTML = '';

        // Render events
        data.events.forEach(event => {
            // Main event row
            const row = document.createElement('tr');
            row.className = 'event-row';
            row.id = `event-${event.id}`;
            row.style.borderBottom = '1px solid #e2e8f0';
            row.style.transition = 'background 0.2s';

            // Severity badge
            let severityBadge = '';
            const severityColors = {
                'critical': { bg: '#dc2626', icon: 'fa-exclamation-triangle' },
                'high': { bg: '#ea580c', icon: 'fa-exclamation-circle' },
                'medium': { bg: '#f59e0b', icon: 'fa-exclamation' },
                'low': { bg: '#3b82f6', icon: 'fa-info-circle' },
                'info': { bg: '#6b7280', icon: 'fa-info' }
            };
            const sev = severityColors[event.severity] || severityColors['info'];
            severityBadge = `<span style="background: ${sev.bg}; color: white; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.25rem;">
            <i class="fas ${sev.icon}"></i> ${event.severity.toUpperCase()}
        </span>`;

            // Actions
            let actions = '<div style="display: flex; gap: 0.5rem; justify-content: center; align-items: center;">';
            if (event.has_details) {
                actions += `<button class="btn btn-sm btn-primary" onclick="showEventDetail(${event.id})" title="View Details" style="display: inline-flex; align-items: center; gap: 0.25rem;">
                <i class="fas fa-info-circle"></i>
            </button>`;
            }
            if (!event.acknowledged) {
                actions += `<button class="btn btn-sm btn-success" onclick="acknowledgeEvent(${event.id})" title="Acknowledge" style="display: inline-flex; align-items: center; gap: 0.25rem;">
                <i class="fas fa-check"></i>
            </button>`;
            } else {
                actions += `<span style="background: #10b981; color: white; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 500;">
                <i class="fas fa-check-circle"></i> Ack
            </span>`;
            }
            actions += '</div>';

            row.innerHTML = `
            <td style="padding: 1rem; text-align: center;">
                <input type="checkbox" class="event-checkbox" data-id="${event.id}" onclick="toggleEventSelection(${event.id})" style="width: 16px; height: 16px; cursor: pointer;" ${selectedEvents.has(event.id) ? 'checked' : ''}>
            </td>
            <td style="padding: 1rem;">${severityBadge}</td>
            <td style="padding: 1rem;">
                <code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; color: #334155;">${event.type}</code>
            </td>
            <td style="padding: 1rem; max-width: 400px;">
                <div style="color: #1e293b; font-weight: 500;">${event.summary}</div>
            </td>
            <td style="padding: 1rem;">
                <a href="/projects/${event.project_id}" style="color: #667eea; font-weight: 500; text-decoration: none;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">${event.project_name}</a>
            </td>
            <td style="padding: 1rem; white-space: nowrap;">
                <div style="color: #64748b; font-size: 0.875rem;">
                    <i class="fas fa-clock"></i> ${event.created_at}
                </div>
            </td>
            <td style="padding: 1rem; text-align: center;">
                ${actions}
            </td>
        `;

            tbody.appendChild(row);

            // Detail row (hidden by default)
            const detailRow = document.createElement('tr');
            detailRow.id = `event-detail-${event.id}`;
            detailRow.style.display = 'none';
            detailRow.innerHTML = `
            <td colspan="7" style="padding: 0; background: #f8fafc;">
                <div class="event-detail-box" style="margin: 1rem; padding: 1.5rem; background: white; border-radius: 8px; border-left: 4px solid #667eea;">
                    <h4 style="margin: 0 0 1rem 0; color: #667eea; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-info-circle"></i> Event Details
                    </h4>
                    <div id="event-detail-content-${event.id}">
                        <!-- Detail will be loaded here -->
                    </div>
                </div>
            </td>
        `;

            tbody.appendChild(detailRow);
        });
    }

    function renderPagination(data) {
        const paginationInfo = document.getElementById('pagination-info');
        const paginationControls = document.getElementById('pagination-controls');

        // Update info
        paginationInfo.innerHTML = `Showing <strong>${data.showing_start}-${data.showing_end}</strong> of <strong>${data.total}</strong> events`;

        // Clear controls
        paginationControls.innerHTML = '';

        if (data.total_pages <= 1) {
            return;
        }

        // Previous button
        const prevBtn = document.createElement('button');
        prevBtn.className = 'pagination-btn';
        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => changePage(currentPage - 1);
        paginationControls.appendChild(prevBtn);

        // Page numbers
        const maxButtons = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(data.total_pages, startPage + maxButtons - 1);

        if (endPage - startPage < maxButtons - 1) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        // First page
        if (startPage > 1) {
            const btn = createPageButton(1);
            paginationControls.appendChild(btn);

            if (startPage > 2) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.style.padding = '0 0.5rem';
                ellipsis.style.color = '#64748b';
                paginationControls.appendChild(ellipsis);
            }
        }

        // Page numbers
        for (let i = startPage; i <= endPage; i++) {
            const btn = createPageButton(i);
            if (i === currentPage) {
                btn.classList.add('active');
            }
            paginationControls.appendChild(btn);
        }

        // Last page
        if (endPage < data.total_pages) {
            if (endPage < data.total_pages - 1) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.style.padding = '0 0.5rem';
                ellipsis.style.color = '#64748b';
                paginationControls.appendChild(ellipsis);
            }

            const btn = createPageButton(data.total_pages);
            paginationControls.appendChild(btn);
        }

        // Next button
        const nextBtn = document.createElement('button');
        nextBtn.className = 'pagination-btn';
        nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        nextBtn.disabled = currentPage === data.total_pages;
        nextBtn.onclick = () => changePage(currentPage + 1);
        paginationControls.appendChild(nextBtn);
    }

    function createPageButton(pageNum) {
        const btn = document.createElement('button');
        btn.className = 'pagination-btn';
        btn.textContent = pageNum;
        btn.onclick = () => changePage(pageNum);
        return btn;
    }

    function changePage(page) {
        if (page < 1 || isLoading) return;
        currentPage = page;
        loadEvents();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function changePageSize() {
        pageSize = parseInt(document.getElementById('page-size').value);
        currentPage = 1;
        loadEvents();
    }

    function resetFilters() {
        document.getElementById('search-filter').value = '';
        document.getElementById('exclude-filter').value = '';
        document.getElementById('project-filter').value = '';
        document.getElementById('severity-filter').value = '';
        document.getElementById('type-filter').value = '';
        document.getElementById('ack-filter').value = '';
        document.getElementById('date-filter').value = '7';
        document.getElementById('sort-filter').value = 'desc';
        document.getElementById('custom-date-range').style.display = 'none';
        currentPage = 1;
        loadEvents();
    }

    function showEventDetail(eventId) {
        const detailRow = document.getElementById(`event-detail-${eventId}`);
        const contentDiv = document.getElementById(`event-detail-content-${eventId}`);

        if (detailRow.style.display === 'none') {
            fetch(`/api/events/${eventId}`)
                .then(res => res.json())
                .then(event => {
                    console.log('Event data:', event); // Debug
                    const html = formatEventDetails(event);
                    console.log('Formatted HTML:', html); // Debug
                    contentDiv.innerHTML = html;
                    detailRow.style.display = 'table-row';
                })
                .catch(err => {
                    console.error('Error loading event:', err);
                    contentDiv.innerHTML = '<p style="color: #dc2626;">Failed to load event details</p>';
                    detailRow.style.display = 'table-row';
                });
        } else {
            detailRow.style.display = 'none';
        }
    }

    function formatEventDetails(event) {
        const details = event.details || {};

        // If no details, show message
        if (Object.keys(details).length === 0) {
            return '<span style="color: #94a3b8; font-size: 0.85rem;">No additional details stored for this event</span>';
        }

        // Show clean JSON
        const jsonStr = JSON.stringify(details, null, 2);
        return `<pre style="background: #f8fafc; padding: 0.75rem; border-radius: 6px; margin: 0; font-size: 0.8rem; max-height: 250px; overflow-y: auto; border: 1px solid #e2e8f0; white-space: pre-wrap; word-break: break-word;">${jsonStr}</pre>`;
    }

    function acknowledgeEvent(eventId) {
        if (!confirm('Mark this event as acknowledged?')) {
            return;
        }

        fetch(`/api/events/${eventId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ acknowledged: true, acknowledged_by: 'user' })
        })
            .then(res => {
                if (res.ok) {
                    showToast('Event acknowledged successfully', 'success');
                    // Reload current page after 1 second
                    setTimeout(() => loadEvents(), 1000);
                } else {
                    throw new Error('Failed to acknowledge event');
                }
            })
            .catch(err => {
                showToast('Failed to acknowledge event', 'error');
            });
    }

    function refreshEvents() {
        loadEvents();
        showToast('Events refreshed', 'success');
    }

    function showError(message) {
        showToast(message, 'error');
    }

    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        background: ${type === 'success' ? '#10b981' : '#dc2626'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 9999;
        animation: slideIn 0.3s ease-out;
    `;
        toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Selection Functions
    function toggleEventSelection(eventId) {
        if (selectedEvents.has(eventId)) {
            selectedEvents.delete(eventId);
        } else {
            selectedEvents.add(eventId);
        }
        updateBulkActionsBar();
        updateSelectAllState();
    }

    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('select-all');
        const checkboxes = document.querySelectorAll('.event-checkbox');

        if (selectAllCheckbox.checked) {
            checkboxes.forEach(cb => {
                const id = parseInt(cb.dataset.id);
                selectedEvents.add(id);
                cb.checked = true;
            });
        } else {
            checkboxes.forEach(cb => {
                const id = parseInt(cb.dataset.id);
                selectedEvents.delete(id);
                cb.checked = false;
            });
        }
        updateBulkActionsBar();
    }

    function updateSelectAllState() {
        const checkboxes = document.querySelectorAll('.event-checkbox');
        const selectAllCheckbox = document.getElementById('select-all');
        const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
        selectAllCheckbox.checked = allChecked;
    }

    function updateBulkActionsBar() {
        const bar = document.getElementById('bulk-actions-bar');
        const countSpan = document.getElementById('selected-count');

        if (selectedEvents.size > 0) {
            bar.style.display = 'block';
            countSpan.textContent = selectedEvents.size;
        } else {
            bar.style.display = 'none';
        }
    }

    function clearSelection() {
        selectedEvents.clear();
        document.querySelectorAll('.event-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('select-all').checked = false;
        updateBulkActionsBar();
    }

    // Bulk Actions
    function bulkAcknowledge() {
        if (selectedEvents.size === 0) return;

        if (!confirm(`Acknowledge ${selectedEvents.size} selected event(s)?`)) return;

        fetch('/api/events/bulk-update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                event_ids: Array.from(selectedEvents),
                acknowledged: true
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(`Acknowledged ${data.updated_count} events`, 'success');
                    clearSelection();
                    loadEvents();
                } else {
                    throw new Error(data.message || 'Failed');
                }
            })
            .catch(err => {
                showToast('Failed to acknowledge events', 'error');
            });
    }

    function bulkDelete() {
        if (selectedEvents.size === 0) return;

        if (!confirm(`Delete ${selectedEvents.size} selected event(s)? This cannot be undone.`)) return;

        fetch('/api/events/bulk-delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(Array.from(selectedEvents))
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(`Deleted ${data.deleted_count} events`, 'success');
                    clearSelection();
                    loadEvents();
                } else {
                    throw new Error(data.message || 'Failed');
                }
            })
            .catch(err => {
                showToast('Failed to delete events', 'error');
            });
    }
</script>
{% endblock %}