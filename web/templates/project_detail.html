{% extends "base.html" %}

{% block title %}{{ project.name }} - Asset Monitor{% endblock %}

{% block extra_css %}
<style>
.filter-bar {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.filter-bar input,
.filter-bar select {
    padding: 0.5rem;
    border: 1px solid var(--border);
    border-radius: 0.375rem;
    font-size: 0.875rem;
}

.filter-bar input {
    flex: 1;
    min-width: 200px;
}

.filter-bar select {
    min-width: 150px;
}

.asset-table {
    width: 100%;
    font-size: 0.875rem;
}

.asset-table td {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.asset-table td.expandable {
    cursor: pointer;
}

.asset-table td.expandable:hover {
    background: #f8fafc;
}

.badge-list {
    display: flex;
    gap: 0.25rem;
    flex-wrap: wrap;
}

.status-new {
    background: #dcfce7;
    color: #166534;
}

.status-deleted {
    background: #fee2e2;
    color: #991b1b;
}

.status-unchanged {
    background: #e2e8f0;
    color: #475569;
}
</style>
{% endblock %}

{% block content %}
<div class="project-detail">
    <div class="page-header">
        <div>
            <h2>{{ project.name }}</h2>
            <p class="text-muted">{{ project.description or 'No description' }}</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-success" onclick="triggerScan({{ project.id }}, 'normal')">
                <i class="fas fa-play"></i> Run Scan
            </button>
            <button class="btn btn-primary" onclick="triggerScan({{ project.id }}, 'weekly')">
                <i class="fas fa-calendar-week"></i> Weekly Scan
            </button>
            <a href="/projects/{{ project.id }}/edit" class="btn btn-secondary">
                <i class="fas fa-edit"></i> Edit
            </a>
        </div>
    </div>

    <!-- Project info -->
    <div class="info-grid">
        <div class="info-card">
            <h4><i class="fas fa-globe"></i> Domains</h4>
            <ul class="domain-list">
                {% for domain in project.domains %}
                <li>{{ domain.name }}</li>
                {% endfor %}
            </ul>
        </div>

        <div class="info-card">
            <h4><i class="fas fa-clock"></i> Last Scan</h4>
            <p>
                {% if project.last_scan_at %}
                    {{ project.last_scan_at.strftime('%Y-%m-%d %H:%M:%S') }}
                {% else %}
                    Never scanned
                {% endif %}
            </p>
        </div>

        <div class="info-card">
            <h4><i class="fas fa-chart-line"></i> Asset Count</h4>
            <p>
                {% if latest_snapshots.subdomains %}
                    {{ latest_snapshots.subdomains.data.subdomains|length }} subdomains
                {% else %}
                    No data yet
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('assets')">
            <i class="fas fa-table"></i> All Assets
        </button>
        <button class="tab-btn" onclick="switchTab('takeovers')">
            <i class="fas fa-exclamation-triangle"></i> Takeovers
            {% if latest_snapshots.dns and latest_snapshots.dns.scan_metadata and latest_snapshots.dns.scan_metadata.takeover_findings %}
            ({{ latest_snapshots.dns.scan_metadata.takeover_findings|length }})
            {% endif %}
        </button>
        <button class="tab-btn" onclick="switchTab('endpoints')">
            <i class="fas fa-link"></i> Endpoints
            {% if latest_snapshots.endpoints %}({{ latest_snapshots.endpoints.data.urls|length - latest_snapshots.endpoints.data.js_files|length }}){% endif %}
        </button>
        <button class="tab-btn" onclick="switchTab('jsfiles')">
            <i class="fas fa-file-code"></i> JS Files
            {% if latest_snapshots.endpoints %}({{ latest_snapshots.endpoints.data.js_files|length }}){% endif %}
        </button>
        <button class="tab-btn" onclick="switchTab('events')">
            <i class="fas fa-bell"></i> Events
        </button>
        <button class="tab-btn" onclick="switchTab('scans')">
            <i class="fas fa-history"></i> Scans
        </button>
    </div>

    <!-- Tab: All Assets -->
    <div id="tab-assets" class="tab-content active">
        <div class="section">
            <h3>üåê All Discovered Assets</h3>

            <!-- Filters -->
            <div class="filter-bar" style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1.5rem; align-items: center;">
                <div style="flex: 1; min-width: 250px;">
                    <input type="text" id="assetSearchInput"
                           placeholder="üîç Search URL, title, IP, or technology..."
                           onkeyup="filterAssets()"
                           style="width: 100%; padding: 0.625rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem;">
                </div>

                <select id="assetStatusFilter" onchange="filterAssets()"
                        style="padding: 0.625rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; background: white;">
                    <option value="">üìä All Status</option>
                    <option value="2">‚úÖ 2xx Success</option>
                    <option value="3">üîÑ 3xx Redirect</option>
                    <option value="4">‚ö†Ô∏è  4xx Client Error</option>
                    <option value="5">‚ùå 5xx Server Error</option>
                </select>

                <select id="assetTechFilter" onchange="filterAssets()"
                        style="padding: 0.625rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; background: white;">
                    <option value="">üîß All Technologies</option>
                    {% if latest_snapshots.http %}
                    {% set all_technologies = [] %}
                    {% for url, record in latest_snapshots.http.data.http_records.items() %}
                        {% if record.technologies %}
                            {% for tech in record.technologies %}
                                {% if tech not in all_technologies %}
                                    {% set _ = all_technologies.append(tech) %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                    {% for tech in all_technologies|sort %}
                    <option value="{{ tech }}">{{ tech }}</option>
                    {% endfor %}
                    {% endif %}
                </select>

                <button class="btn btn-sm btn-secondary" onclick="resetAssetFilters()"
                        style="padding: 0.625rem 1rem; border: none; border-radius: 8px; background: #64748b; color: white; cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                    <i class="fas fa-undo"></i> Reset
                </button>

                <button class="btn btn-sm btn-primary" onclick="exportAssetsToCSV()"
                        style="padding: 0.625rem 1rem; border: none; border-radius: 8px; background: #667eea; color: white; cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                    <i class="fas fa-download"></i> Export CSV
                </button>
            </div>

            <!-- Stats Summary -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                {% if latest_snapshots.subdomains %}
                {% set all_subdomains = latest_snapshots.subdomains.data.subdomains %}
                {% set dns_resolved = namespace(count=0) %}
                {% set http_probed = namespace(count=0) %}
                {% if latest_snapshots.dns %}
                    {% for subdomain in all_subdomains %}
                        {% set dns_rec = latest_snapshots.dns.data.dns_records.get(subdomain) %}
                        {% if dns_rec and dns_rec.has_resolution %}
                            {% set dns_resolved.count = dns_resolved.count + 1 %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
                {% if latest_snapshots.http %}
                    {% set http_probed.count = latest_snapshots.http.data.http_records|length %}
                {% endif %}

                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem; border-radius: 12px; color: white;">
                    <div style="font-size: 2rem; font-weight: bold;">{{ all_subdomains|length }}</div>
                    <div style="font-size: 0.875rem; opacity: 0.9;">Total Subdomains</div>
                </div>

                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 1rem; border-radius: 12px; color: white;">
                    <div style="font-size: 2rem; font-weight: bold;">{{ dns_resolved.count }}</div>
                    <div style="font-size: 0.875rem; opacity: 0.9;">DNS Resolved</div>
                </div>

                <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); padding: 1rem; border-radius: 12px; color: white;">
                    <div style="font-size: 2rem; font-weight: bold;">{{ http_probed.count }}</div>
                    <div style="font-size: 0.875rem; opacity: 0.9;">HTTP Probed</div>
                </div>

                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); padding: 1rem; border-radius: 12px; color: white;">
                    <div style="font-size: 2rem; font-weight: bold;">{{ all_subdomains|length - dns_resolved.count }}</div>
                    <div style="font-size: 0.875rem; opacity: 0.9;">Unresolved</div>
                </div>
                {% endif %}
            </div>

            <!-- Assets Table -->
            <div class="table-responsive" style="background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;">
                <table class="table" id="assetsTable" style="margin: 0; width: 100%;">
                    <thead style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                        <tr>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">#</th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">Screenshot</th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">URL</th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">Status</th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">Title</th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">Technologies</th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">A Record</th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">CNAME</th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">CDN/WAF</th>
                        </tr>
                    </thead>
                    <tbody id="assetsTableBody">
                        {% if latest_snapshots.subdomains %}
                        {% for subdomain in latest_snapshots.subdomains.data.subdomains|sort %}
                        {% set dns_record = latest_snapshots.dns.data.dns_records.get(subdomain) if latest_snapshots.dns else none %}
                        {% set http_url_https = 'https://' + subdomain %}
                        {% set http_url_http = 'http://' + subdomain %}
                        {% set http_record = latest_snapshots.http.data.http_records.get(http_url_https) if latest_snapshots.http else none %}
                        {% if not http_record %}
                            {% set http_record = latest_snapshots.http.data.http_records.get(http_url_http) if latest_snapshots.http else none %}
                            {% set http_url_https = http_url_http if http_record else http_url_https %}
                        {% endif %}
                        <tr class="asset-row" style="border-bottom: 1px solid #f1f5f9; transition: background 0.2s;"
                            onmouseover="this.style.background='#f8fafc'"
                            onmouseout="this.style.background='white'"
                            data-url="{{ http_url_https }}"
                            data-subdomain="{{ subdomain }}"
                            data-status="{{ http_record.status_code if http_record else '' }}"
                            data-title="{{ http_record.title if http_record else '' }}"
                            data-ip="{{ http_record.ip if http_record else (dns_record.a[0] if dns_record and dns_record.a else '') }}"
                            data-technologies="{{ http_record.technologies|join(',') if http_record and http_record.technologies else '' }}"
                            data-cname="{{ dns_record.cname|join(',') if dns_record and dns_record.cname else '' }}">
                            <td style="padding: 1rem; color: #64748b; font-size: 0.875rem;">{{ loop.index }}</td>
                            <!-- Screenshot -->
                            <td style="padding: 1rem;">
                                {% if http_record and http_record.screenshot %}
                                <img src="data:image/png;base64,{{ http_record.screenshot }}"
                                     alt="Screenshot"
                                     style="width: 120px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #e2e8f0; cursor: pointer;"
                                     onclick="showScreenshotModal('{{ http_url_https }}', this.src)"
                                     title="Click to enlarge">
                                {% else %}
                                <div style="width: 120px; height: 80px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: #94a3b8;">
                                    <i class="fas fa-image" style="font-size: 1.5rem;"></i>
                                </div>
                                {% endif %}
                            </td>
                            <!-- URL -->
                            <td style="padding: 1rem;">
                                <a href="{{ http_url_https }}" target="_blank"
                                   style="color: #667eea; text-decoration: none; font-weight: 500; font-size: 0.875rem; word-break: break-all; display: inline-flex; align-items: center; gap: 0.25rem;"
                                   onmouseover="this.style.textDecoration='underline'"
                                   onmouseout="this.style.textDecoration='none'">
                                    {{ subdomain }}
                                    <i class="fas fa-external-link-alt" style="font-size: 0.75rem; opacity: 0.6;"></i>
                                </a>
                            </td>
                            <!-- HTTP Status -->
                            <td style="padding: 1rem;">
                                {% if http_record and http_record.status_code %}
                                {% if http_record.status_code < 300 %}
                                <span style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8125rem; font-weight: 600; background: #dcfce7; color: #166534;">
                                    {{ http_record.status_code }}
                                </span>
                                {% elif http_record.status_code < 400 %}
                                <span style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8125rem; font-weight: 600; background: #fef3c7; color: #92400e;">
                                    {{ http_record.status_code }}
                                </span>
                                {% else %}
                                <span style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8125rem; font-weight: 600; background: #fee2e2; color: #991b1b;">
                                    {{ http_record.status_code }}
                                </span>
                                {% endif %}
                                {% else %}
                                <span style="color: #94a3b8;">-</span>
                                {% endif %}
                            </td>
                            <!-- Title -->
                            <td style="padding: 1rem; max-width: 250px;">
                                {% if http_record and http_record.title %}
                                <span style="color: #334155; font-size: 0.875rem; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                                      title="{{ http_record.title }}">
                                    {{ http_record.title }}
                                </span>
                                {% else %}
                                <span style="color: #94a3b8;">-</span>
                                {% endif %}
                            </td>
                            <!-- Technologies -->
                            <td style="padding: 1rem;">
                                {% if http_record and http_record.technologies %}
                                <div style="display: flex; flex-wrap: wrap; gap: 0.375rem; max-width: 200px;">
                                    {% for tech in http_record.technologies[:3] %}
                                    <span style="padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; font-weight: 500; background: #e0e7ff; color: #3730a3;">
                                        {{ tech }}
                                    </span>
                                    {% endfor %}
                                    {% if http_record.technologies|length > 3 %}
                                    <span style="padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; font-weight: 500; background: #f1f5f9; color: #475569;">
                                        +{{ http_record.technologies|length - 3 }}
                                    </span>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span style="color: #94a3b8;">-</span>
                                {% endif %}
                            </td>
                            <!-- A Record -->
                            <td style="padding: 1rem;">
                                {% if dns_record and dns_record.a %}
                                <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                    {% for ip in dns_record.a[:2] %}
                                    <code style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; background: #f8fafc; color: #475569; font-family: 'Courier New', monospace;">
                                        {{ ip }}
                                    </code>
                                    {% endfor %}
                                    {% if dns_record.a|length > 2 %}
                                    <span style="padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; background: #f1f5f9; color: #475569;">
                                        +{{ dns_record.a|length - 2 }}
                                    </span>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span style="color: #94a3b8;">-</span>
                                {% endif %}
                            </td>
                            <!-- CNAME -->
                            <td style="padding: 1rem; max-width: 200px;">
                                {% if dns_record and dns_record.cname %}
                                <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                    {% for cname in dns_record.cname[:1] %}
                                    <span style="color: #64748b; font-size: 0.75rem; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                                          title="{{ cname }}">
                                        {{ cname }}
                                    </span>
                                    {% endfor %}
                                    {% if dns_record.cname|length > 1 %}
                                    <span style="padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; background: #f1f5f9; color: #475569;">
                                        +{{ dns_record.cname|length - 1 }}
                                    </span>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span style="color: #94a3b8;">-</span>
                                {% endif %}
                            </td>
                            <!-- CDN/WAF -->
                            <td style="padding: 1rem;">
                                {% if http_record and http_record.cdn %}
                                <span style="padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; font-weight: 500; background: #dbeafe; color: #1e40af;">
                                    <i class="fas fa-cloud"></i> {{ http_record.cdn if http_record.cdn != true else 'CDN' }}
                                </span>
                                {% else %}
                                <span style="color: #94a3b8;">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="9" style="padding: 3rem; text-align: center;">
                                <div style="color: #94a3b8;">
                                    <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                    <h3 style="color: #64748b; font-size: 1.125rem; margin-bottom: 0.5rem;">No Subdomains Found</h3>
                                    <p style="color: #94a3b8; font-size: 0.875rem;">Run a scan to discover subdomains and assets</p>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <!-- Stats -->
                <div style="padding: 1rem; background: #f8fafc; border-radius: 8px; color: #64748b; font-size: 0.875rem; flex: 1; min-width: 200px;">
                    Showing <span id="assetsVisibleRows" style="font-weight: 600; color: #475569;">0</span> of <span id="assetsTotalRows" style="font-weight: 600; color: #475569;">0</span> assets
                    <span style="margin-left: 0.5rem;">‚Ä¢</span>
                    <small style="color: #94a3b8; margin-left: 0.5rem;">Last scan: {{ latest_snapshots.subdomains.created_at.strftime('%Y-%m-%d %H:%M') if latest_snapshots.subdomains else 'Never' }}</small>
                </div>

                <!-- Per Page Selector -->
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <label style="font-size: 0.875rem; color: #64748b;">Per page:</label>
                    <select id="assetsPerPage" onchange="updateAssetsPagination(1)"
                            style="padding: 0.5rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; background: white; cursor: pointer;">
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                        <option value="9999">All</option>
                    </select>
                </div>

                <!-- Pagination Buttons -->
                <div id="assetsPaginationControls" style="display: flex; gap: 0.5rem; align-items: center;"></div>
            </div>
        </div>
    </div>

    <!-- Screenshot Modal -->
    <div id="screenshotModal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); padding: 2rem;" onclick="this.style.display='none'">
        <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
            <button onclick="document.getElementById('screenshotModal').style.display='none'"
                    style="position: absolute; top: 1rem; right: 1rem; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.25rem; color: #1e293b;">
                √ó
            </button>
            <div style="max-width: 90%; max-height: 90%; overflow: auto; background: white; border-radius: 12px; padding: 1rem;">
                <h3 id="modalTitle" style="margin-bottom: 1rem; color: #1e293b; font-size: 1.125rem; word-break: break-all;"></h3>
                <img id="modalImage" src="" alt="Screenshot" style="width: 100%; height: auto; border-radius: 8px;">
            </div>
        </div>
    </div>

    <!-- Tab: Takeovers -->
    <div id="tab-takeovers" class="tab-content">
        <div class="section">
            <h3>‚ö†Ô∏è Potential Subdomain Takeovers</h3>

            {% if latest_snapshots.dns and latest_snapshots.dns.scan_metadata and latest_snapshots.dns.scan_metadata.takeover_findings %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Subdomain</th>
                            <th>CNAME</th>
                            <th>Service</th>
                            <th>Reason</th>
                            <th>Severity</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for finding in latest_snapshots.dns.scan_metadata.takeover_findings %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td><code>{{ finding.subdomain }}</code></td>
                            <td><code>{{ finding.cname }}</code></td>
                            <td><span class="badge badge-danger">{{ finding.service }}</span></td>
                            <td><code>{{ finding.reason }}</code></td>
                            <td><span class="badge badge-{{ finding.severity }}">{{ finding.severity }}</span></td>
                            <td>{{ finding.description if finding.description else '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-shield-alt"></i>
                <h3>No Takeover Vulnerabilities</h3>
                <p>No potential subdomain takeovers detected</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Tab: Endpoints -->
    <div id="tab-endpoints" class="tab-content">
        <div class="section">
            {% if latest_snapshots.endpoints %}
            <h3>Discovered Endpoints</h3>

            <!-- Endpoint Filters -->
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                    <div style="flex: 1; min-width: 250px;">
                        <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">
                            <i class="fas fa-search"></i> Search URL
                        </label>
                        <input type="text" id="endpointSearch" placeholder="Search endpoints..."
                               onkeyup="filterEndpoints()"
                               style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.875rem;">
                    </div>

                    <div style="min-width: 180px;">
                        <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">
                            <i class="fas fa-filter"></i> Category
                        </label>
                        <select id="endpointTypeFilter" onchange="filterEndpoints()"
                                style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.875rem;">
                            <option value="">All Categories</option>
                            <option value="sensitive">üî• Sensitive (All)</option>
                            <option value="backup">üì¶ Backup Files</option>
                            <option value="dev">üõ†Ô∏è Dev/Admin</option>
                            <option value="file">üìÑ Documents</option>
                            <option value="config">‚öôÔ∏è Config Files</option>
                            <option value="auth">üîê Auth</option>
                            <option value="api">üîå API</option>
                            <option value="other">üìÅ Other</option>
                        </select>
                    </div>

                    <div style="min-width: 150px;">
                        <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">
                            <i class="fas fa-signal"></i> Status Code
                        </label>
                        <select id="endpointStatusFilter" onchange="filterEndpoints()"
                                style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.875rem;">
                            <option value="">All Status</option>
                            <option value="200">‚úÖ 200 OK</option>
                            <option value="300">‚Ü™Ô∏è 3xx Redirect</option>
                            <option value="400">‚ö†Ô∏è 4xx Error</option>
                            <option value="500">‚ùå 5xx Error</option>
                            <option value="none">‚ö™ No Data</option>
                        </select>
                    </div>

                    <div style="min-width: 120px;">
                        <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">
                            <i class="fas fa-list"></i> Per Page
                        </label>
                        <select id="endpointPageSize" onchange="updateEndpointPagination()"
                                style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.875rem;">
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="250">250</option>
                            <option value="all">All</option>
                        </select>
                    </div>

                    <div style="padding-top: 1.25rem;">
                        <button onclick="resetEndpointFilters()"
                                style="padding: 0.5rem 1rem; background: #64748b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>

                <!-- Filter Stats -->
                <div id="endpointFilterStats" style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e2e8f0; font-size: 0.875rem; color: #64748b;">
                    <span id="endpointVisibleCount">0</span> of <span id="endpointTotalCount">0</span> endpoints
                </div>
            </div>

            <div class="table-responsive">
                <table class="table" id="endpointTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th style="width: 60px;">Status</th>
                            <th style="width: 120px;">Categories</th>
                            <th>URL</th>
                            <th style="width: 200px;">Title</th>
                        </tr>
                    </thead>
                    <tbody id="endpointTableBody">
                        {% set enriched_urls = latest_snapshots.endpoints.data.get('enriched_urls', []) %}
                        {% if enriched_urls %}
                            {% for endpoint_data in enriched_urls %}
                                {% set url = endpoint_data.url %}
                                {% if url not in latest_snapshots.endpoints.data.js_files %}
                                {% set status_code = endpoint_data.get('status_code') %}
                                {% set title = endpoint_data.get('title', '') %}
                                {% set categories = endpoint_data.get('categories', []) %}
                                {% set is_sensitive = endpoint_data.get('is_sensitive', false) %}

                                {% set category_names = [] %}
                                {% for cat in categories %}
                                    {% set _ = category_names.append(cat.name) %}
                                {% endfor %}

                                <tr data-type="{{ 'sensitive' if is_sensitive else 'other' }}"
                                    data-categories="{{ category_names|join(',') }}"
                                    data-status="{{ status_code if status_code else '' }}">
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        {% if status_code %}
                                            {% if status_code == 200 %}
                                                <span class="badge badge-success" style="font-size: 0.75rem;">{{ status_code }}</span>
                                            {% elif status_code >= 300 and status_code < 400 %}
                                                <span class="badge badge-info" style="font-size: 0.75rem;">{{ status_code }}</span>
                                            {% elif status_code >= 400 and status_code < 500 %}
                                                <span class="badge badge-warning" style="font-size: 0.75rem;">{{ status_code }}</span>
                                            {% elif status_code >= 500 %}
                                                <span class="badge badge-danger" style="font-size: 0.75rem;">{{ status_code }}</span>
                                            {% else %}
                                                <span class="badge badge-secondary" style="font-size: 0.75rem;">{{ status_code }}</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge badge-secondary" style="font-size: 0.75rem;">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if categories %}
                                            {% for cat in categories %}
                                                <span class="badge" style="background-color: {{ cat.color }}; color: white; font-size: 0.7rem; margin: 1px;" title="{{ cat.description }}">
                                                    <i class="fas {{ cat.icon }}"></i> {{ cat.name }}
                                                </span>
                                            {% endfor %}
                                        {% else %}
                                            <span style="color: #aaa;">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url }}" target="_blank" style="font-family: monospace; font-size: 0.85rem; word-break: break-all;">
                                            {{ url }}
                                        </a>
                                    </td>
                                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ title }}">
                                        {{ title if title else '-' }}
                                    </td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <!-- Fallback to old format if enriched_urls not available -->
                            {% for url in latest_snapshots.endpoints.data.urls %}
                            {% if url not in latest_snapshots.endpoints.data.js_files %}
                            <tr data-type="other">
                                <td>{{ loop.index }}</td>
                                <td><span class="badge badge-secondary" style="font-size: 0.75rem;">-</span></td>
                                <td><span style="color: #aaa;">-</span></td>
                                <td><a href="{{ url }}" target="_blank"><code>{{ url }}</code></a></td>
                                <td>-</td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div id="endpointPagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                <div style="color: #64748b; font-size: 0.875rem;">
                    Showing <span id="endpointShowingStart">0</span> - <span id="endpointShowingEnd">0</span> of <span id="endpointShowingTotal">0</span> endpoints
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button id="endpointPrevBtn" onclick="changeEndpointPage(-1)"
                            style="padding: 0.5rem 1rem; background: white; border: 1px solid #cbd5e1; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <span id="endpointPageInfo" style="color: #64748b; font-size: 0.875rem; min-width: 100px; text-align: center;">
                        Page 1 of 1
                    </span>
                    <button id="endpointNextBtn" onclick="changeEndpointPage(1)"
                            style="padding: 0.5rem 1rem; background: white; border: 1px solid #cbd5e1; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <div style="margin-top: 1rem; color: #64748b; font-size: 0.875rem;">
                <i class="fas fa-info-circle"></i>
                JavaScript files are displayed in the <strong>JS Files</strong> tab for better organization and secret detection.
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-link"></i>
                <h3>No Endpoint Data</h3>
                <p>Run a weekly scan to discover endpoints</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Tab: JS Files -->
    <div id="tab-jsfiles" class="tab-content">
        <div class="section">
            {% if latest_snapshots.endpoints and latest_snapshots.endpoints.data.js_files %}
            <h3>JavaScript Files</h3>

            <!-- JS Files Filters -->
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                    <div style="flex: 1; min-width: 250px;">
                        <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">
                            <i class="fas fa-search"></i> Search File
                        </label>
                        <input type="text" id="jsFileSearch" placeholder="Search JS files..."
                               onkeyup="filterJSFiles()"
                               style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.875rem;">
                    </div>

                    <div style="min-width: 150px;">
                        <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">
                            <i class="fas fa-power-off"></i> Status
                        </label>
                        <select id="jsFileStatusFilter" onchange="filterJSFiles()"
                                style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.875rem;">
                            <option value="">All Status</option>
                            <option value="active">‚úÖ Active</option>
                            <option value="inactive">‚ùå Inactive</option>
                            <option value="unknown">‚ö™ Unknown</option>
                        </select>
                    </div>

                    <div style="min-width: 180px;">
                        <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">
                            <i class="fas fa-key"></i> Secrets
                        </label>
                        <select id="jsFileSecretsFilter" onchange="filterJSFiles()"
                                style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.875rem;">
                            <option value="">All Files</option>
                            <option value="suspicious">üî• Has Secrets</option>
                            <option value="clean">‚úÖ Clean</option>
                        </select>
                    </div>

                    <div style="min-width: 120px;">
                        <label style="display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">
                            <i class="fas fa-list"></i> Per Page
                        </label>
                        <select id="jsFilePageSize" onchange="updateJSFilePagination()"
                                style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.875rem;">
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="250">250</option>
                            <option value="all">All</option>
                        </select>
                    </div>

                    <div style="padding-top: 1.25rem;">
                        <button onclick="resetJSFileFilters()"
                                style="padding: 0.5rem 1rem; background: #64748b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>

                <!-- Filter Stats -->
                <div id="jsFileFilterStats" style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e2e8f0; font-size: 0.875rem; color: #64748b;">
                    <span id="jsFileVisibleCount">0</span> of <span id="jsFileTotalCount">0</span> JS files
                    <span id="jsFileSecretsCount" style="margin-left: 1rem; color: #dc3545;"></span>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table" id="jsFileTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Status</th>
                            <th>URL</th>
                            <th>Secrets</th>
                            <th>Last Scanned</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="jsFileTableBody">
                        {% for js_file in latest_snapshots.endpoints.data.js_files %}
                        {% set analysis = latest_snapshots.endpoints.data.js_file_analysis.get(js_file, {}) if latest_snapshots.endpoints.data.js_file_analysis else {} %}
                        {% set is_active = analysis.get('status', 'unknown') == 'active' %}
                        {% set secrets_info = analysis.get('secrets', {}) %}
                        {% set risk_level = secrets_info.get('risk_level', 'unknown') %}
                        {% set has_secrets = secrets_info.get('has_secrets', False) %}

                        <tr data-status="{{ 'active' if is_active else 'inactive' }}"
                            data-secrets="{{ 'suspicious' if has_secrets else 'clean' }}"
                            data-secrets-info='{{ secrets_info|tojson|safe if secrets_info else "{}"|safe }}'>
                            <td>{{ loop.index }}</td>
                            <td>
                                {% if is_active %}
                                <span class="badge badge-success" title="File is accessible (HTTP 200)">
                                    <i class="fas fa-check-circle"></i> Active
                                </span>
                                {% elif analysis %}
                                <span class="badge badge-danger" title="File is not accessible (HTTP {{ analysis.get('status_code', '?') }})">
                                    <i class="fas fa-times-circle"></i> Inactive
                                </span>
                                {% else %}
                                <span class="badge badge-secondary" title="Not yet analyzed">
                                    <i class="fas fa-question-circle"></i> Unknown
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ js_file }}" target="_blank" style="font-family: monospace; font-size: 0.85rem; word-break: break-all;">
                                    {{ js_file }}
                                </a>
                            </td>
                            <td>
                                {% if has_secrets %}
                                    {% if risk_level == 'high' %}
                                    <span class="badge badge-danger" title="Secrets detected in file content">
                                        <i class="fas fa-skull-crossbones"></i> High Risk
                                    </span>
                                    {% elif risk_level == 'medium' %}
                                    <span class="badge badge-warning" title="Suspicious keywords found">
                                        <i class="fas fa-exclamation-triangle"></i> Medium Risk
                                    </span>
                                    {% else %}
                                    <span class="badge badge-warning" title="Potential secrets detected">
                                        <i class="fas fa-exclamation-circle"></i> Low Risk
                                    </span>
                                    {% endif %}
                                {% elif analysis %}
                                <span class="badge badge-success" title="No secrets detected">
                                    <i class="fas fa-shield-check"></i> Clean
                                </span>
                                {% else %}
                                <span class="badge badge-secondary" title="Not yet analyzed">
                                    <i class="fas fa-question"></i> Unknown
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <span style="font-size: 0.85rem; color: #64748b;">
                                    {{ latest_snapshots.endpoints.created_at.strftime('%Y-%m-%d %H:%M') }}
                                </span>
                            </td>
                            <td>
                                {% if has_secrets %}
                                <button class="btn btn-sm btn-danger" onclick="showSecretDetails(this)" title="View secret findings">
                                    <i class="fas fa-key"></i> Details
                                </button>
                                {% endif %}
                                <button class="btn btn-sm btn-primary" onclick="analyzeJSFile('{{ js_file }}')" title="Analyze this JS file">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('{{ js_file }}')" title="Copy URL">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div id="jsFilePagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                <div style="color: #64748b; font-size: 0.875rem;">
                    Showing <span id="jsFileShowingStart">0</span> - <span id="jsFileShowingEnd">0</span> of <span id="jsFileShowingTotal">0</span> files
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button id="jsFilePrevBtn" onclick="changeJSFilePage(-1)"
                            style="padding: 0.5rem 1rem; background: white; border: 1px solid #cbd5e1; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <span id="jsFilePageInfo" style="color: #64748b; font-size: 0.875rem; min-width: 100px; text-align: center;">
                        Page 1 of 1
                    </span>
                    <button id="jsFileNextBtn" onclick="changeJSFilePage(1)"
                            style="padding: 0.5rem 1rem; background: white; border: 1px solid #cbd5e1; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <div style="margin-top: 1rem; color: #64748b; font-size: 0.875rem;">
                <i class="fas fa-info-circle"></i>
                <strong>Status</strong> indicates if file is accessible (HTTP 200 check).
                <strong>Secrets</strong> shows risk level based on pattern matching.
                High Risk files should be reviewed immediately.
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-file-code"></i>
                <h3>No JavaScript Files</h3>
                <p>Run a weekly scan to discover JavaScript files</p>
                <button class="btn btn-primary" onclick="triggerScan({{ project.id }}, 'weekly')">
                    <i class="fas fa-calendar-week"></i> Run Weekly Scan
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Tab: Events -->
    <div id="tab-events" class="tab-content">
        <div class="section">
            <h3>Recent Events (Last 7 Days)</h3>
            {% if recent_events %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Severity</th>
                            <th>Type</th>
                            <th>Summary</th>
                            <th>Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in recent_events %}
                        <tr>
                            <td>
                                <span class="badge badge-{{ event.severity.value }}">
                                    {{ event.severity.value }}
                                </span>
                            </td>
                            <td><code>{{ event.type.value }}</code></td>
                            <td>{{ event.summary }}</td>
                            <td>{{ event.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                {% if event.details %}
                                <button class="btn btn-sm btn-primary" onclick="showEventDetail({{ event.id }})">
                                    <i class="fas fa-info-circle"></i> Detail
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        <tr id="event-detail-{{ event.id }}" style="display: none;">
                            <td colspan="5">
                                <div class="event-detail-box">
                                    <h4><i class="fas fa-info-circle"></i> Event Details</h4>
                                    <div id="event-detail-content-{{ event.id }}">
                                        <!-- Detail will be loaded here -->
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-bell"></i>
                <h3>No Recent Events</h3>
                <p>No events in the last 7 days</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Tab: Scans -->
    <div id="tab-scans" class="tab-content">
        <div class="section">
            <h3>Scan History</h3>
            {% if recent_scans %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Mode</th>
                            <th>Status</th>
                            <th>Started</th>
                            <th>Completed</th>
                            <th>Events</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for scan in recent_scans %}
                        <tr>
                            <td><span class="badge badge-info">{{ scan.scan_mode }}</span></td>
                            <td>
                                <span class="badge badge-{{ 'success' if scan.status == 'completed' else 'warning' }}">
                                    {{ scan.status }}
                                </span>
                            </td>
                            <td>{{ scan.started_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                {% if scan.completed_at %}
                                    {{ scan.completed_at.strftime('%Y-%m-%d %H:%M') }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>{{ scan.events_generated or 0 }}</td>
                            <td>
                                {% if scan.completed_at and scan.started_at %}
                                    {{ ((scan.completed_at - scan.started_at).total_seconds() / 60) | round(1) }} min
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-history"></i>
                <h3>No Scan History</h3>
                <p>No scans have been run yet</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
.event-detail-box {
    background: #f8f9fa;
    border-left: 4px solid #007bff;
    padding: 1.5rem;
    margin: 1rem 0;
}

.event-detail-box h4 {
    margin-top: 0;
    color: #007bff;
}

.detail-comparison {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 1rem;
}

.detail-column {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 1rem;
}

.detail-column h5 {
    margin-top: 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #dee2e6;
}

.detail-column.old-value h5 {
    color: #dc3545;
}

.detail-column.new-value h5 {
    color: #28a745;
}

.detail-list {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0;
}

.detail-list li {
    padding: 0.25rem 0;
    font-family: monospace;
}

.detail-added {
    color: #28a745;
    font-weight: bold;
}

.detail-removed {
    color: #dc3545;
    font-weight: bold;
}

.detail-info {
    background: #e7f3ff;
    padding: 0.75rem;
    border-radius: 4px;
    margin-top: 1rem;
}

.detail-info strong {
    color: #0056b3;
}
</style>

<script>
// Event detail display
function showEventDetail(eventId) {
    const detailRow = document.getElementById(`event-detail-${eventId}`);
    const contentDiv = document.getElementById(`event-detail-content-${eventId}`);

    // Toggle visibility
    if (detailRow.style.display === 'none') {
        // Load event details via API
        fetch(`/api/events/${eventId}`)
            .then(res => res.json())
            .then(event => {
                contentDiv.innerHTML = formatEventDetails(event);
                detailRow.style.display = 'table-row';
            })
            .catch(err => {
                contentDiv.innerHTML = '<p class="text-danger">Failed to load event details</p>';
                detailRow.style.display = 'table-row';
            });
    } else {
        detailRow.style.display = 'none';
    }
}

function formatEventDetails(event) {
    if (!event.details) {
        return '<p>No additional details available</p>';
    }

    const details = event.details;
    let html = '';

    // DNS A Record Changes
    if (details.change_type === 'a_record') {
        html += '<div class="detail-comparison">';

        // Old IPs
        html += '<div class="detail-column old-value">';
        html += '<h5><i class="fas fa-clock"></i> Previous A Records</h5>';
        if (details.old_ips && details.old_ips.length > 0) {
            html += '<ul class="detail-list">';
            details.old_ips.forEach(ip => {
                html += `<li><code>${ip}</code></li>`;
            });
            html += '</ul>';
        } else {
            html += '<p class="text-muted">No records</p>';
        }
        html += '</div>';

        // New IPs
        html += '<div class="detail-column new-value">';
        html += '<h5><i class="fas fa-check-circle"></i> Current A Records</h5>';
        if (details.new_ips && details.new_ips.length > 0) {
            html += '<ul class="detail-list">';
            details.new_ips.forEach(ip => {
                html += `<li><code>${ip}</code></li>`;
            });
            html += '</ul>';
        } else {
            html += '<p class="text-muted">No records</p>';
        }
        html += '</div>';

        html += '</div>';

        // Summary of changes
        html += '<div class="detail-info">';
        if (details.added_ips && details.added_ips.length > 0) {
            html += '<p class="detail-added"><i class="fas fa-plus-circle"></i> Added IPs: ' + details.added_ips.join(', ') + '</p>';
        }
        if (details.removed_ips && details.removed_ips.length > 0) {
            html += '<p class="detail-removed"><i class="fas fa-minus-circle"></i> Removed IPs: ' + details.removed_ips.join(', ') + '</p>';
        }
        html += '</div>';
    }

    // DNS CNAME Changes
    else if (details.change_type === 'cname') {
        html += '<div class="detail-comparison">';

        // Old CNAMEs
        html += '<div class="detail-column old-value">';
        html += '<h5><i class="fas fa-clock"></i> Previous CNAME Records</h5>';
        if (details.old_cnames && details.old_cnames.length > 0) {
            html += '<ul class="detail-list">';
            details.old_cnames.forEach(cname => {
                html += `<li><code>${cname}</code></li>`;
            });
            html += '</ul>';
        } else {
            html += '<p class="text-muted">No records</p>';
        }
        html += '</div>';

        // New CNAMEs
        html += '<div class="detail-column new-value">';
        html += '<h5><i class="fas fa-check-circle"></i> Current CNAME Records</h5>';
        if (details.new_cnames && details.new_cnames.length > 0) {
            html += '<ul class="detail-list">';
            details.new_cnames.forEach(cname => {
                html += `<li><code>${cname}</code></li>`;
            });
            html += '</ul>';
        } else {
            html += '<p class="text-muted">No records</p>';
        }
        html += '</div>';

        html += '</div>';

        // Summary of changes
        html += '<div class="detail-info">';
        if (details.added_cnames && details.added_cnames.length > 0) {
            html += '<p class="detail-added"><i class="fas fa-plus-circle"></i> Added CNAMEs: ' + details.added_cnames.join(', ') + '</p>';
        }
        if (details.removed_cnames && details.removed_cnames.length > 0) {
            html += '<p class="detail-removed"><i class="fas fa-minus-circle"></i> Removed CNAMEs: ' + details.removed_cnames.join(', ') + '</p>';
        }
        html += '</div>';
    }

    // HTTP Status Changes
    else if (details.old_status !== undefined && details.new_status !== undefined) {
        html += '<div class="detail-comparison">';

        html += '<div class="detail-column old-value">';
        html += '<h5><i class="fas fa-clock"></i> Previous Status</h5>';
        html += `<p><code>${details.old_status}</code></p>`;
        html += '</div>';

        html += '<div class="detail-column new-value">';
        html += '<h5><i class="fas fa-check-circle"></i> Current Status</h5>';
        html += `<p><code>${details.new_status}</code></p>`;
        html += '</div>';

        html += '</div>';
    }

    // HTTP Title Changes
    else if (details.old_title !== undefined && details.new_title !== undefined) {
        html += '<div class="detail-comparison">';

        html += '<div class="detail-column old-value">';
        html += '<h5><i class="fas fa-clock"></i> Previous Title</h5>';
        html += `<p>${details.old_title || '(empty)'}</p>`;
        html += '</div>';

        html += '<div class="detail-column new-value">';
        html += '<h5><i class="fas fa-check-circle"></i> Current Title</h5>';
        html += `<p>${details.new_title || '(empty)'}</p>`;
        html += '</div>';

        html += '</div>';
    }

    // New Port Detected (Shodan) - has hostnames field
    else if (details.port !== undefined && details.ip && details.hostnames !== undefined) {
        html += '<div class="detail-info">';
        html += '<h5><i class="fas fa-network-wired"></i> New Port Discovered</h5>';
        html += `<p><strong>IP Address:</strong> <code>${details.ip}</code></p>`;
        html += `<p><strong>Port:</strong> <code>${details.port}</code></p>`;

        if (details.subdomains && details.subdomains.length > 0) {
            html += `<p><strong>Related Subdomains:</strong></p>`;
            html += '<ul class="detail-list">';
            details.subdomains.forEach(subdomain => {
                html += `<li><code>${subdomain}</code></li>`;
            });
            html += '</ul>';
        }

        if (details.hostnames && details.hostnames.length > 0) {
            html += `<p><strong>Shodan Hostnames:</strong> ${details.hostnames.map(h => `<code>${h}</code>`).join(', ')}</p>`;
        }
        html += '</div>';
    }

    // Port Removed (Shodan) - no hostnames field
    else if (details.port !== undefined && details.ip && details.hostnames === undefined && !details.cve) {
        html += '<div class="detail-info" style="border-left: 4px solid #6c757d;">';
        html += '<h5 style="color: #6c757d;"><i class="fas fa-times-circle"></i> Port Closed</h5>';
        html += `<p><strong>IP Address:</strong> <code>${details.ip}</code></p>`;
        html += `<p><strong>Port:</strong> <code>${details.port}</code></p>`;

        if (details.subdomains && details.subdomains.length > 0) {
            html += `<p><strong>Related Subdomains:</strong></p>`;
            html += '<ul class="detail-list">';
            details.subdomains.forEach(subdomain => {
                html += `<li><code>${subdomain}</code></li>`;
            });
            html += '</ul>';
        }
        html += '</div>';
    }

    // Vulnerability Found (Shodan)
    else if (details.cve !== undefined && details.ip) {
        html += '<div class="detail-info" style="border-left: 4px solid #dc3545;">';
        html += '<h5 style="color: #dc3545;"><i class="fas fa-bug"></i> Vulnerability Details</h5>';
        html += `<p><strong>CVE ID:</strong> <code>${details.cve}</code></p>`;
        html += `<p><strong>IP Address:</strong> <code>${details.ip}</code></p>`;

        if (details.subdomains && details.subdomains.length > 0) {
            html += `<p><strong>Affected Subdomains:</strong></p>`;
            html += '<ul class="detail-list">';
            details.subdomains.forEach(subdomain => {
                html += `<li><code>${subdomain}</code></li>`;
            });
            html += '</ul>';
        }

        if (details.hostnames && details.hostnames.length > 0) {
            html += `<p><strong>Shodan Hostnames:</strong> ${details.hostnames.map(h => `<code>${h}</code>`).join(', ')}</p>`;
        }

        html += `<p style="margin-top: 1rem;"><a href="https://nvd.nist.gov/vuln/detail/${details.cve}" target="_blank" class="btn btn-sm btn-danger">`;
        html += '<i class="fas fa-external-link-alt"></i> View on NVD</a></p>';
        html += '</div>';
    }

    // Generic details view
    else {
        html += '<div class="detail-info">';
        html += '<pre>' + JSON.stringify(details, null, 2) + '</pre>';
        html += '</div>';
    }

    // Show subdomain/URL if available
    if (details.subdomain || details.url) {
        html += '<div style="margin-top: 1rem;">';
        html += '<strong><i class="fas fa-globe"></i> Target:</strong> ';
        html += `<code>${details.subdomain || details.url}</code>`;
        html += '</div>';
    }

    return html;
}

// Tab switching
function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    document.getElementById('tab-' + tabName).classList.add('active');
    event.target.classList.add('active');
}

// Filter asset table
function filterTable() {
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const changeFilter = document.getElementById('changeFilter').value;
    const resolutionFilter = document.getElementById('resolutionFilter').value;

    const table = document.getElementById('assetTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    let visibleCount = 0;
    const totalCount = rows.length;

    for (let row of rows) {
        const cells = row.getElementsByTagName('td');
        if (cells.length === 0) continue;

        const subdomain = cells[1].textContent.toLowerCase();
        const url = cells[2].textContent.toLowerCase();
        const httpStatus = cells[3].textContent.trim();
        const ip = cells[7].textContent.toLowerCase();
        const cname = cells[9].textContent.toLowerCase();
        const dnsStatus = cells[10].textContent.toLowerCase();
        const changeStatus = cells[11].textContent.toLowerCase();

        let show = true;

        // Search filter
        if (searchInput && !subdomain.includes(searchInput) && !ip.includes(searchInput) && !cname.includes(searchInput)) {
            show = false;
        }

        // HTTP Status filter
        if (statusFilter) {
            if (statusFilter === 'none') {
                if (httpStatus !== '-') show = false;
            } else {
                if (!httpStatus.startsWith(statusFilter)) show = false;
            }
        }

        // Change filter
        if (changeFilter && !changeStatus.includes(changeFilter)) {
            show = false;
        }

        // Resolution filter
        if (resolutionFilter) {
            if (resolutionFilter === 'resolved' && !dnsStatus.includes('resolved')) {
                show = false;
            } else if (resolutionFilter === 'unresolved' && dnsStatus.includes('resolved')) {
                show = false;
            }
        }

        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    }

    document.getElementById('visibleRows').textContent = visibleCount;
    document.getElementById('totalRows').textContent = totalCount;
}

// Reset filters
function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('changeFilter').value = '';
    document.getElementById('resolutionFilter').value = '';
    filterTable();
}

// Export to CSV
function exportToCSV() {
    const table = document.getElementById('assetTable');
    const rows = table.querySelectorAll('tr');

    let csv = [];
    for (let row of rows) {
        const cells = row.querySelectorAll('th, td');
        const rowData = Array.from(cells).map(cell => {
            let text = cell.textContent.trim();
            text = text.replace(/"/g, '""'); // Escape quotes
            return `"${text}"`;
        });
        csv.push(rowData.join(','));
    }

    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'assets_export_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// ========== NEW ASSETS TAB FUNCTIONS ==========

// Assets pagination state
let assetsCurrentPage = 1;
let assetsFilteredRows = [];

// Filter assets in new table
function filterAssets() {
    const searchInput = document.getElementById('assetSearchInput').value.toLowerCase();
    const statusFilter = document.getElementById('assetStatusFilter').value;
    const techFilter = document.getElementById('assetTechFilter').value.toLowerCase();

    const rows = document.querySelectorAll('#assetsTableBody .asset-row');
    assetsFilteredRows = [];

    for (let row of rows) {
        const subdomain = row.getAttribute('data-subdomain').toLowerCase();
        const url = row.getAttribute('data-url').toLowerCase();
        const status = row.getAttribute('data-status');
        const title = row.getAttribute('data-title').toLowerCase();
        const ip = row.getAttribute('data-ip').toLowerCase();
        const technologies = row.getAttribute('data-technologies').toLowerCase();
        const cname = row.getAttribute('data-cname').toLowerCase();

        let show = true;

        // Search filter
        if (searchInput) {
            if (!subdomain.includes(searchInput) &&
                !url.includes(searchInput) &&
                !title.includes(searchInput) &&
                !ip.includes(searchInput) &&
                !cname.includes(searchInput) &&
                !technologies.includes(searchInput)) {
                show = false;
            }
        }

        // Status filter
        if (statusFilter && status) {
            if (!status.startsWith(statusFilter)) {
                show = false;
            }
        }

        // Technology filter
        if (techFilter && !technologies.includes(techFilter)) {
            show = false;
        }

        if (show) {
            assetsFilteredRows.push(row);
        }
    }

    // Reset to page 1 when filtering
    assetsCurrentPage = 1;
    updateAssetsPagination();
}

// Reset asset filters
function resetAssetFilters() {
    document.getElementById('assetSearchInput').value = '';
    document.getElementById('assetStatusFilter').value = '';
    document.getElementById('assetTechFilter').value = '';
    filterAssets();
}

// Export assets to CSV
function exportAssetsToCSV() {
    const table = document.getElementById('assetsTable');
    const rows = table.querySelectorAll('tr');

    let csv = [];
    for (let row of rows) {
        const cells = row.querySelectorAll('th, td');
        const rowData = Array.from(cells).map((cell, index) => {
            // Skip screenshot column (index 1)
            if (index === 1) return '';

            let text = cell.textContent.trim().replace(/\s+/g, ' ');
            text = text.replace(/"/g, '""');
            return `"${text}"`;
        }).filter(cell => cell !== '');
        csv.push(rowData.join(','));
    }

    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'http_assets_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Update assets pagination
function updateAssetsPagination(page) {
    if (page) {
        assetsCurrentPage = page;
    }

    const perPage = parseInt(document.getElementById('assetsPerPage').value);
    const totalRows = assetsFilteredRows.length;
    const totalPages = Math.ceil(totalRows / perPage);

    // Hide all rows first
    const allRows = document.querySelectorAll('#assetsTableBody .asset-row');
    allRows.forEach(row => row.style.display = 'none');

    // Show only rows for current page
    const start = (assetsCurrentPage - 1) * perPage;
    const end = Math.min(start + perPage, totalRows);

    for (let i = start; i < end; i++) {
        assetsFilteredRows[i].style.display = '';
    }

    // Update stats
    document.getElementById('assetsVisibleRows').textContent = Math.min(end - start, totalRows);
    document.getElementById('assetsTotalRows').textContent = totalRows;

    // Update pagination controls
    const controls = document.getElementById('assetsPaginationControls');
    controls.innerHTML = '';

    if (totalPages <= 1) return;

    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
    prevBtn.disabled = assetsCurrentPage === 1;
    prevBtn.onclick = () => updateAssetsPagination(assetsCurrentPage - 1);
    prevBtn.style.cssText = 'padding: 0.5rem 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-size: 0.875rem;';
    if (prevBtn.disabled) prevBtn.style.opacity = '0.5';
    controls.appendChild(prevBtn);

    // Page numbers
    const maxPages = 5;
    let startPage = Math.max(1, assetsCurrentPage - Math.floor(maxPages / 2));
    let endPage = Math.min(totalPages, startPage + maxPages - 1);

    if (endPage - startPage < maxPages - 1) {
        startPage = Math.max(1, endPage - maxPages + 1);
    }

    if (startPage > 1) {
        const firstBtn = document.createElement('button');
        firstBtn.textContent = '1';
        firstBtn.onclick = () => updateAssetsPagination(1);
        firstBtn.style.cssText = 'padding: 0.5rem 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-size: 0.875rem;';
        controls.appendChild(firstBtn);

        if (startPage > 2) {
            const dots = document.createElement('span');
            dots.textContent = '...';
            dots.style.cssText = 'padding: 0.5rem; color: #64748b;';
            controls.appendChild(dots);
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.onclick = () => updateAssetsPagination(i);
        btn.style.cssText = 'padding: 0.5rem 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-size: 0.875rem;';

        if (i === assetsCurrentPage) {
            btn.style.background = '#667eea';
            btn.style.color = 'white';
            btn.style.borderColor = '#667eea';
        } else {
            btn.style.background = 'white';
        }

        controls.appendChild(btn);
    }

    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            const dots = document.createElement('span');
            dots.textContent = '...';
            dots.style.cssText = 'padding: 0.5rem; color: #64748b;';
            controls.appendChild(dots);
        }

        const lastBtn = document.createElement('button');
        lastBtn.textContent = totalPages;
        lastBtn.onclick = () => updateAssetsPagination(totalPages);
        lastBtn.style.cssText = 'padding: 0.5rem 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-size: 0.875rem;';
        controls.appendChild(lastBtn);
    }

    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
    nextBtn.disabled = assetsCurrentPage === totalPages;
    nextBtn.onclick = () => updateAssetsPagination(assetsCurrentPage + 1);
    nextBtn.style.cssText = 'padding: 0.5rem 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-size: 0.875rem;';
    if (nextBtn.disabled) nextBtn.style.opacity = '0.5';
    controls.appendChild(nextBtn);
}

// Show screenshot modal
function showScreenshotModal(url, src) {
    const modal = document.getElementById('screenshotModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalImage = document.getElementById('modalImage');

    modalTitle.textContent = url;
    modalImage.src = src;
    modal.style.display = 'block';
}

// Initialize assets table on page load
document.addEventListener('DOMContentLoaded', function() {
    filterAssets();
});

// ========== END NEW ASSETS TAB FUNCTIONS ==========

// Endpoint Pagination State
let endpointCurrentPage = 1;
let endpointFilteredRows = [];

// Filter endpoints
function filterEndpoints() {
    const searchInput = document.getElementById('endpointSearch').value.toLowerCase();
    const typeFilter = document.getElementById('endpointTypeFilter').value;
    const statusFilter = document.getElementById('endpointStatusFilter').value;

    const rows = document.querySelectorAll('#endpointTableBody tr');
    endpointFilteredRows = [];
    let totalCount = 0;

    for (let row of rows) {
        totalCount++;
        const url = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
        const type = row.getAttribute('data-type');
        const categories = row.getAttribute('data-categories') || '';
        const status = row.getAttribute('data-status') || '';

        let show = true;

        // Search filter
        if (searchInput && !url.includes(searchInput)) {
            show = false;
        }

        // Type filter (includes category filtering)
        if (typeFilter) {
            if (typeFilter === 'sensitive') {
                if (type !== 'sensitive') show = false;
            } else if (typeFilter === 'api' || typeFilter === 'other') {
                if (type !== typeFilter) show = false;
            } else {
                // Category-specific filter (backup, dev, file, config, etc.)
                if (!categories.includes(typeFilter)) show = false;
            }
        }

        // Status filter
        if (statusFilter) {
            if (statusFilter === 'none') {
                if (status !== '') show = false;
            } else if (statusFilter === '200') {
                if (status !== '200') show = false;
            } else if (statusFilter === '300') {
                if (!status.startsWith('3')) show = false;
            } else if (statusFilter === '400') {
                if (!status.startsWith('4')) show = false;
            } else if (statusFilter === '500') {
                if (!status.startsWith('5')) show = false;
            }
        }

        if (show) {
            endpointFilteredRows.push(row);
        }
    }

    // Update stats
    document.getElementById('endpointVisibleCount').textContent = endpointFilteredRows.length;
    document.getElementById('endpointTotalCount').textContent = totalCount;

    // Reset to page 1 when filters change
    endpointCurrentPage = 1;
    updateEndpointPagination();
}

// Update endpoint pagination
function updateEndpointPagination() {
    const pageSize = document.getElementById('endpointPageSize').value;
    const totalRows = endpointFilteredRows.length;

    // Hide all rows first
    const allRows = document.querySelectorAll('#endpointTableBody tr');
    allRows.forEach(row => row.style.display = 'none');

    let displayRows = endpointFilteredRows;
    let totalPages = 1;
    let start = 0;
    let end = totalRows;

    if (pageSize !== 'all') {
        const size = parseInt(pageSize);
        totalPages = Math.ceil(totalRows / size);

        // Ensure current page is valid
        if (endpointCurrentPage > totalPages) endpointCurrentPage = totalPages;
        if (endpointCurrentPage < 1) endpointCurrentPage = 1;

        start = (endpointCurrentPage - 1) * size;
        end = Math.min(start + size, totalRows);
        displayRows = endpointFilteredRows.slice(start, end);
    }

    // Show paginated rows
    displayRows.forEach(row => row.style.display = '');

    // Update pagination info
    document.getElementById('endpointShowingStart').textContent = totalRows > 0 ? start + 1 : 0;
    document.getElementById('endpointShowingEnd').textContent = end;
    document.getElementById('endpointShowingTotal').textContent = totalRows;
    document.getElementById('endpointPageInfo').textContent = `Page ${endpointCurrentPage} of ${totalPages}`;

    // Update button states
    document.getElementById('endpointPrevBtn').disabled = endpointCurrentPage <= 1;
    document.getElementById('endpointNextBtn').disabled = endpointCurrentPage >= totalPages;
}

// Change endpoint page
function changeEndpointPage(delta) {
    endpointCurrentPage += delta;
    updateEndpointPagination();
}

// Reset endpoint filters
function resetEndpointFilters() {
    document.getElementById('endpointSearch').value = '';
    document.getElementById('endpointTypeFilter').value = '';
    document.getElementById('endpointStatusFilter').value = '';
    document.getElementById('endpointPageSize').value = '50';
    filterEndpoints();
}

// Initialize endpoint filters on page load
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('endpointTableBody')) {
        filterEndpoints();
    }
});

// JS Files Pagination State
let jsFileCurrentPage = 1;
let jsFileFilteredRows = [];

// Filter JS Files
function filterJSFiles() {
    const searchInput = document.getElementById('jsFileSearch').value.toLowerCase();
    const statusFilter = document.getElementById('jsFileStatusFilter').value;
    const secretsFilter = document.getElementById('jsFileSecretsFilter').value;

    const rows = document.querySelectorAll('#jsFileTableBody tr');
    jsFileFilteredRows = [];
    let totalCount = 0;
    let secretsCount = 0;

    for (let row of rows) {
        totalCount++;
        const url = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
        const status = row.getAttribute('data-status');
        const secrets = row.getAttribute('data-secrets');

        let show = true;

        if (searchInput && !url.includes(searchInput)) {
            show = false;
        }

        if (statusFilter && status !== statusFilter) {
            show = false;
        }

        if (secretsFilter && secrets !== secretsFilter) {
            show = false;
        }

        if (show) {
            jsFileFilteredRows.push(row);
            if (secrets === 'suspicious') secretsCount++;
        }
    }

    // Update stats
    document.getElementById('jsFileVisibleCount').textContent = jsFileFilteredRows.length;
    document.getElementById('jsFileTotalCount').textContent = totalCount;

    const secretsCountEl = document.getElementById('jsFileSecretsCount');
    if (secretsCount > 0) {
        secretsCountEl.innerHTML = `(<i class="fas fa-exclamation-triangle"></i> ${secretsCount} with secrets)`;
    } else {
        secretsCountEl.innerHTML = '';
    }

    // Reset to page 1 when filters change
    jsFileCurrentPage = 1;
    updateJSFilePagination();
}

// Update JS file pagination
function updateJSFilePagination() {
    const pageSize = document.getElementById('jsFilePageSize').value;
    const totalRows = jsFileFilteredRows.length;

    // Hide all rows first
    const allRows = document.querySelectorAll('#jsFileTableBody tr');
    allRows.forEach(row => row.style.display = 'none');

    let displayRows = jsFileFilteredRows;
    let totalPages = 1;
    let start = 0;
    let end = totalRows;

    if (pageSize !== 'all') {
        const size = parseInt(pageSize);
        totalPages = Math.ceil(totalRows / size);

        // Ensure current page is valid
        if (jsFileCurrentPage > totalPages) jsFileCurrentPage = totalPages;
        if (jsFileCurrentPage < 1) jsFileCurrentPage = 1;

        start = (jsFileCurrentPage - 1) * size;
        end = Math.min(start + size, totalRows);
        displayRows = jsFileFilteredRows.slice(start, end);
    }

    // Show paginated rows
    displayRows.forEach(row => row.style.display = '');

    // Update pagination info
    document.getElementById('jsFileShowingStart').textContent = totalRows > 0 ? start + 1 : 0;
    document.getElementById('jsFileShowingEnd').textContent = end;
    document.getElementById('jsFileShowingTotal').textContent = totalRows;
    document.getElementById('jsFilePageInfo').textContent = `Page ${jsFileCurrentPage} of ${totalPages}`;

    // Update button states
    document.getElementById('jsFilePrevBtn').disabled = jsFileCurrentPage <= 1;
    document.getElementById('jsFileNextBtn').disabled = jsFileCurrentPage >= totalPages;
}

// Change JS file page
function changeJSFilePage(delta) {
    jsFileCurrentPage += delta;
    updateJSFilePagination();
}

// Reset JS file filters
function resetJSFileFilters() {
    document.getElementById('jsFileSearch').value = '';
    document.getElementById('jsFileStatusFilter').value = '';
    document.getElementById('jsFileSecretsFilter').value = '';
    document.getElementById('jsFilePageSize').value = '50';
    filterJSFiles();
}

// Initialize JS file filters on page load
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('jsFileTableBody')) {
        filterJSFiles();
    }
});

// Analyze JS File
function analyzeJSFile(url) {
    showToast('Opening JS file analysis...', 'info');
    // You can integrate with a service like JSNice, or download and analyze locally
    window.open(url, '_blank');
}

// Copy to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('URL copied to clipboard!', 'success');
    }).catch(err => {
        showToast('Failed to copy URL', 'error');
        console.error('Copy failed:', err);
    });
}

// Show secret details
function showSecretDetails(button) {
    const row = button.closest('tr');
    const url = row.querySelector('td:nth-child(3) a').href;
    const secretsInfo = JSON.parse(row.getAttribute('data-secrets-info') || '{}');

    // Create modal to show secret findings
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;';

    const content = document.createElement('div');
    content.style.cssText = 'background: white; padding: 2rem; border-radius: 8px; max-width: 700px; max-height: 80vh; overflow-y: auto;';

    // Build secrets found section
    let secretsFoundHTML = '';
    if (secretsInfo.secrets_found && secretsInfo.secrets_found.length > 0) {
        secretsFoundHTML = '<h4 style="color: #dc3545; margin-top: 1rem;"><i class="fas fa-exclamation-triangle"></i> Secrets Detected</h4>';
        secretsFoundHTML += '<table class="table" style="margin-top: 0.5rem;">';
        secretsFoundHTML += '<thead><tr><th>Type</th><th>Count</th><th>Severity</th></tr></thead><tbody>';

        secretsInfo.secrets_found.forEach(secret => {
            let severity = 'HIGH';
            let severityColor = '#dc3545';

            if (secret.type.includes('generic') || secret.type.includes('authorization')) {
                severity = 'MEDIUM';
                severityColor = '#ffc107';
            }

            secretsFoundHTML += `
                <tr>
                    <td><code>${secret.type.replace(/_/g, ' ').toUpperCase()}</code></td>
                    <td><strong>${secret.count}</strong></td>
                    <td><span style="color: ${severityColor}; font-weight: bold;">${severity}</span></td>
                </tr>
            `;
        });

        secretsFoundHTML += '</tbody></table>';
    }

    // Build suspicious keywords section
    let keywordsHTML = '';
    if (secretsInfo.suspicious_keywords && secretsInfo.suspicious_keywords.length > 0) {
        keywordsHTML = '<h4 style="color: #ffc107; margin-top: 1rem;"><i class="fas fa-search"></i> Suspicious Keywords</h4>';
        keywordsHTML += '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">';

        secretsInfo.suspicious_keywords.forEach(keyword => {
            keywordsHTML += `<span class="badge badge-warning">${keyword}</span>`;
        });

        keywordsHTML += '</div>';
    }

    // Risk level badge
    let riskBadge = '';
    if (secretsInfo.risk_level === 'high') {
        riskBadge = '<span class="badge badge-danger" style="font-size: 1rem; padding: 0.5rem 1rem;">üî¥ HIGH RISK</span>';
    } else if (secretsInfo.risk_level === 'medium') {
        riskBadge = '<span class="badge badge-warning" style="font-size: 1rem; padding: 0.5rem 1rem;">üü† MEDIUM RISK</span>';
    } else if (secretsInfo.risk_level === 'low') {
        riskBadge = '<span class="badge badge-info" style="font-size: 1rem; padding: 0.5rem 1rem;">üü° LOW RISK</span>';
    }

    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <h3 style="margin: 0; color: #dc3545;">
                <i class="fas fa-key"></i> Secret Detection Report
            </h3>
            ${riskBadge}
        </div>
        <p style="word-break: break-all; background: #f8f9fa; padding: 0.75rem; border-radius: 4px; font-family: monospace; font-size: 0.85rem; border: 1px solid #dee2e6;">
            ${url}
        </p>

        ${secretsFoundHTML}
        ${keywordsHTML}

        <div style="background: ${secretsInfo.risk_level === 'high' ? '#f8d7da' : '#fff3cd'}; border-left: 4px solid ${secretsInfo.risk_level === 'high' ? '#dc3545' : '#ffc107'}; padding: 1rem; margin: 1rem 0;">
            <strong>‚ö†Ô∏è ${secretsInfo.risk_level === 'high' ? 'CRITICAL' : 'WARNING'}:</strong>
            ${secretsInfo.risk_level === 'high'
                ? 'This file contains patterns matching known secret formats.'
                : 'This file contains suspicious keywords that might indicate secrets.'
            }
            <br><br>
            <strong>Immediate Actions Required:</strong>
            <ul style="margin: 0.5rem 0 0 0;">
                <li>Download and verify if the detected patterns are actual secrets</li>
                <li>If confirmed, rotate all exposed credentials <strong>immediately</strong></li>
                <li>Remove sensitive data from the codebase</li>
                <li>Use environment variables or secret management systems</li>
                <li>Scan git history to ensure secrets were never committed</li>
            </ul>
        </div>

        <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
            <a href="${url}" target="_blank" class="btn btn-primary">
                <i class="fas fa-external-link-alt"></i> Open File
            </a>
            <button class="btn btn-secondary" onclick="copyToClipboard('${url}')">
                <i class="fas fa-copy"></i> Copy URL
            </button>
            <button class="btn btn-secondary" onclick="this.closest('div[style*=\\'position: fixed\\']').remove()">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);

    // Close on background click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// Trigger scan
function triggerScan(projectId, mode) {
    if (!confirm(`Start ${mode} scan?`)) return;

    showToast('Starting scan...', 'info');

    fetch('/api/scans/trigger', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({project_id: projectId, mode: mode})
    })
    .then(res => res.json())
    .then(data => {
        showToast('Scan started successfully! Check back in a few minutes.', 'success');
        setTimeout(() => location.reload(), 3000);
    })
    .catch(err => {
        showToast('Failed to start scan: ' + err.message, 'error');
    });
}

// Initialize stats on page load
document.addEventListener('DOMContentLoaded', () => {
    filterTable(); // Initialize counts for JS Files table
    filterAssets(); // Initialize counts and pagination for All Assets table
});
</script>
{% endblock %}
