{% extends "base.html" %}

{% block title %}{{ project.name }} - Asset Monitor{% endblock %}

{% block extra_css %}
<style>
    .filter-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .filter-bar input,
    .filter-bar select {
        padding: 0.5rem;
        border: 1px solid var(--border);
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }

    .filter-bar input {
        flex: 1;
        min-width: 200px;
    }

    .filter-bar select {
        min-width: 150px;
    }

    .asset-table {
        width: 100%;
        font-size: 0.875rem;
    }

    .asset-table td {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .asset-table td.expandable {
        cursor: pointer;
    }

    .asset-table td.expandable:hover {
        background: #f8fafc;
    }

    .badge-list {
        display: flex;
        gap: 0.25rem;
        flex-wrap: wrap;
    }

    .status-new {
        background: #dcfce7;
        color: #166534;
    }

    .status-deleted {
        background: #fee2e2;
        color: #991b1b;
    }

    .status-unchanged {
        background: #e2e8f0;
        color: #475569;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        width: 90%;
        max-width: 500px;
        border-radius: 12px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        margin: auto;
        position: relative;
        top: 50%;
        transform: translateY(-50%);
    }

    .modal-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8fafc;
        border-radius: 12px 12px 0 0;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.1rem;
        color: #0f172a;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #64748b;
        cursor: pointer;
        line-height: 1;
    }

    .close-btn:hover {
        color: #0f172a;
    }
</style>
{% endblock %}

{% block content %}
<div class="project-detail">
    <div class="page-header">
        <div>
            <h2>{{ project.name }}</h2>
            <p class="text-muted">{{ project.description or 'No description' }}</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-success" onclick="ScanModal.open({{ project.id }})">
                <i class="fas fa-play"></i> Run Scan
            </button>
            <button class="btn btn-info" onclick="openReportModal({{ project.id }})">
                <i class="fas fa-file-alt"></i> Report
            </button>
            <a href="/projects/{{ project.id }}/edit" class="btn btn-secondary">
                <i class="fas fa-edit"></i> Edit
            </a>
        </div>
    </div>

    <!-- Project info -->
    <div class="info-grid">
        <div class="info-card">
            <h4><i class="fas fa-globe"></i> Domains</h4>
            <ul class="domain-list">
                {% for domain in project.domains %}
                <li>{{ domain.name }}</li>
                {% endfor %}
            </ul>
        </div>

        <div class="info-card">
            <h4><i class="fas fa-clock"></i> Last Scan</h4>
            <p>
                {% if project.last_scan_at %}
                <span class="local-date" data-date="{{ project.last_scan_at.isoformat() }}">
                    {{ project.last_scan_at.strftime('%Y-%m-%d %H:%M:%S') }}
                </span>
                {% else %}
                Never scanned
                {% endif %}
            </p>
        </div>

        <div class="info-card">
            <h4><i class="fas fa-chart-line"></i> Asset Count</h4>
            <p>
                {% if latest_snapshots.subdomains %}
                {{ latest_snapshots.subdomains.data.subdomains|length }} subdomains
                {% else %}
                No data yet
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button id="tab-btn-dashboard" class="tab-btn active" onclick="switchTab('dashboard')">
            <i class="fas fa-chart-pie"></i> Dashboard
        </button>
        <button id="tab-btn-assets" class="tab-btn" onclick="switchTab('assets')">
            <i class="fas fa-table"></i> All Assets
        </button>
        <button id="tab-btn-takeovers" class="tab-btn" onclick="switchTab('takeovers')">
            <i class="fas fa-bug"></i> Vulnerabilities
            {% if latest_snapshots.dns and latest_snapshots.dns.scan_metadata and
            latest_snapshots.dns.scan_metadata.takeover_findings %}
            ({{ latest_snapshots.dns.scan_metadata.takeover_findings|length }})
            {% endif %}
        </button>
        <button id="tab-btn-endpoints" class="tab-btn" onclick="switchTab('endpoints')">
            <i class="fas fa-link"></i> Endpoints
        </button>
        <button id="tab-btn-jsfiles" class="tab-btn" onclick="switchTab('jsfiles')">
            <i class="fas fa-file-code"></i> JS Files
        </button>
        <button id="tab-btn-ports" class="tab-btn" onclick="switchTab('ports')">
            <i class="fas fa-plug"></i> Ports
            {% if latest_snapshots.ports and latest_snapshots.ports.data.stats %}
            ({{ latest_snapshots.ports.data.stats.get('open_ports_found', 0) }})
            {% endif %}
        </button>
        <button id="tab-btn-events" class="tab-btn" onclick="switchTab('events')">
            <i class="fas fa-bell"></i> Events
        </button>
        <button id="tab-btn-scans" class="tab-btn" onclick="switchTab('scans')">
            <i class="fas fa-history"></i> Scans
        </button>
        <button id="tab-btn-graph" class="tab-btn" onclick="initGraph(); switchTab('graph')">
            <i class="fas fa-project-diagram"></i> Topology
        </button>
    </div>

    <div id="tab-dashboard" class="tab-content active">
        <!-- ApexCharts CDN -->
        <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
        <!-- Vis.js CDN -->
        <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

        <!-- Dashboard Grid -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 2rem;">

            <!-- Row 1: Asset & Endpoint Status -->
            <div
                style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h4 style="margin: 0 0 1rem 0; color: #475569; font-size: 0.875rem; text-transform: uppercase;">
                    <i class="fas fa-heartbeat"></i> Asset Status Distribution
                </h4>
                <div id="chart-status" style="min-height: 250px;"></div>
            </div>

            <div
                style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h4 style="margin: 0 0 1rem 0; color: #475569; font-size: 0.875rem; text-transform: uppercase;">
                    <i class="fas fa-link"></i> Endpoint Status Distribution
                </h4>
                <div id="chart-endpoint-status" style="min-height: 250px;"></div>
            </div>

            <!-- Row 2: Trends & Tech -->
            <div
                style="grid-column: span 2; background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h4 style="margin: 0 0 1rem 0; color: #475569; font-size: 0.875rem; text-transform: uppercase;">
                    <i class="fas fa-chart-area"></i> Discovery Trend (7 Days)
                </h4>
                <div id="chart-trend" style="min-height: 250px;"></div>
            </div>

            <div
                style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h4 style="margin: 0 0 1rem 0; color: #475569; font-size: 0.875rem; text-transform: uppercase;">
                    <i class="fas fa-layer-group"></i> Top Technologies
                </h4>
                <div id="chart-tech" style="min-height: 250px;"></div>
            </div>

            <div
                style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h4 style="margin: 0 0 1rem 0; color: #475569; font-size: 0.875rem; text-transform: uppercase;">
                    <i class="fas fa-user-shield"></i> Sensitivity
                </h4>
                <div id="chart-sensitivity" style="min-height: 250px;"></div>
            </div>

            <!-- Row 3: Events -->
            <div
                style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h4 style="margin: 0 0 1rem 0; color: #475569; font-size: 0.875rem; text-transform: uppercase;">
                    <i class="fas fa-exclamation-circle"></i> Event Severity
                </h4>
                <div id="chart-event-severity" style="min-height: 250px;"></div>
            </div>

            <div
                style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h4 style="margin: 0 0 1rem 0; color: #475569; font-size: 0.875rem; text-transform: uppercase;">
                    <i class="fas fa-tags"></i> Top Event Types
                </h4>
                <div id="chart-event-types" style="min-height: 250px;"></div>
            </div>
        </div>
    </div>

    <!-- Tab: Graph -->
    <div id="tab-graph" class="tab-content">
        <div class="section"
            style="height: 800px; padding: 0; overflow: hidden; position: relative; border-radius: 12px; border: 1px solid #e2e8f0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">

            <!-- Top Controls Bar -->
            <div
                style="position: absolute; top: 0; left: 0; right: 0; z-index: 10; background: white; padding: 0.75rem 1rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                <!-- Left: Controls -->
                <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-secondary" onclick="network && network.fit()" title="Fit to screen">
                        <i class="fas fa-compress-arrows-alt"></i> Fit
                    </button>
                    <button class="btn btn-sm btn-secondary"
                        onclick="network && network.moveTo({scale: network.getScale() * 1.3})" title="Zoom in">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-secondary"
                        onclick="network && network.moveTo({scale: network.getScale() * 0.7})" title="Zoom out">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button class="btn btn-sm btn-secondary" id="btn-toggle-physics" onclick="togglePhysics()"
                        title="Toggle physics simulation">
                        <i class="fas fa-atom"></i> Physics
                    </button>
                    <div style="border-left: 1px solid #e2e8f0; padding-left: 0.75rem; margin-left: 0.25rem;">
                        <input type="text" id="graph-search" placeholder="Search nodes..."
                            style="padding: 0.25rem 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.8rem; width: 150px;"
                            onkeyup="searchNodes(this.value)">
                    </div>
                </div>

                <!-- Right: Filters -->
                <div style="display: flex; gap: 0.75rem; align-items: center; font-size: 0.8rem;">
                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                        <input type="checkbox" checked onchange="toggleNodeType('domain')" id="filter-domain">
                        <span style="width: 10px; height: 10px; background: #475569; border-radius: 2px;"></span>
                        Domains
                    </label>
                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                        <input type="checkbox" checked onchange="toggleNodeType('subdomain')" id="filter-subdomain">
                        <span style="width: 10px; height: 10px; background: #3b82f6; border-radius: 50%;"></span>
                        Subdomains
                    </label>
                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                        <input type="checkbox" checked onchange="toggleNodeType('ip')" id="filter-ip">
                        <span style="width: 10px; height: 10px; background: #10b981; border-radius: 2px;"></span> IPs
                    </label>
                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                        <input type="checkbox" checked onchange="toggleNodeType('port')" id="filter-port">
                        <span style="width: 10px; height: 10px; background: #f59e0b; border-radius: 50%;"></span> Ports
                    </label>
                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                        <input type="checkbox" checked onchange="toggleNodeType('vuln')" id="filter-vuln">
                        <span style="width: 10px; height: 10px; background: #ef4444; border-radius: 50%;"></span> Vulns
                    </label>
                </div>
            </div>

            <!-- Stats Panel (Top Right) -->
            <div id="graph-stats"
                style="position: absolute; top: 60px; right: 1rem; z-index: 10; background: white; padding: 0.75rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-size: 0.75rem; min-width: 120px;">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #334155;">üìä Statistics</div>
                <div id="stats-content" style="display: grid; gap: 0.25rem;">
                    <div style="color: #64748b;">Loading...</div>
                </div>
            </div>

            <!-- Graph Container -->
            <div id="asset-network" style="width: 100%; height: 100%; padding-top: 50px;"></div>

            <!-- Loading Indicator -->
            <div id="graph-loading"
                style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 5;">
                <i class="fas fa-circle-notch fa-spin" style="font-size: 2rem; color: #6366f1;"></i>
                <p style="margin-top: 1rem; color: #64748b;">Loading topology...</p>
            </div>

            <!-- Node Details Panel (Right Sidebar) -->
            <div id="node-details"
                style="position: absolute; top: 60px; right: 1rem; z-index: 15; background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 280px; display: none; max-height: calc(100% - 80px); overflow-y: auto;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                    <div style="font-weight: 600; color: #334155;">Node Details</div>
                    <button onclick="closeNodeDetails()"
                        style="background: none; border: none; cursor: pointer; color: #94a3b8; font-size: 1rem;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="node-details-content"></div>
            </div>
        </div>
    </div>


    <!-- Tab: All Assets -->
    <div id="tab-assets" class="tab-content">
        <div class="section">

            {% include '_project_charts.html' %}

            <h3>üåê All Discovered Assets</h3>

            <!-- Filters -->
            <form method="GET" action="/projects/{{ project.id }}"
                style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1.5rem; align-items: center;">
                <input type="hidden" name="tab" id="activeTabInput"
                    value="{{ request.query_params.get('tab', 'dashboard') }}">
                <div style="flex: 1; min-width: 250px;">
                    <input type="text" name="search" id="searchInput" value="{{ search }}"
                        placeholder="üîç Search URL, title, IP, or technology..."
                        style="width: 100%; padding: 0.625rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem;">
                </div>

                <div style="flex: 1; min-width: 250px;">
                    <input type="text" name="exclude" value="{{ exclude|default('', true) }}"
                        placeholder="‚õî Exclude (e.g. cdn,img,css)"
                        style="width: 100%; padding: 0.625rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem;"
                        title="Comma-separated patterns to hide">
                </div>

                <select name="change_filter" id="changeFilter"
                    style="padding: 0.625rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; background: white;">
                    <option value="">üîî All Changes</option>
                    <option value="new" {% if change_filter=="new" %}selected{% endif %}>‚≠ê New Assets</option>
                    <option value="changed" {% if change_filter=="changed" %}selected{% endif %}>üìù Modified Assets
                    </option>
                    <option value="any" {% if change_filter=="any" %}selected{% endif %}>üîî Any Change</option>
                </select>

                <select name="status_filter" id="statusFilter"
                    style="padding: 0.625rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; background: white;">
                    <option value="">üìä All Status</option>
                    <option value="200" {% if status_filter=="200" %}selected{% endif %}>‚úÖ 2xx Success</option>
                    <option value="300" {% if status_filter=="300" %}selected{% endif %}>üîÑ 3xx Redirect</option>
                    <option value="400" {% if status_filter=="400" %}selected{% endif %}>‚ö†Ô∏è 4xx Client Error</option>
                    <option value="500" {% if status_filter=="500" %}selected{% endif %}>‚ùå 5xx Server Error</option>
                </select>

                <select name="tech_filter"
                    style="padding: 0.625rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; background: white;">
                    <option value="">üîß All Technologies</option>
                    {% if latest_snapshots.http %}
                    {% set all_technologies = [] %}
                    {% for url, record in latest_snapshots.http.data.http_records.items() %}
                    {% if record.technologies %}
                    {% for tech in record.technologies %}
                    {% if tech not in all_technologies %}
                    {% set _ = all_technologies.append(tech) %}
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                    {% endfor %}
                    {% for tech in all_technologies|sort %}
                    <option value="{{ tech }}" {% if tech_filter==tech %}selected{% endif %}>{{ tech }}</option>
                    {% endfor %}
                    {% endif %}
                </select>

                <input type="hidden" name="per_page" value="{{ per_page }}">

                <button type="submit" class="btn btn-sm btn-primary"
                    style="padding: 0.625rem 1rem; border: none; border-radius: 8px; background: #667eea; color: white; cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                    <i class="fas fa-filter"></i> Apply
                </button>

                <a href="/projects/{{ project.id }}" class="btn btn-sm btn-secondary"
                    style="padding: 0.625rem 1rem; border: none; border-radius: 8px; background: #64748b; color: white; cursor: pointer; font-size: 0.875rem; font-weight: 500; text-decoration: none; display: inline-block;">
                    <i class="fas fa-undo"></i> Reset
                </a>

                <button type="button" class="btn btn-sm btn-primary" onclick="exportAssetsToCSV()"
                    style="padding: 0.625rem 1rem; border: none; border-radius: 8px; background: #10b981; color: white; cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                    <i class="fas fa-download"></i> Export CSV
                </button>
            </form>

            <!-- Stats Summary -->
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                {% if latest_snapshots.subdomains %}
                {% set all_subdomains = latest_snapshots.subdomains.data.subdomains %}
                {% set dns_resolved = namespace(count=0) %}
                {% set http_probed = namespace(count=0) %}
                {% if latest_snapshots.dns %}
                {% for subdomain in all_subdomains %}
                {% set dns_rec = latest_snapshots.dns.data.dns_records.get(subdomain) %}
                {% if dns_rec and dns_rec.has_resolution %}
                {% set dns_resolved.count = dns_resolved.count + 1 %}
                {% endif %}
                {% endfor %}
                {% endif %}
                {% if latest_snapshots.http %}
                {% set http_probed.count = latest_snapshots.http.data.http_records|length %}
                {% endif %}

                <div
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem; border-radius: 12px; color: white;">
                    <div style="font-size: 2rem; font-weight: bold;">{{ all_subdomains|length }}</div>
                    <div style="font-size: 0.875rem; opacity: 0.9;">Total Subdomains</div>
                </div>

                <div
                    style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 1rem; border-radius: 12px; color: white;">
                    <div style="font-size: 2rem; font-weight: bold;">{{ dns_resolved.count }}</div>
                    <div style="font-size: 0.875rem; opacity: 0.9;">DNS Resolved</div>
                </div>

                <div
                    style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); padding: 1rem; border-radius: 12px; color: white;">
                    <div style="font-size: 2rem; font-weight: bold;">{{ http_probed.count }}</div>
                    <div style="font-size: 0.875rem; opacity: 0.9;">HTTP Probed</div>
                </div>

                <div
                    style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); padding: 1rem; border-radius: 12px; color: white;">
                    <div style="font-size: 2rem; font-weight: bold;">{{ all_subdomains|length - dns_resolved.count }}
                    </div>
                    <div style="font-size: 0.875rem; opacity: 0.9;">Unresolved</div>
                </div>
                {% endif %}
            </div>

            <!-- Assets Table -->
            <div class="table-responsive"
                style="background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow-x: auto;">
                <table class="table" id="assetTable" style="margin: 0; width: 100%;">
                    <thead style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                        <tr>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">#</th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">Screenshot
                            </th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">URL</th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">Status
                                Change</th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">Status
                            </th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">Title</th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">
                                Technologies
                            </th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">A Record
                            </th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">Ports</th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">
                                Vulnerabilities</th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">CNAME</th>
                            <th style="padding: 1rem; font-weight: 600; color: #1e293b; font-size: 0.875rem;">CDN/WAF
                            </th>
                        </tr>
                    </thead>
                    <tbody id="assetsTableBody">
                        {% if paginated_subdomains %}
                        {% for subdomain in paginated_subdomains %}
                        {% set dns_record = latest_snapshots.dns.data.dns_records.get(subdomain) if latest_snapshots.dns
                        else none %}
                        {% set http_url_https = 'https://' + subdomain %}
                        {% set http_url_http = 'http://' + subdomain %}
                        {% set http_record = latest_snapshots.http.data.http_records.get(http_url_https) if
                        latest_snapshots.http else none %}
                        {% if not http_record %}
                        {% set http_record = latest_snapshots.http.data.http_records.get(http_url_http) if
                        latest_snapshots.http else none %}
                        {% set http_url_https = http_url_http if http_record else http_url_https %}
                        {% endif %}
                        {# Get Shodan data for first IP that has data #}
                        {% set shodan_data = namespace(value=none) %}
                        {% if latest_snapshots.shodan and dns_record and dns_record.a %}
                        {% for ip in dns_record.a %}
                        {% if not shodan_data.value and latest_snapshots.shodan.data.shodan_results.get(ip) %}
                        {% set shodan_data.value = latest_snapshots.shodan.data.shodan_results.get(ip) %}
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                        <tr class="asset-row" style="border-bottom: 1px solid #f1f5f9; transition: background 0.2s;"
                            onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'"
                            data-url="{{ http_url_https }}" data-subdomain="{{ subdomain }}"
                            data-status="{{ http_record.status_code if http_record else '' }}"
                            data-title="{{ http_record.title if http_record else '' }}"
                            data-ip="{{ http_record.ip if http_record else (dns_record.a[0] if dns_record and dns_record.a else '') }}"
                            data-technologies="{{ http_record.technologies|join(',') if http_record and http_record.technologies else '' }}"
                            data-cname="{{ dns_record.cname|join(',') if dns_record and dns_record.cname else '' }}">
                            <td style="padding: 1rem; color: #64748b; font-size: 0.875rem;">{{ ((current_page - 1) *
                                per_page) + loop.index }}</td>

                            <!-- Screenshot -->
                            <td style="padding: 1rem;">
                                {% if http_record and http_record.screenshot %}
                                <img src="data:image/png;base64,{{ http_record.screenshot }}" alt="Screenshot"
                                    style="width: 120px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #e2e8f0; cursor: pointer;"
                                    onclick="showScreenshotModal('{{ http_url_https }}', this.src)"
                                    title="Click to enlarge">
                                {% else %}
                                <div
                                    style="width: 120px; height: 80px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: #94a3b8;">
                                    <i class="fas fa-image" style="font-size: 1.5rem;"></i>
                                </div>
                                {% endif %}
                            </td>
                            <!-- URL -->
                            <td style="padding: 1rem; white-space: nowrap;">
                                <a href="{{ http_url_https }}" target="_blank"
                                    style="color: #667eea; text-decoration: none; font-weight: 500; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.25rem; white-space: nowrap;"
                                    onmouseover="this.style.textDecoration='underline'"
                                    onmouseout="this.style.textDecoration='none'">
                                    {{ subdomain }}
                                    <i class="fas fa-external-link-alt" style="font-size: 0.75rem; opacity: 0.6;"></i>
                                </a>
                            </td>

                            <!-- Status Change Badge -->
                            <td style="padding: 1rem;">
                                {% set changes = asset_changes.get(subdomain) %}
                                {% if changes %}
                                {% set ns = namespace(is_new=false) %}
                                {% for e in changes %}
                                {# Check for new subdomain event type #}
                                {% if e.type|string == 'subdomain_new' or e.type|string == 'EventType.SUBDOMAIN_NEW' %}
                                {% set ns.is_new = true %}
                                {% endif %}
                                {% endfor %}

                                <span onclick='showAssetChanges({{ subdomain|tojson }}, [
                                        {% for e in changes %}
                                        {
                                            "summary": {{ e.summary|tojson }},
                                            "severity": "{{ e.severity }}",
                                            "created_at": "{{ e.created_at.strftime("%Y-%m-%d %H:%M") }}",
                                            "details": {{ e.details|tojson }}
                                        }{{ "," if not loop.last }}
                                        {% endfor %}
                                    ])' style="padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.25rem;
                                    {% if ns.is_new %}
                                        background: #dcfce7; color: #166534; border: 1px solid #bbf7d0;
                                    {% else %}
                                        background: #fffbeb; color: #92400e; border: 1px solid #fde68a;
                                    {% endif %}">
                                    {% if ns.is_new %}
                                    <i class="fas fa-star"></i> NEW
                                    {% if changes|length > 1 %}
                                    <span
                                        style="background: rgba(0,0,0,0.1); padding: 0 4px; border-radius: 4px; margin-left: 4px;">+{{
                                        changes|length - 1 }}</span>
                                    {% endif %}
                                    {% else %}
                                    <i class="fas fa-history"></i> {{ changes|length }} CHANGE{{ 'S' if changes|length >
                                    1 }}
                                    {% endif %}
                                </span>
                                {% else %}
                                <span style="color: #cbd5e1;">-</span>
                                {% endif %}
                            </td>
                            <!-- HTTP Status -->
                            <td style="padding: 1rem;">
                                {% if http_record and http_record.status_code %}
                                {% if http_record.status_code < 300 %} <span
                                    style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8125rem; font-weight: 600; background: #dcfce7; color: #166534;">
                                    {{ http_record.status_code }}
                                    </span>
                                    {% elif http_record.status_code < 400 %} <span
                                        style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8125rem; font-weight: 600; background: #fef3c7; color: #92400e;">
                                        {{ http_record.status_code }}
                                        </span>
                                        {% else %}
                                        <span
                                            style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8125rem; font-weight: 600; background: #fee2e2; color: #991b1b;">
                                            {{ http_record.status_code }}
                                        </span>
                                        {% endif %}
                                        {% else %}
                                        <span style="color: #94a3b8;">-</span>
                                        {% endif %}
                            </td>
                            <!-- Title -->
                            <td style="padding: 1rem; max-width: 250px;">
                                {% if http_record and http_record.title %}
                                <span
                                    style="color: #334155; font-size: 0.875rem; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                                    title="{{ http_record.title }}">
                                    {{ http_record.title }}
                                </span>
                                {% else %}
                                <span style="color: #94a3b8;">-</span>
                                {% endif %}
                            </td>
                            <!-- Technologies -->
                            <td style="padding: 1rem;">
                                {% if http_record and http_record.technologies %}
                                <div style="display: flex; flex-wrap: wrap; gap: 0.375rem; max-width: 200px;">
                                    {% for tech in http_record.technologies[:3] %}
                                    <span
                                        style="padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; font-weight: 500; background: #e0e7ff; color: #3730a3;">
                                        {{ tech }}
                                    </span>
                                    {% endfor %}
                                    {% if http_record.technologies|length > 3 %}
                                    <span
                                        style="padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; font-weight: 500; background: #f1f5f9; color: #475569;">
                                        +{{ http_record.technologies|length - 3 }}
                                    </span>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span style="color: #94a3b8;">-</span>
                                {% endif %}
                            </td>
                            <!-- A Record -->
                            <td style="padding: 1rem;">
                                {% if dns_record and dns_record.a %}
                                <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                    {% for ip in dns_record.a[:2] %}
                                    <code
                                        style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; background: #f8fafc; color: #475569; font-family: 'Courier New', monospace;">
                                        {{ ip }}
                                    </code>
                                    {% endfor %}
                                    {% if dns_record.a|length > 2 %}
                                    <span
                                        style="padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; background: #f1f5f9; color: #475569;">
                                        +{{ dns_record.a|length - 2 }}
                                    </span>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span style="color: #94a3b8;">-</span>
                                {% endif %}
                            </td>
                            <!-- Ports (Shodan) -->
                            <td style="padding: 1rem;">
                                {% if shodan_data.value and shodan_data.value.ports %}
                                <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                    {% for port in shodan_data.value.ports[:5] %}
                                    <span
                                        style="padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; font-weight: 500; background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe;">
                                        <i class="fas fa-network-wired" style="font-size: 0.65rem;"></i> {{ port }}
                                    </span>
                                    {% endfor %}
                                    {% if shodan_data.value.ports|length > 5 %}
                                    <span
                                        style="padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; background: #f1f5f9; color: #475569;">
                                        +{{ shodan_data.value.ports|length - 5 }}
                                    </span>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span style="color: #94a3b8;">-</span>
                                {% endif %}
                            </td>
                            <!-- Vulnerabilities (Shodan) -->
                            <td style="padding: 1rem;">
                                {% if shodan_data.value and shodan_data.value.vulns %}
                                <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                    {% for vuln in shodan_data.value.vulns[:3] %}
                                    <span
                                        style="padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; background: #fee2e2; color: #991b1b; border: 1px solid #fecaca;">
                                        <i class="fas fa-exclamation-triangle" style="font-size: 0.65rem;"></i> {{ vuln
                                        }}
                                    </span>
                                    {% endfor %}
                                    {% if shodan_data.value.vulns|length > 3 %}
                                    <span
                                        style="padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; background: #fee2e2; color: #991b1b;">
                                        +{{ shodan_data.value.vulns|length - 3 }}
                                    </span>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span style="color: #94a3b8;">-</span>
                                {% endif %}
                            </td>
                            <!-- CNAME -->
                            <td style="padding: 1rem; max-width: 200px;">
                                {% if dns_record and dns_record.cname %}
                                <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                    {% for cname in dns_record.cname[:1] %}
                                    <span
                                        style="color: #64748b; font-size: 0.75rem; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                                        title="{{ cname }}">
                                        {{ cname }}
                                    </span>
                                    {% endfor %}
                                    {% if dns_record.cname|length > 1 %}
                                    <span
                                        style="padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; background: #f1f5f9; color: #475569;">
                                        +{{ dns_record.cname|length - 1 }}
                                    </span>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span style="color: #94a3b8;">-</span>
                                {% endif %}
                            </td>
                            <!-- CDN/WAF -->
                            <td style="padding: 1rem;">
                                {% if http_record and http_record.cdn %}
                                <span
                                    style="padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; font-weight: 500; background: #dbeafe; color: #1e40af;">
                                    <i class="fas fa-cloud"></i> {{ http_record.cdn if http_record.cdn != true else
                                    'CDN' }}
                                </span>
                                {% else %}
                                <span style="color: #94a3b8;">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="11" style="padding: 3rem; text-align: center;">
                                <div style="color: #94a3b8;">
                                    <i class="fas fa-search"
                                        style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                    <h3 style="color: #64748b; font-size: 1.125rem; margin-bottom: 0.5rem;">No
                                        Subdomains
                                        Found</h3>
                                    <p style="color: #94a3b8; font-size: 0.875rem;">Run a scan to discover subdomains
                                        and
                                        assets</p>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div
                style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <!-- Stats -->
                <div
                    style="padding: 1rem; background: #f8fafc; border-radius: 8px; color: #64748b; font-size: 0.875rem; flex: 1; min-width: 200px;">
                    Showing <span style="font-weight: 600; color: #475569;">{{ showing_start }}</span>-<span
                        style="font-weight: 600; color: #475569;">{{ showing_end }}</span> of <span
                        style="font-weight: 600; color: #475569;">{{ total_subdomains }}</span> assets
                    <span style="margin-left: 0.5rem;">‚Ä¢</span>
                    <small style="color: #94a3b8; margin-left: 0.5rem;">Last scan:
                        {% if latest_snapshots.subdomains %}
                        <span class="local-date" data-date="{{ latest_snapshots.subdomains.created_at.isoformat() }}">
                            {{ latest_snapshots.subdomains.created_at.strftime('%Y-%m-%d %H:%M') }}
                        </span>
                        {% else %}
                        Never
                        {% endif %}
                    </small>
                </div>

                <!-- Per Page Selector -->
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <label style="font-size: 0.875rem; color: #64748b;">Per page:</label>
                    <select
                        onchange="window.location.href='?page=1&per_page=' + this.value + '{{ ('&search=' + search) if search else '' }}{{ ('&status_filter=' + status_filter) if status_filter else '' }}{{ ('&tech_filter=' + tech_filter) if tech_filter else '' }}'"
                        style="padding: 0.5rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; background: white; cursor: pointer;">
                        <option value="25" {% if per_page==25 %}selected{% endif %}>25</option>
                        <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
                        <option value="100" {% if per_page==100 %}selected{% endif %}>100</option>
                        <option value="500" {% if per_page==500 %}selected{% endif %}>500</option>
                    </select>
                </div>

                <!-- Pagination Buttons -->
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    {% if current_page > 1 %}
                    <a href="?page=1&per_page={{ per_page }}{{ ('&search=' + search) if search else '' }}{{ ('&status_filter=' + status_filter) if status_filter else '' }}{{ ('&tech_filter=' + tech_filter) if tech_filter else '' }}"
                        style="padding: 0.5rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; color: #475569; text-decoration: none; font-size: 0.875rem; cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.background='#f8fafc'; this.style.borderColor='#cbd5e1'"
                        onmouseout="this.style.background='white'; this.style.borderColor='#e2e8f0'">
                        <i class="fas fa-angle-double-left"></i> First
                    </a>
                    <a href="?page={{ current_page - 1 }}&per_page={{ per_page }}{{ ('&search=' + search) if search else '' }}{{ ('&status_filter=' + status_filter) if status_filter else '' }}{{ ('&tech_filter=' + tech_filter) if tech_filter else '' }}"
                        style="padding: 0.5rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; color: #475569; text-decoration: none; font-size: 0.875rem; cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.background='#f8fafc'; this.style.borderColor='#cbd5e1'"
                        onmouseout="this.style.background='white'; this.style.borderColor='#e2e8f0'">
                        <i class="fas fa-angle-left"></i> Prev
                    </a>
                    {% else %}
                    <span
                        style="padding: 0.5rem 1rem; border: 2px solid #f1f5f9; border-radius: 8px; background: #f8fafc; color: #cbd5e1; font-size: 0.875rem; cursor: not-allowed;">
                        <i class="fas fa-angle-double-left"></i> First
                    </span>
                    <span
                        style="padding: 0.5rem 1rem; border: 2px solid #f1f5f9; border-radius: 8px; background: #f8fafc; color: #cbd5e1; font-size: 0.875rem; cursor: not-allowed;">
                        <i class="fas fa-angle-left"></i> Prev
                    </span>
                    {% endif %}

                    <span
                        style="padding: 0.5rem 1rem; background: #667eea; color: white; border-radius: 8px; font-weight: 600; font-size: 0.875rem;">
                        Page {{ current_page }} of {{ total_pages }}
                    </span>

                    {% if current_page < total_pages %} <a
                        href="?page={{ current_page + 1 }}&per_page={{ per_page }}{{ ('&search=' + search) if search else '' }}{{ ('&status_filter=' + status_filter) if status_filter else '' }}{{ ('&tech_filter=' + tech_filter) if tech_filter else '' }}"
                        style="padding: 0.5rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; color: #475569; text-decoration: none; font-size: 0.875rem; cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.background='#f8fafc'; this.style.borderColor='#cbd5e1'"
                        onmouseout="this.style.background='white'; this.style.borderColor='#e2e8f0'">
                        Next <i class="fas fa-angle-right"></i>
                        </a>
                        <a href="?page={{ total_pages }}&per_page={{ per_page }}{{ ('&search=' + search) if search else '' }}{{ ('&status_filter=' + status_filter) if status_filter else '' }}{{ ('&tech_filter=' + tech_filter) if tech_filter else '' }}"
                            style="padding: 0.5rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; color: #475569; text-decoration: none; font-size: 0.875rem; cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.background='#f8fafc'; this.style.borderColor='#cbd5e1'"
                            onmouseout="this.style.background='white'; this.style.borderColor='#e2e8f0'">
                            Last <i class="fas fa-angle-double-right"></i>
                        </a>
                        {% else %}
                        <span
                            style="padding: 0.5rem 1rem; border: 2px solid #f1f5f9; border-radius: 8px; background: #f8fafc; color: #cbd5e1; font-size: 0.875rem; cursor: not-allowed;">
                            Next <i class="fas fa-angle-right"></i>
                        </span>
                        <span
                            style="padding: 0.5rem 1rem; border: 2px solid #f1f5f9; border-radius: 8px; background: #f8fafc; color: #cbd5e1; font-size: 0.875rem; cursor: not-allowed;">
                            Last <i class="fas fa-angle-double-right"></i>
                        </span>
                        {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Screenshot Modal -->
    <div id="screenshotModal"
        style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); padding: 2rem;"
        onclick="this.style.display='none'">
        <div
            style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
            <button onclick="document.getElementById('screenshotModal').style.display='none'"
                style="position: absolute; top: 1rem; right: 1rem; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.25rem; color: #1e293b;">
                √ó
            </button>
            <div
                style="max-width: 90%; max-height: 90%; overflow: auto; background: white; border-radius: 12px; padding: 1rem;">
                <h3 id="modalTitle"
                    style="margin-bottom: 1rem; color: #1e293b; font-size: 1.125rem; word-break: break-all;"></h3>
                <img id="modalImage" src="" alt="Screenshot" style="width: 100%; height: auto; border-radius: 8px;">
            </div>
        </div>
    </div>

    <!-- Asset Changes Modal -->
    <div id="assetChangesModal"
        style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); padding: 1rem;"
        onclick="if(event.target === this) this.style.display='none'">
        <div
            style="position: relative; width: 100%; max-width: 600px; margin: 2rem auto; background: white; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); display: flex; flex-direction: column; max-height: 90vh;">
            <div
                style="padding: 1.25rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 1.125rem; color: #1e293b;" id="assetChangesTitle">Asset Changes</h3>
                <button onclick="document.getElementById('assetChangesModal').style.display='none'"
                    style="background: none; border: none; font-size: 1.5rem; color: #64748b; cursor: pointer; padding: 0.5rem; line-height: 1;">&times;</button>
            </div>
            <div id="assetChangesContent" style="padding: 1.25rem; overflow-y: auto;">
                <!-- Content injected by JS -->
            </div>
            <div
                style="padding: 1rem 1.25rem; border-top: 1px solid #e2e8f0; background: #f8fafc; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; text-align: right;">
                <button class="btn btn-secondary"
                    onclick="document.getElementById('assetChangesModal').style.display='none'">Close</button>
            </div>
        </div>
    </div>

    {% include '_takeovers_tab.html' %}

    {% include '_endpoints_tab.html' %}


    {% include '_jsfiles_tab.html' %}

    <!-- Tab: Ports -->
    <div id="tab-ports" class="tab-content">
        {% include '_partials/port_scan_results.html' %}
    </div>

    {% include '_events_tab.html' %}

    <!-- Tab: Scans -->
    <div id="tab-scans" class="tab-content">
        <div class="section">
            <h3>Scan History</h3>
            {% if recent_scans %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Mode</th>
                            <th>Status</th>
                            <th>Started</th>
                            <th>Completed</th>
                            <th>Events</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for scan in recent_scans %}
                        <tr>
                            <td><span class="badge badge-info">{{ scan.scan_mode }}</span></td>
                            <td>
                                <span class="badge badge-{{ 'success' if scan.status == 'completed' else 'warning' }}">
                                    {{ scan.status }}
                                </span>
                            </td>
                            <td>
                                <span class="local-date" data-date="{{ scan.started_at.isoformat() }}">
                                    {{ scan.started_at.strftime('%Y-%m-%d %H:%M') }}
                                </span>
                            </td>
                            <td>
                                {% if scan.completed_at %}
                                <span class="local-date" data-date="{{ scan.completed_at.isoformat() }}">
                                    {{ scan.completed_at.strftime('%Y-%m-%d %H:%M') }}
                                </span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>{{ scan.events_generated or 0 }}</td>
                            <td>
                                {% if scan.completed_at and scan.started_at %}
                                {{ ((scan.completed_at - scan.started_at).total_seconds() / 60) | round(1) }} min
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-history"></i>
                <h3>No Scan History</h3>
                <p>No scans have been run yet</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
    .event-detail-box {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 1.5rem;
        margin: 1rem 0;
    }

    .event-detail-box h4 {
        margin-top: 0;
        color: #007bff;
    }

    .detail-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1rem;
    }

    .detail-column {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 1rem;
    }

    .detail-column h5 {
        margin-top: 0;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #dee2e6;
    }

    .detail-column.old-value h5 {
        color: #dc3545;
    }

    .detail-column.new-value h5 {
        color: #28a745;
    }

    .detail-list {
        list-style: none;
        padding: 0;
        margin: 0.5rem 0;
    }

    .detail-list li {
        padding: 0.25rem 0;
        font-family: monospace;
    }

    .detail-added {
        color: #28a745;
        font-weight: bold;
    }

    .detail-removed {
        color: #dc3545;
        font-weight: bold;
    }

    .detail-info {
        background: #e7f3ff;
        padding: 0.75rem;
        border-radius: 4px;
        margin-top: 1rem;
    }

    .detail-info strong {
        color: #0056b3;
    }
</style>

<script>
    // Event detail display
    function showEventDetail(eventId) {
        const detailRow = document.getElementById(`event-detail-${eventId}`);
        const contentDiv = document.getElementById(`event-detail-content-${eventId}`);

        // Toggle visibility
        if (detailRow.style.display === 'none') {
            // Load event details via API
            fetch(`/api/events/${eventId}`)
                .then(res => res.json())
                .then(event => {
                    contentDiv.innerHTML = formatEventDetails(event);
                    detailRow.style.display = 'table-row';
                })
                .catch(err => {
                    contentDiv.innerHTML = '<p class="text-danger">Failed to load event details</p>';
                    detailRow.style.display = 'table-row';
                });
        } else {
            detailRow.style.display = 'none';
        }
    }

    function formatEventDetails(event) {
        if (!event.details) {
            return '<p>No additional details available</p>';
        }

        const details = event.details;
        let html = '';

        // DNS A Record Changes
        if (details.change_type === 'a_record') {
            html += '<div class="detail-comparison">';

            // Old IPs
            html += '<div class="detail-column old-value">';
            html += '<h5><i class="fas fa-clock"></i> Previous A Records</h5>';
            if (details.old_ips && details.old_ips.length > 0) {
                html += '<ul class="detail-list">';
                details.old_ips.forEach(ip => {
                    html += `<li><code>${ip}</code></li>`;
                });
                html += '</ul>';
            } else {
                html += '<p class="text-muted">No records</p>';
            }
            html += '</div>';

            // New IPs
            html += '<div class="detail-column new-value">';
            html += '<h5><i class="fas fa-check-circle"></i> Current A Records</h5>';
            if (details.new_ips && details.new_ips.length > 0) {
                html += '<ul class="detail-list">';
                details.new_ips.forEach(ip => {
                    html += `<li><code>${ip}</code></li>`;
                });
                html += '</ul>';
            } else {
                html += '<p class="text-muted">No records</p>';
            }
            html += '</div>';

            html += '</div>';

            // Summary of changes
            html += '<div class="detail-info">';
            if (details.added_ips && details.added_ips.length > 0) {
                html += '<p class="detail-added"><i class="fas fa-plus-circle"></i> Added IPs: ' + details.added_ips.join(', ') + '</p>';
            }
            if (details.removed_ips && details.removed_ips.length > 0) {
                html += '<p class="detail-removed"><i class="fas fa-minus-circle"></i> Removed IPs: ' + details.removed_ips.join(', ') + '</p>';
            }
            html += '</div>';
        }

        // DNS CNAME Changes
        else if (details.change_type === 'cname') {
            html += '<div class="detail-comparison">';

            // Old CNAMEs
            html += '<div class="detail-column old-value">';
            html += '<h5><i class="fas fa-clock"></i> Previous CNAME Records</h5>';
            if (details.old_cnames && details.old_cnames.length > 0) {
                html += '<ul class="detail-list">';
                details.old_cnames.forEach(cname => {
                    html += `<li><code>${cname}</code></li>`;
                });
                html += '</ul>';
            } else {
                html += '<p class="text-muted">No records</p>';
            }
            html += '</div>';

            // New CNAMEs
            html += '<div class="detail-column new-value">';
            html += '<h5><i class="fas fa-check-circle"></i> Current CNAME Records</h5>';
            if (details.new_cnames && details.new_cnames.length > 0) {
                html += '<ul class="detail-list">';
                details.new_cnames.forEach(cname => {
                    html += `<li><code>${cname}</code></li>`;
                });
                html += '</ul>';
            } else {
                html += '<p class="text-muted">No records</p>';
            }
            html += '</div>';

            html += '</div>';

            // Summary of changes
            html += '<div class="detail-info">';
            if (details.added_cnames && details.added_cnames.length > 0) {
                html += '<p class="detail-added"><i class="fas fa-plus-circle"></i> Added CNAMEs: ' + details.added_cnames.join(', ') + '</p>';
            }
            if (details.removed_cnames && details.removed_cnames.length > 0) {
                html += '<p class="detail-removed"><i class="fas fa-minus-circle"></i> Removed CNAMEs: ' + details.removed_cnames.join(', ') + '</p>';
            }
            html += '</div>';
        }

        // HTTP Status Changes
        else if (details.old_status !== undefined && details.new_status !== undefined) {
            html += '<div class="detail-comparison">';

            html += '<div class="detail-column old-value">';
            html += '<h5><i class="fas fa-clock"></i> Previous Status</h5>';
            html += `<p><code>${details.old_status}</code></p>`;
            html += '</div>';

            html += '<div class="detail-column new-value">';
            html += '<h5><i class="fas fa-check-circle"></i> Current Status</h5>';
            html += `<p><code>${details.new_status}</code></p>`;
            html += '</div>';

            html += '</div>';
        }

        // HTTP Title Changes
        else if (details.old_title !== undefined && details.new_title !== undefined) {
            html += '<div class="detail-comparison">';

            html += '<div class="detail-column old-value">';
            html += '<h5><i class="fas fa-clock"></i> Previous Title</h5>';
            html += `<p>${details.old_title || '(empty)'}</p>`;
            html += '</div>';

            html += '<div class="detail-column new-value">';
            html += '<h5><i class="fas fa-check-circle"></i> Current Title</h5>';
            html += `<p>${details.new_title || '(empty)'}</p>`;
            html += '</div>';

            html += '</div>';
        }

        // New Port Detected (Shodan) - has hostnames field
        else if (details.port !== undefined && details.ip && details.hostnames !== undefined) {
            html += '<div class="detail-info">';
            html += '<h5><i class="fas fa-network-wired"></i> New Port Discovered</h5>';
            html += `<p><strong>IP Address:</strong> <code>${details.ip}</code></p>`;
            html += `<p><strong>Port:</strong> <code>${details.port}</code></p>`;

            if (details.subdomains && details.subdomains.length > 0) {
                html += `<p><strong>Related Subdomains:</strong></p>`;
                html += '<ul class="detail-list">';
                details.subdomains.forEach(subdomain => {
                    html += `<li><code>${subdomain}</code></li>`;
                });
                html += '</ul>';
            }

            if (details.hostnames && details.hostnames.length > 0) {
                html += `<p><strong>Shodan Hostnames:</strong> ${details.hostnames.map(h => `<code>${h}</code>`).join(', ')}</p>`;
            }
            html += '</div>';
        }

        // Port Removed (Shodan) - no hostnames field
        else if (details.port !== undefined && details.ip && details.hostnames === undefined && !details.cve) {
            html += '<div class="detail-info" style="border-left: 4px solid #6c757d;">';
            html += '<h5 style="color: #6c757d;"><i class="fas fa-times-circle"></i> Port Closed</h5>';
            html += `<p><strong>IP Address:</strong> <code>${details.ip}</code></p>`;
            html += `<p><strong>Port:</strong> <code>${details.port}</code></p>`;

            if (details.subdomains && details.subdomains.length > 0) {
                html += `<p><strong>Related Subdomains:</strong></p>`;
                html += '<ul class="detail-list">';
                details.subdomains.forEach(subdomain => {
                    html += `<li><code>${subdomain}</code></li>`;
                });
                html += '</ul>';
            }
            html += '</div>';
        }

        // Vulnerability Found (Shodan)
        else if (details.cve !== undefined && details.ip) {
            html += '<div class="detail-info" style="border-left: 4px solid #dc3545;">';
            html += '<h5 style="color: #dc3545;"><i class="fas fa-bug"></i> Vulnerability Details</h5>';
            html += `<p><strong>CVE ID:</strong> <code>${details.cve}</code></p>`;
            html += `<p><strong>IP Address:</strong> <code>${details.ip}</code></p>`;

            if (details.subdomains && details.subdomains.length > 0) {
                html += `<p><strong>Affected Subdomains:</strong></p>`;
                html += '<ul class="detail-list">';
                details.subdomains.forEach(subdomain => {
                    html += `<li><code>${subdomain}</code></li>`;
                });
                html += '</ul>';
            }

            if (details.hostnames && details.hostnames.length > 0) {
                html += `<p><strong>Shodan Hostnames:</strong> ${details.hostnames.map(h => `<code>${h}</code>`).join(', ')}</p>`;
            }

            html += `<p style="margin-top: 1rem;"><a href="https://nvd.nist.gov/vuln/detail/${details.cve}" target="_blank" class="btn btn-sm btn-danger">`;
            html += '<i class="fas fa-external-link-alt"></i> View on NVD</a></p>';
            html += '</div>';
        }

        // Generic details view
        else {
            html += '<div class="detail-info">';
            html += '<pre>' + JSON.stringify(details, null, 2) + '</pre>';
            html += '</div>';
        }

        // Show subdomain/URL if available
        if (details.subdomain || details.url) {
            html += '<div style="margin-top: 1rem;">';
            html += '<strong><i class="fas fa-globe"></i> Target:</strong> ';
            html += `<code>${details.subdomain || details.url}</code>`;
            html += '</div>';
        }

        return html;
    }

    // Tab switching
    // Tab switching
    function switchTab(tabName) {
        // Update URL to persist state on refresh
        const url = new URL(window.location);
        url.searchParams.set('tab', tabName);
        window.history.pushState({}, '', url);

        // Update hidden input for form submission
        const tabInput = document.getElementById('activeTabInput');
        if (tabInput) {
            tabInput.value = tabName;
        }

        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        const targetTab = document.getElementById('tab-' + tabName);
        if (targetTab) targetTab.classList.add('active');

        const activeBtn = document.getElementById('tab-btn-' + tabName);
        if (activeBtn) activeBtn.classList.add('active');

        // Handle lazy loading for heavy tabs
        if (tabName === 'endpoints') {
            loadEndpointsData();
        } else if (tabName === 'jsfiles') {
            loadJSFilesData();
        } else if (tabName === 'takeovers') {
            loadTakeoversData();
        } else if (tabName === 'events') {
            loadEventsData();
        }

        // Trigger resize to fix ApexCharts in case they were hidden
        setTimeout(() => {
            window.dispatchEvent(new Event('resize'));
        }, 50);
    }

    // Filter asset table
    function filterTable() {
        const searchInput = document.getElementById('searchInput') ? document.getElementById('searchInput').value.toLowerCase() : '';
        const statusFilter = document.getElementById('statusFilter') ? document.getElementById('statusFilter').value : '';
        const changeFilter = document.getElementById('changeFilter') ? document.getElementById('changeFilter').value : '';
        const resolutionFilter = document.getElementById('resolutionFilter') ? document.getElementById('resolutionFilter').value : '';

        const table = document.getElementById('assetTable');
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

        let visibleCount = 0;
        const totalCount = rows.length;

        for (let row of rows) {
            const cells = row.getElementsByTagName('td');
            if (cells.length === 0) continue;

            const subdomain = cells[1].textContent.toLowerCase();
            const url = cells[2].textContent.toLowerCase();
            const httpStatus = cells[3].textContent.trim();
            const ip = cells[7].textContent.toLowerCase();
            const cname = cells[9].textContent.toLowerCase();
            const dnsStatus = cells[10].textContent.toLowerCase();
            const changeStatus = cells[11].textContent.toLowerCase();

            let show = true;

            // Search filter
            if (searchInput && !subdomain.includes(searchInput) && !ip.includes(searchInput) && !cname.includes(searchInput)) {
                show = false;
            }

            // HTTP Status filter
            if (statusFilter) {
                if (statusFilter === 'none') {
                    if (httpStatus !== '-') show = false;
                } else {
                    if (!httpStatus.startsWith(statusFilter)) show = false;
                }
            }

            // Change filter
            if (changeFilter && !changeStatus.includes(changeFilter)) {
                show = false;
            }

            // Resolution filter
            if (resolutionFilter) {
                if (resolutionFilter === 'resolved' && !dnsStatus.includes('resolved')) {
                    show = false;
                } else if (resolutionFilter === 'unresolved' && dnsStatus.includes('resolved')) {
                    show = false;
                }
            }

            row.style.display = show ? '' : 'none';
            if (show) visibleCount++;
        }

        document.getElementById('visibleRows').textContent = visibleCount;
        document.getElementById('totalRows').textContent = totalCount;
    }

    // Reset filters
    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('changeFilter').value = '';
        document.getElementById('resolutionFilter').value = '';
        // filterTable();
    }

    // Export to CSV
    function exportToCSV() {
        const table = document.getElementById('assetTable');
        const rows = table.querySelectorAll('tr');

        let csv = [];
        for (let row of rows) {
            const cells = row.querySelectorAll('th, td');
            const rowData = Array.from(cells).map(cell => {
                let text = cell.textContent.trim();
                text = text.replace(/"/g, '""'); // Escape quotes
                return `"${text}"`;
            });
            csv.push(rowData.join(','));
        }

        const csvContent = csv.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'assets_export_' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        window.URL.revokeObjectURL(url);
    }

    // ========== NEW ASSETS TAB FUNCTIONS ==========

    // Export assets to CSV
    // Export Assets as CSV
    function exportAssetsToCSV() {
        const search = document.querySelector('input[name="search"]').value;
        const exclude = document.querySelector('input[name="exclude"]').value;
        const statusFilter = document.querySelector('select[name="status_filter"]').value;
        const techFilter = document.querySelector('select[name="tech_filter"]').value;
        const changeFilter = document.querySelector('select[name="change_filter"]').value;

        let url = `/projects/{{ project.id }}/assets/export?`;
        const params = new URLSearchParams();
        if (search) params.append('search', search);
        if (exclude) params.append('exclude', exclude);
        if (statusFilter) params.append('status_filter', statusFilter);
        if (techFilter) params.append('tech_filter', techFilter);
        if (changeFilter) params.append('change_filter', changeFilter);

        window.location.href = url + params.toString();
    }

    // Show screenshot modal
    function showScreenshotModal(url, src) {
        const modal = document.getElementById('screenshotModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalImage = document.getElementById('modalImage');

        modalTitle.textContent = url;
        modalImage.src = src;
        modal.style.display = 'block';
    }

    // Initialize assets table on page load
    // Initialize assets table on page load
    document.addEventListener('DOMContentLoaded', function () {
        // Restore active tab from URL
        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab');
        if (activeTab) {
            switchTab(activeTab);
        }

        if (typeof filterTable === 'function') {
            // filterTable();
        }
    });

    // Show asset changes modal
    function showAssetChanges(subdomain, events) {
        const modal = document.getElementById('assetChangesModal');
        const title = document.getElementById('assetChangesTitle');
        const content = document.getElementById('assetChangesContent');

        title.textContent = `Changes for ${subdomain}`;

        if (!events || events.length === 0) {
            content.innerHTML = '<p class="text-muted">No details available.</p>';
            modal.style.display = 'block';
            return;
        }

        let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';

        events.forEach(event => {
            const isNew = (event.summary && event.summary.includes('New subdomain')) || event.type === 'subdomain_new';
            const icon = isNew ? 'fa-star' : 'fa-history';
            const color = isNew ? 'text-success' : 'text-warning';
            const bgColor = isNew ? '#f0fdf4' : '#fffbeb';
            const borderColor = isNew ? '#bbf7d0' : '#fde68a';

            // Reuse formatEventDetails if available
            let detailsHtml = '';
            if (typeof formatEventDetails === 'function' && event.details) {
                detailsHtml = formatEventDetails(event);
            }

            html += `
                <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; align-items: start;">
                        <span style="font-weight: 600; font-size: 0.875rem; color: #334155; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas ${icon}" style="${isNew ? 'color: #166534;' : 'color: #b45309;'}"></i> ${event.summary}
                        </span>
                        <span style="font-size: 0.75rem; color: #64748b; white-space: nowrap;">${event.created_at}</span>
                    </div>
                    <div style="font-size: 0.875rem;">
                        ${detailsHtml}
                    </div>
                </div>
            `;
        });

        html += '</div>';
        content.innerHTML = html;
        modal.style.display = 'block';
    }

    // Show asset changes modal
    function showAssetChanges(subdomain, events) {
        const modal = document.getElementById('assetChangesModal');
        const title = document.getElementById('assetChangesTitle');
        const content = document.getElementById('assetChangesContent');

        title.textContent = `Changes for ${subdomain}`;

        if (!events || events.length === 0) {
            content.innerHTML = '<p class="text-muted">No details available.</p>';
            modal.style.display = 'block';
            return;
        }

        let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';

        events.forEach(event => {
            const isNew = (event.summary && event.summary.includes('New subdomain')) || event.type === 'subdomain_new';
            const icon = isNew ? 'fa-star' : 'fa-history';
            const color = isNew ? 'text-success' : 'text-warning';
            const bgColor = isNew ? '#f0fdf4' : '#fffbeb';
            const borderColor = isNew ? '#bbf7d0' : '#fde68a';

            // Reuse formatEventDetails if available
            let detailsHtml = '';
            if (typeof formatEventDetails === 'function' && event.details) {
                detailsHtml = formatEventDetails(event);
            }

            html += `
                <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; align-items: start;">
                        <span style="font-weight: 600; font-size: 0.875rem; color: #334155; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas ${icon}" style="${isNew ? 'color: #166534;' : 'color: #b45309;'}"></i> ${event.summary}
                        </span>
                        <span style="font-size: 0.75rem; color: #64748b; white-space: nowrap;">${event.created_at}</span>
                    </div>
                    <div style="font-size: 0.875rem;">
                        ${detailsHtml}
                    </div>
                </div>
            `;
        });

        html += '</div>';
        content.innerHTML = html;
        modal.style.display = 'block';
    }

    // ========== END NEW ASSETS TAB FUNCTIONS ==========

    // Endpoint Pagination State
    let endpointCurrentPage = 1;
    let endpointFilteredRows = [];

    // Filter endpoints
    function filterEndpoints() {
        const searchInput = document.getElementById('endpointSearch').value.toLowerCase();
        const typeFilter = document.getElementById('endpointTypeFilter').value;
        const statusFilter = document.getElementById('endpointStatusFilter').value;

        const rows = document.querySelectorAll('#endpointTableBody tr');
        endpointFilteredRows = [];
        let totalCount = 0;

        for (let row of rows) {
            totalCount++;
            const url = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
            const type = row.getAttribute('data-type');
            const categories = row.getAttribute('data-categories') || '';
            const status = row.getAttribute('data-status') || '';

            let show = true;

            // Search filter
            if (searchInput && !url.includes(searchInput)) {
                show = false;
            }

            // Type filter (includes category filtering)
            if (typeFilter) {
                if (typeFilter === 'sensitive') {
                    if (type !== 'sensitive') show = false;
                } else if (typeFilter === 'api' || typeFilter === 'other') {
                    if (type !== typeFilter) show = false;
                } else {
                    // Category-specific filter (backup, dev, file, config, etc.)
                    if (!categories.includes(typeFilter)) show = false;
                }
            }

            // Status filter
            if (statusFilter) {
                if (statusFilter === 'none') {
                    if (status !== '') show = false;
                } else if (statusFilter === '200') {
                    if (status !== '200') show = false;
                } else if (statusFilter === '300') {
                    if (!status.startsWith('3')) show = false;
                } else if (statusFilter === '400') {
                    if (!status.startsWith('4')) show = false;
                } else if (statusFilter === '500') {
                    if (!status.startsWith('5')) show = false;
                }
            }

            if (show) {
                endpointFilteredRows.push(row);
            }
        }

        // Update stats
        document.getElementById('endpointVisibleCount').textContent = endpointFilteredRows.length;
        document.getElementById('endpointTotalCount').textContent = totalCount;

        // Reset to page 1 when filters change
        endpointCurrentPage = 1;
        updateEndpointPagination();
    }

    // Update endpoint pagination
    function updateEndpointPagination() {
        const pageSize = document.getElementById('endpointPageSize').value;
        const totalRows = endpointFilteredRows.length;

        // Hide all rows first
        const allRows = document.querySelectorAll('#endpointTableBody tr');
        allRows.forEach(row => row.style.display = 'none');

        let displayRows = endpointFilteredRows;
        let totalPages = 1;
        let start = 0;
        let end = totalRows;

        if (pageSize !== 'all') {
            const size = parseInt(pageSize);
            totalPages = Math.ceil(totalRows / size);

            // Ensure current page is valid
            if (endpointCurrentPage > totalPages) endpointCurrentPage = totalPages;
            if (endpointCurrentPage < 1) endpointCurrentPage = 1;

            start = (endpointCurrentPage - 1) * size;
            end = Math.min(start + size, totalRows);
            displayRows = endpointFilteredRows.slice(start, end);
        }

        // Show paginated rows
        displayRows.forEach(row => row.style.display = '');

        // Update pagination info
        document.getElementById('endpointShowingStart').textContent = totalRows > 0 ? start + 1 : 0;
        document.getElementById('endpointShowingEnd').textContent = end;
        document.getElementById('endpointShowingTotal').textContent = totalRows;
        document.getElementById('endpointPageInfo').textContent = `Page ${endpointCurrentPage} of ${totalPages}`;

        // Update button states
        document.getElementById('endpointPrevBtn').disabled = endpointCurrentPage <= 1;
        document.getElementById('endpointNextBtn').disabled = endpointCurrentPage >= totalPages;
    }

    // Change endpoint page
    function changeEndpointPage(delta) {
        endpointCurrentPage += delta;
        updateEndpointPagination();
    }

    // Reset endpoint filters
    function resetEndpointFilters() {
        document.getElementById('endpointSearch').value = '';
        document.getElementById('endpointTypeFilter').value = '';
        document.getElementById('endpointStatusFilter').value = '';
        document.getElementById('endpointPageSize').value = '50';
        filterEndpoints();
    }

    // Initialize endpoint filters on page load
    document.addEventListener('DOMContentLoaded', function () {
        if (document.getElementById('endpointTableBody')) {
            filterEndpoints();
        }
    });

    // JS Files Pagination State
    let jsFileCurrentPage = 1;
    let jsFileFilteredRows = [];

    // Filter JS Files
    function filterJSFiles() {
        const searchInput = document.getElementById('jsFileSearch').value.toLowerCase();
        const statusFilter = document.getElementById('jsFileStatusFilter').value;
        const secretsFilter = document.getElementById('jsFileSecretsFilter').value;

        const rows = document.querySelectorAll('#jsFileTableBody tr');
        jsFileFilteredRows = [];
        let totalCount = 0;
        let secretsCount = 0;

        for (let row of rows) {
            totalCount++;
            const url = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
            const status = row.getAttribute('data-status');
            const secrets = row.getAttribute('data-secrets');

            let show = true;

            if (searchInput && !url.includes(searchInput)) {
                show = false;
            }

            if (statusFilter && status !== statusFilter) {
                show = false;
            }

            if (secretsFilter && secrets !== secretsFilter) {
                show = false;
            }

            if (show) {
                jsFileFilteredRows.push(row);
                if (secrets === 'suspicious') secretsCount++;
            }
        }

        // Update stats
        document.getElementById('jsFileVisibleCount').textContent = jsFileFilteredRows.length;
        document.getElementById('jsFileTotalCount').textContent = totalCount;

        const secretsCountEl = document.getElementById('jsFileSecretsCount');
        if (secretsCount > 0) {
            secretsCountEl.innerHTML = `(<i class="fas fa-exclamation-triangle"></i> ${secretsCount} with secrets)`;
        } else {
            secretsCountEl.innerHTML = '';
        }

        // Reset to page 1 when filters change
        jsFileCurrentPage = 1;
        updateJSFilePagination();
    }

    // Update JS file pagination
    function updateJSFilePagination() {
        const pageSize = document.getElementById('jsFilePageSize').value;
        const totalRows = jsFileFilteredRows.length;

        // Hide all rows first
        const allRows = document.querySelectorAll('#jsFileTableBody tr');
        allRows.forEach(row => row.style.display = 'none');

        let displayRows = jsFileFilteredRows;
        let totalPages = 1;
        let start = 0;
        let end = totalRows;

        if (pageSize !== 'all') {
            const size = parseInt(pageSize);
            totalPages = Math.ceil(totalRows / size);

            // Ensure current page is valid
            if (jsFileCurrentPage > totalPages) jsFileCurrentPage = totalPages;
            if (jsFileCurrentPage < 1) jsFileCurrentPage = 1;

            start = (jsFileCurrentPage - 1) * size;
            end = Math.min(start + size, totalRows);
            displayRows = jsFileFilteredRows.slice(start, end);
        }

        // Show paginated rows
        displayRows.forEach(row => row.style.display = '');

        // Update pagination info
        document.getElementById('jsFileShowingStart').textContent = totalRows > 0 ? start + 1 : 0;
        document.getElementById('jsFileShowingEnd').textContent = end;
        document.getElementById('jsFileShowingTotal').textContent = totalRows;
        document.getElementById('jsFilePageInfo').textContent = `Page ${jsFileCurrentPage} of ${totalPages}`;

        // Update button states
        document.getElementById('jsFilePrevBtn').disabled = jsFileCurrentPage <= 1;
        document.getElementById('jsFileNextBtn').disabled = jsFileCurrentPage >= totalPages;
    }

    // Change JS file page
    function changeJSFilePage(delta) {
        jsFileCurrentPage += delta;
        updateJSFilePagination();
    }

    // Reset JS file filters
    function resetJSFileFilters() {
        document.getElementById('jsFileSearch').value = '';
        document.getElementById('jsFileStatusFilter').value = '';
        document.getElementById('jsFileSecretsFilter').value = '';
        document.getElementById('jsFilePageSize').value = '50';
        filterJSFiles();
    }

    // Initialize JS file filters on page load
    document.addEventListener('DOMContentLoaded', function () {
        if (document.getElementById('jsFileTableBody')) {
            filterJSFiles();
        }
    });

    // Analyze JS File
    function analyzeJSFile(url) {
        showToast('Opening JS file analysis...', 'info');
        // You can integrate with a service like JSNice, or download and analyze locally
        window.open(url, '_blank');
    }

    // Copy to clipboard
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast('URL copied to clipboard!', 'success');
        }).catch(err => {
            showToast('Failed to copy URL', 'error');
            console.error('Copy failed:', err);
        });
    }

    // Show secret details
    function showSecretDetails(button) {
        const row = button.closest('tr');
        const url = row.querySelector('td:nth-child(3) a').href;
        const secretsInfo = JSON.parse(row.getAttribute('data-secrets-info') || '{}');

        // Create modal to show secret findings
        const modal = document.createElement('div');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;';

        const content = document.createElement('div');
        content.style.cssText = 'background: white; padding: 2rem; border-radius: 8px; max-width: 700px; max-height: 80vh; overflow-y: auto;';

        // Build secrets found section
        let secretsFoundHTML = '';
        if (secretsInfo.secrets_found && secretsInfo.secrets_found.length > 0) {
            secretsFoundHTML = '<h4 style="color: #dc3545; margin-top: 1rem;"><i class="fas fa-exclamation-triangle"></i> Secrets Detected</h4>';
            secretsFoundHTML += '<table class="table" style="margin-top: 0.5rem;">';
            secretsFoundHTML += '<thead><tr><th>Type</th><th>Count</th><th>Severity</th></tr></thead><tbody>';

            secretsInfo.secrets_found.forEach(secret => {
                let severity = 'HIGH';
                let severityColor = '#dc3545';

                if (secret.type.includes('generic') || secret.type.includes('authorization')) {
                    severity = 'MEDIUM';
                    severityColor = '#ffc107';
                }

                secretsFoundHTML += `
                <tr>
                    <td><code>${secret.type.replace(/_/g, ' ').toUpperCase()}</code></td>
                    <td><strong>${secret.count}</strong></td>
                    <td><span style="color: ${severityColor}; font-weight: bold;">${severity}</span></td>
                </tr>
            `;
            });

            secretsFoundHTML += '</tbody></table>';
        }

        // Build suspicious keywords section
        let keywordsHTML = '';
        if (secretsInfo.suspicious_keywords && secretsInfo.suspicious_keywords.length > 0) {
            keywordsHTML = '<h4 style="color: #ffc107; margin-top: 1rem;"><i class="fas fa-search"></i> Suspicious Keywords</h4>';
            keywordsHTML += '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">';

            secretsInfo.suspicious_keywords.forEach(keyword => {
                keywordsHTML += `<span class="badge badge-warning">${keyword}</span>`;
            });

            keywordsHTML += '</div>';
        }

        // Risk level badge
        let riskBadge = '';
        if (secretsInfo.risk_level === 'high') {
            riskBadge = '<span class="badge badge-danger" style="font-size: 1rem; padding: 0.5rem 1rem;">üî¥ HIGH RISK</span>';
        } else if (secretsInfo.risk_level === 'medium') {
            riskBadge = '<span class="badge badge-warning" style="font-size: 1rem; padding: 0.5rem 1rem;">üü† MEDIUM RISK</span>';
        } else if (secretsInfo.risk_level === 'low') {
            riskBadge = '<span class="badge badge-info" style="font-size: 1rem; padding: 0.5rem 1rem;">üü° LOW RISK</span>';
        }

        content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <h3 style="margin: 0; color: #dc3545;">
                <i class="fas fa-key"></i> Secret Detection Report
            </h3>
            ${riskBadge}
        </div>
        <p style="word-break: break-all; background: #f8f9fa; padding: 0.75rem; border-radius: 4px; font-family: monospace; font-size: 0.85rem; border: 1px solid #dee2e6;">
            ${url}
        </p>

        ${secretsFoundHTML}
        ${keywordsHTML}

        <div style="background: ${secretsInfo.risk_level === 'high' ? '#f8d7da' : '#fff3cd'}; border-left: 4px solid ${secretsInfo.risk_level === 'high' ? '#dc3545' : '#ffc107'}; padding: 1rem; margin: 1rem 0;">
            <strong>‚ö†Ô∏è ${secretsInfo.risk_level === 'high' ? 'CRITICAL' : 'WARNING'}:</strong>
            ${secretsInfo.risk_level === 'high'
                ? 'This file contains patterns matching known secret formats.'
                : 'This file contains suspicious keywords that might indicate secrets.'
            }
            <br><br>
            <strong>Immediate Actions Required:</strong>
            <ul style="margin: 0.5rem 0 0 0;">
                <li>Download and verify if the detected patterns are actual secrets</li>
                <li>If confirmed, rotate all exposed credentials <strong>immediately</strong></li>
                <li>Remove sensitive data from the codebase</li>
                <li>Use environment variables or secret management systems</li>
                <li>Scan git history to ensure secrets were never committed</li>
            </ul>
        </div>

        <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
            <a href="${url}" target="_blank" class="btn btn-primary">
                <i class="fas fa-external-link-alt"></i> Open File
            </a>
            <button class="btn btn-secondary" onclick="copyToClipboard('${url}')">
                <i class="fas fa-copy"></i> Copy URL
            </button>
            <button class="btn btn-secondary" onclick="this.closest('div[style*=\\'position: fixed\\']').remove()">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    `;

        modal.appendChild(content);
        document.body.appendChild(modal);

        // Close on background click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    // triggerScan is now handled by shared ScanModal module from _partials/scan_modal.html

    // Show asset changes modal
    function showAssetChanges(subdomain, events) {
        const modal = document.getElementById('assetChangesModal');
        const title = document.getElementById('assetChangesTitle');
        const content = document.getElementById('assetChangesContent');

        title.textContent = `Changes for ${subdomain}`;

        if (!events || events.length === 0) {
            content.innerHTML = '<p class="text-muted">No details available.</p>';
            modal.style.display = 'block';
            return;
        }

        let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';

        events.forEach(event => {
            const isNew = (event.summary && event.summary.includes('New subdomain')) || event.type === 'subdomain_new';
            const icon = isNew ? 'fa-star' : 'fa-history';
            const color = isNew ? 'text-success' : 'text-warning';
            const bgColor = isNew ? '#f0fdf4' : '#fffbeb';
            const borderColor = isNew ? '#bbf7d0' : '#fde68a';

            // Reuse formatEventDetails if available
            let detailsHtml = '';
            if (typeof formatEventDetails === 'function' && event.details) {
                detailsHtml = formatEventDetails(event);
            }

            html += `
                <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; align-items: start;">
                        <span style="font-weight: 600; font-size: 0.875rem; color: #334155; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas ${icon}" style="${isNew ? 'color: #166534;' : 'color: #b45309;'}"></i> ${event.summary}
                        </span>
                        <span style="font-size: 0.75rem; color: #64748b; white-space: nowrap;">${event.created_at}</span>
                    </div>
                    <div style="font-size: 0.875rem;">
                        ${detailsHtml}
                    </div>
                </div>
            `;
        });

        html += '</div>';
        content.innerHTML = html;
        modal.style.display = 'block';
    }

    // Initialize stats on page load
    document.addEventListener('DOMContentLoaded', () => {
        // filterTable(); // Initialize counts for JS Files table
        // All Assets pagination is now handled server-side
    });

    // ============ Scan Mode Modal ============
    // Now handled by shared ScanModal module from _partials/scan_modal.html

    // ============ Report Generation ============
    function openReportModal(projectId) {
        const modal = document.getElementById('reportModal');
        document.getElementById('reportProjectId').value = projectId;
        modal.style.display = 'block';
    }

    function closeReportModal() {
        document.getElementById('reportModal').style.display = 'none';
    }

    function generateReport() {
        const projectId = document.getElementById('reportProjectId').value;
        const format = document.getElementById('reportFormat').value;

        // Gather selected sections
        const sections = {
            executive_summary: document.getElementById('section-summary').checked,
            subdomains: document.getElementById('section-subdomains').checked,
            dns_records: document.getElementById('section-dns').checked,
            http_endpoints: document.getElementById('section-http').checked,
            vulnerabilities: document.getElementById('section-vulns').checked,
            scan_history: document.getElementById('section-scans').checked
        };

        // Gather company info
        const company = {
            name: document.getElementById('company-name').value || '',
            website: document.getElementById('company-website').value || '',
            email: document.getElementById('company-email').value || ''
        };

        const btn = document.querySelector('#reportModal .btn-primary');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
        btn.disabled = true;

        // Step 1: Start report generation (async)
        fetch('/api/reports/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                project_ids: [parseInt(projectId)],
                format: format,
                sections: sections,
                company: company
            })
        })
            .then(response => {
                if (!response.ok) throw new Error('Report generation failed to start');
                return response.json();
            })
            .then(data => {
                const jobId = data.job_id;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

                // Step 2: Poll for completion
                pollReportStatus(jobId, btn, originalText, format, projectId);
            })
            .catch(err => {
                showToast('Failed to start report generation: ' + err.message, 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }

    function pollReportStatus(jobId, btn, originalText, format, projectId) {
        let pollCount = 0;
        const maxPolls = 120; // 2 minutes max (1 poll per second)

        const pollInterval = setInterval(() => {
            pollCount++;

            fetch(`/api/reports/status/${jobId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'completed') {
                        clearInterval(pollInterval);
                        btn.innerHTML = '<i class="fas fa-download"></i> Downloading...';

                        // Download the report
                        window.location.href = `/api/reports/download/${jobId}`;

                        setTimeout(() => {
                            closeReportModal();
                            showToast('Report downloaded successfully!', 'success');
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }, 1000);

                    } else if (data.status === 'failed') {
                        clearInterval(pollInterval);
                        showToast('Report generation failed: ' + (data.error || 'Unknown error'), 'error');
                        btn.innerHTML = originalText;
                        btn.disabled = false;

                    } else if (pollCount >= maxPolls) {
                        clearInterval(pollInterval);
                        showToast('Report generation timed out. Please try again.', 'error');
                        btn.innerHTML = originalText;
                        btn.disabled = false;

                    } else {
                        // Still processing - update button text
                        const elapsed = pollCount;
                        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Generating... (${elapsed}s)`;
                    }
                })
                .catch(err => {
                    clearInterval(pollInterval);
                    showToast('Failed to check report status', 'error');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        }, 1000); // Poll every 1 second
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        const reportModal = document.getElementById('reportModal');
        const scanModal = document.getElementById('scanModal');
        if (event.target === reportModal) {
            reportModal.style.display = 'none';
        }
        if (event.target === scanModal) {
            scanModal.style.display = 'none';
        }
    }


</script>

<!-- Scan Modal - now included from shared partial -->
{% include '_partials/scan_modal.html' %}

<!-- Report Modal -->
<div id="reportModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3><i class="fas fa-file-alt"></i> Generate Report</h3>
            <button class="close-btn" onclick="closeReportModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="reportProjectId" value="">

            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Report Format</label>
                <select id="reportFormat"
                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.375rem;">
                    <option value="pdf">PDF Document</option>
                    <option value="html">HTML File</option>
                </select>
            </div>

            <!-- Company Info (for cover page) -->
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">
                    <i class="fas fa-building" style="margin-right: 0.25rem;"></i> Company Info (Cover Page)
                </label>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <input type="text" id="company-name" placeholder="Company Name"
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.375rem;">
                    <input type="text" id="company-website" placeholder="Website (e.g., https://example.com)"
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.375rem;">
                    <input type="email" id="company-email" placeholder="Email (e.g., contact@example.com)"
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.375rem;">
                </div>
            </div>

            <div class="form-group">
                <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Include Sections</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="section-summary" checked>
                        <span>Executive Summary</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="section-subdomains" checked>
                        <span>Subdomains</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="section-dns" checked>
                        <span>DNS Records</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="section-http" checked>
                        <span>HTTP Endpoints</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="section-vulns" checked>
                        <span>Vulnerabilities</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="section-scans" checked>
                        <span>Scan History</span>
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer"
            style="display: flex; justify-content: flex-end; gap: 0.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
            <button class="btn btn-secondary" onclick="closeReportModal()">Cancel</button>
            <button class="btn btn-primary" onclick="generateReport()">
                <i class="fas fa-download"></i> Download Report
            </button>
        </div>
    </div>
</div>

{% include '_ajax_endpoints_jsfiles.html' %}

{% include '_ajax_takeovers_events.html' %}

{% endblock %}