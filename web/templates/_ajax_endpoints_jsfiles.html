<style>
    @keyframes skeleton {
        0% {
            background-position: 200% 0;
        }

        100% {
            background-position: -200% 0;
        }
    }
</style>
<script>
    // State management for Endpoints and JS Files tabs
    const endpointsState = {
        loaded: false,
        currentPage: 1,
        perPage: 100,
        clientPerPage: 100,  // Items per page on client-side
        search: '',
        exclude: '',
        category: '',
        status: '',
        cachedData: null,  // Cache all loaded endpoints
        totalPages: 1
    };

    const jsfilesState = {
        loaded: false,
        currentPage: 1,
        perPage: 100,
        clientPerPage: 100,
        search: '',
        exclude: '',
        statusFilter: '',
        secretsFilter: '',
        cachedData: null,
        totalPages: 1
    };

    // Load Endpoints data via AJAX
    async function loadEndpointsData(forceReload = false) {
        // Show loading header if first load
        if (!endpointsState.loaded) {
            showEndpointsLoading();
        } else {
            // If navigating, show loading overlay or keep content but opacity reduced
            document.getElementById('endpoints-content').style.opacity = '0.5';
        }

        const params = new URLSearchParams({
            page: endpointsState.currentPage,
            per_page: endpointsState.perPage,
            search: endpointsState.search,
            exclude: endpointsState.exclude,
            category: endpointsState.category,
            status: endpointsState.status
        });

        try {
            const response = await fetch(`/api/projects/{{ project.id }}/endpoints?${params}`);
            const data = await response.json();

            document.getElementById('endpoints-content').style.opacity = '1.0';

            if (!data.has_data) {
                document.getElementById('endpoints-loading').style.display = 'none';
                document.getElementById('endpoints-empty').style.display = 'block';
                return;
            }

            // Update state total pages from server calculation
            endpointsState.totalPages = data.total_pages;

            // Update last scan date
            if (data.snapshot_date) {
                document.getElementById('endpoints-last-scan').textContent = formatDate(data.snapshot_date);
            }

            // Render table directly with server data
            renderEndpointsTable(data);
            renderEndpointsPagination(data);

            document.getElementById('endpoints-loading').style.display = 'none';
            document.getElementById('endpoints-content').style.display = 'block';

            endpointsState.loaded = true;
        } catch (error) {
            console.error('Error loading endpoints:', error);
            document.getElementById('endpoints-content').style.opacity = '1.0';
            document.getElementById('endpoints-loading').innerHTML = `
            <div style="text-align: center; padding: 3rem;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc2626; margin-bottom: 1rem;"></i>
                <h3 style="color: #64748b;">Failed to Load Endpoints</h3>
                <p style="color: #94a3b8;">${error.message}</p>
                <button onclick="loadEndpointsData(true)" style="margin-top: 1rem; padding: 0.625rem 1.25rem; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-redo"></i> Retry
                </button>
            </div>
        `;
        }
    }

    // Render endpoints from cached data (DEPRECATED - Removed in favor of Server Side Pagination)
    // kept as empty function if referenced elsewhere, but logic moved to renderEndpointsTable
    function renderEndpointsFromCache() {
        // This function is no longer used as pagination is now server-side.
        // Its previous logic has been integrated directly into loadEndpointsData.
    }

    // Show loading with skeleton effect
    function showEndpointsLoading() {
        const loadingEl = document.getElementById('endpoints-loading');
        loadingEl.style.display = 'block';
        loadingEl.innerHTML = `
        <div style="padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div style="height: 24px; width: 200px; background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: skeleton 1.5s ease-in-out infinite; border-radius: 4px;"></div>
                <div style="height: 20px; width: 150px; background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: skeleton 1.5s ease-in-out infinite; border-radius: 4px;"></div>
            </div>
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                ${[1, 2, 3, 4, 5].map(() => `
                    <div style="display: flex; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid #f1f5f9;">
                        <div style="height: 20px; width: 40px; background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: skeleton 1.5s ease-in-out infinite; border-radius: 4px;"></div>
                        <div style="height: 20px; width: 80px; background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: skeleton 1.5s ease-in-out infinite; border-radius: 4px;"></div>
                        <div style="height: 20px; flex: 1; background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: skeleton 1.5s ease-in-out infinite; border-radius: 4px;"></div>
                        <div style="height: 20px; width: 150px; background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: skeleton 1.5s ease-in-out infinite; border-radius: 4px;"></div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    }



    // Render Endpoints table
    function renderEndpointsTable(data, baseIndex = 0) {
        const tbody = document.getElementById('endpoints-table-body');
        tbody.innerHTML = '';

        if (data.endpoints.length === 0) {
            tbody.innerHTML = `
            <tr>
                <td colspan="5" style="padding: 3rem; text-align: center; color: #94a3b8;">
                    <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>
                    No endpoints found matching your filters
                </td>
            </tr>
        `;
            document.getElementById('endpoints-count-display').textContent = '0 endpoints';
            return;
        }

        data.endpoints.forEach((endpoint, index) => {
            const row = document.createElement('tr');
            row.style.borderBottom = '1px solid #f1f5f9';
            row.style.transition = 'background 0.2s';
            row.onmouseover = () => row.style.background = '#f8fafc';
            row.onmouseout = () => row.style.background = 'white';

            const startIndex = (data.page - 1) * data.per_page + index + 1;

            // Status badge
            let statusBadge = '<span style="padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; background: #f1f5f9; color: #64748b;">-</span>';
            if (endpoint.status_code) {
                if (endpoint.status_code < 300) {
                    statusBadge = `<span style="padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; background: #dcfce7; color: #166534;">${endpoint.status_code}</span>`;
                } else if (endpoint.status_code < 400) {
                    statusBadge = `<span style="padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; background: #dbeafe; color: #1e40af;">${endpoint.status_code}</span>`;
                } else if (endpoint.status_code < 500) {
                    statusBadge = `<span style="padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; background: #fef3c7; color: #92400e;">${endpoint.status_code}</span>`;
                } else {
                    statusBadge = `<span style="padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; background: #fee2e2; color: #991b1b;">${endpoint.status_code}</span>`;
                }
            }

            // Categories badges
            let categoriesBadges = '<span style="color: #94a3b8;">-</span>';
            if (endpoint.categories && endpoint.categories.length > 0) {
                categoriesBadges = endpoint.categories.map(cat =>
                    `<span style="padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.7rem; font-weight: 600; background-color: ${cat.color}; color: white; margin: 2px; display: inline-block;">
                    <i class="fas ${cat.icon}"></i> ${cat.name}
                </span>`
                ).join('');
            }

            row.innerHTML = `
            <td style="padding: 1rem; color: #64748b; font-size: 0.875rem;">${startIndex}</td>
            <td style="padding: 1rem;">${statusBadge}</td>
            <td style="padding: 1rem;">${categoriesBadges}</td>
            <td style="padding: 1rem;">
                <a href="${endpoint.url}" target="_blank" style="color: #667eea; text-decoration: none; font-family: monospace; font-size: 0.875rem; word-break: break-all; display: inline-flex; align-items: center; gap: 0.25rem;"
                   onmouseover="this.style.textDecoration='underline'"
                   onmouseout="this.style.textDecoration='none'">
                    ${endpoint.url}
                    <i class="fas fa-external-link-alt" style="font-size: 0.7rem; opacity: 0.6;"></i>
                </a>
            </td>
            <td style="padding: 1rem; max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${endpoint.title || ''}">
                ${endpoint.title || '<span style="color: #94a3b8;">-</span>'}
            </td>
        `;

            tbody.appendChild(row);
        });

        // Update counters
        // Update counters
        // Force update using querySelector for robustness
        const countDisplay = document.querySelector('#endpoints-count-display');
        if (countDisplay) {
            countDisplay.innerText = `${data.total} endpoint${data.total !== 1 ? 's' : ''}`;
        } else {
            console.error('Could not find endpoints-count-display');
        }
        document.getElementById('endpoints-showing-start').textContent = data.showing_start;
        document.getElementById('endpoints-showing-end').textContent = data.showing_end;
        document.getElementById('endpoints-total').textContent = data.total;
    }

    // Render Endpoints pagination
    function renderEndpointsPagination(data) {
        const container = document.getElementById('endpoints-pagination');
        container.innerHTML = '';

        if (data.total_pages <= 1) return;

        // Previous button
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i> Prev';
        prevBtn.style.cssText = 'padding: 0.5rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; color: #475569; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.2s;';
        prevBtn.disabled = data.page === 1;
        if (prevBtn.disabled) {
            prevBtn.style.opacity = '0.5';
            prevBtn.style.cursor = 'not-allowed';
        }
        prevBtn.onclick = () => gotoEndpointsPage(data.page - 1);
        container.appendChild(prevBtn);

        // Page numbers
        const maxPages = 5;
        let startPage = Math.max(1, data.page - Math.floor(maxPages / 2));
        let endPage = Math.min(data.total_pages, startPage + maxPages - 1);

        if (endPage - startPage < maxPages - 1) {
            startPage = Math.max(1, endPage - maxPages + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.textContent = i;
            pageBtn.style.cssText = 'padding: 0.5rem 0.875rem; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.2s;';

            if (i === data.page) {
                pageBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                pageBtn.style.color = 'white';
                pageBtn.style.borderColor = '#667eea';
            } else {
                pageBtn.style.background = 'white';
                pageBtn.style.color = '#475569';
            }

            pageBtn.onclick = () => gotoEndpointsPage(i);
            container.appendChild(pageBtn);
        }

        // Next button
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
        nextBtn.style.cssText = 'padding: 0.5rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; color: #475569; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.2s;';
        nextBtn.disabled = data.page === data.total_pages;
        if (nextBtn.disabled) {
            nextBtn.style.opacity = '0.5';
            nextBtn.style.cursor = 'not-allowed';
        }
        nextBtn.onclick = () => gotoEndpointsPage(data.page + 1);
        container.appendChild(nextBtn);
    }

    // Navigate to Endpoints page
    function gotoEndpointsPage(page) {
        endpointsState.currentPage = page;

        // Smooth scroll to top of table
        document.getElementById('endpoints-content').scrollIntoView({ behavior: 'smooth', block: 'start' });

        loadEndpointsData();
    }

    // Apply Endpoints filters
    function applyEndpointsFilters() {
        endpointsState.search = document.getElementById('endpoints-search').value.trim();
        endpointsState.exclude = document.getElementById('endpoints-exclude').value.trim();
        endpointsState.category = document.getElementById('endpoints-category').value;
        endpointsState.status = document.getElementById('endpoints-status').value;
        endpointsState.perPage = parseInt(document.getElementById('endpoints-per-page').value);
        endpointsState.currentPage = 1;
        endpointsState.loaded = false;
        endpointsState.cachedData = null;  // Clear cache to reload with new filters

        // Show loading
        document.getElementById('endpoints-content').style.display = 'none';
        showEndpointsLoading();

        loadEndpointsData();
    }

    // Reset Endpoints filters
    function resetEndpointsFilters() {
        document.getElementById('endpoints-search').value = '';
        document.getElementById('endpoints-exclude').value = '';
        document.getElementById('endpoints-category').value = '';
        document.getElementById('endpoints-status').value = '';
        document.getElementById('endpoints-per-page').value = '100';
        applyEndpointsFilters();
    }

    // Load JS Files data via AJAX
    async function loadJSFilesData() {
        if (jsfilesState.loaded) {
            document.getElementById('jsfiles-loading').style.display = 'none';
            document.getElementById('jsfiles-content').style.display = 'block';
            return;
        }

        const params = new URLSearchParams({
            page: jsfilesState.currentPage,
            per_page: jsfilesState.perPage,
            per_page: jsfilesState.perPage,
            search: jsfilesState.search,
            exclude: jsfilesState.exclude,
            status_filter: jsfilesState.statusFilter,
            secrets_filter: jsfilesState.secretsFilter
        });

        try {
            const response = await fetch(`/api/projects/{{ project.id }}/jsfiles?${params}`);
            const data = await response.json();

            // Cache data for details view
            jsfilesState.cachedData = data;

            if (!data.has_data) {
                document.getElementById('jsfiles-loading').style.display = 'none';
                document.getElementById('jsfiles-empty').style.display = 'block';
                return;
            }

            renderJSFilesTable(data);
            renderJSFilesPagination(data);

            // Update last scan date
            if (data.snapshot_date) {
                document.getElementById('jsfiles-last-scan').textContent = formatDate(data.snapshot_date);
            }

            // Show secrets alert if any
            if (data.secrets_count > 0) {
                document.getElementById('jsfiles-secrets-count').textContent = data.secrets_count;
                document.getElementById('jsfiles-secrets-alert').style.display = 'block';
            } else {
                document.getElementById('jsfiles-secrets-alert').style.display = 'none';
            }

            document.getElementById('jsfiles-loading').style.display = 'none';
            document.getElementById('jsfiles-content').style.display = 'block';

            jsfilesState.loaded = true;
        } catch (error) {
            console.error('Error loading JS files:', error);
            document.getElementById('jsfiles-loading').innerHTML = `
            <div style="text-align: center; padding: 3rem;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc2626; margin-bottom: 1rem;"></i>
                <h3 style="color: #64748b;">Failed to Load JS Files</h3>
                <p style="color: #94a3b8;">${error.message}</p>
                <button onclick="loadJSFilesData()" style="margin-top: 1rem; padding: 0.625rem 1.25rem; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-redo"></i> Retry
                </button>
            </div>
        `;
        }
    }

    // Render JS Files table
    function renderJSFilesTable(data) {
        const tbody = document.getElementById('jsfiles-table-body');
        tbody.innerHTML = '';

        if (data.js_files.length === 0) {
            tbody.innerHTML = `
            <tr>
                <td colspan="5" style="padding: 3rem; text-align: center; color: #94a3b8;">
                    <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>
                    No JS files found matching your filters
                </td>
            </tr>
        `;
            document.getElementById('jsfiles-count-display').textContent = '0 files';
            return;
        }

        data.js_files.forEach((file, index) => {
            const row = document.createElement('tr');
            row.style.borderBottom = '1px solid #fef3c7';
            row.style.transition = 'background 0.2s';
            row.onmouseover = () => row.style.background = '#fffbeb';
            row.onmouseout = () => row.style.background = 'white';

            const startIndex = (data.page - 1) * data.per_page + index + 1;

            // Status badge
            let statusBadge = '';
            if (file.status === 'active') {
                statusBadge = '<span style="padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; background: #dcfce7; color: #166534;"><i class="fas fa-check-circle"></i> Active</span>';
            } else if (file.status === 'inactive') {
                statusBadge = '<span style="padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; background: #fee2e2; color: #991b1b;"><i class="fas fa-times-circle"></i> Inactive</span>';
            } else {
                statusBadge = '<span style="padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; background: #f1f5f9; color: #64748b;"><i class="fas fa-question-circle"></i> Unknown</span>';
            }

            // Secrets badge
            let secretsBadge = '';
            if (file.has_secrets) {
                if (file.risk_level === 'high') {
                    secretsBadge = '<span style="padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; background: #fee2e2; color: #991b1b;"><i class="fas fa-skull-crossbones"></i> High Risk</span>';
                } else if (file.risk_level === 'medium') {
                    secretsBadge = '<span style="padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; background: #fef3c7; color: #92400e;"><i class="fas fa-exclamation-triangle"></i> Medium</span>';
                } else {
                    secretsBadge = '<span style="padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; background: #fed7aa; color: #78350f;"><i class="fas fa-exclamation-circle"></i> Low Risk</span>';
                }
            } else {
                secretsBadge = '<span style="padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; background: #dcfce7; color: #166534;"><i class="fas fa-shield-check"></i> Clean</span>';
            }

            row.innerHTML = `
            <td style="padding: 1rem; color: #64748b; font-size: 0.875rem;">${startIndex}</td>
            <td style="padding: 1rem;">${statusBadge}</td>
            <td style="padding: 1rem;">
                <a href="${file.url}" target="_blank" style="color: #f59e0b; text-decoration: none; font-family: monospace; font-size: 0.875rem; word-break: break-all; display: inline-flex; align-items: center; gap: 0.25rem;"
                   onmouseover="this.style.textDecoration='underline'"
                   onmouseout="this.style.textDecoration='none'">
                    ${file.url}
                    <i class="fas fa-external-link-alt" style="font-size: 0.7rem; opacity: 0.6;"></i>
                </a>
            </td>
            <td style="padding: 1rem;">${secretsBadge}</td>
            <td style="padding: 1rem; white-space: nowrap;">
                <button onclick="copyToClipboard('${file.url.replace(/'/g, "\\'")}') "
                        style="padding: 0.375rem 0.75rem; background: white; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600; color: #475569; transition: all 0.2s; margin-right: 0.5rem;"
                        onmouseover="this.style.borderColor='#f59e0b'; this.style.color='#f59e0b'"
                        onmouseout="this.style.borderColor='#e2e8f0'; this.style.color='#475569'"
                        title="Copy URL">
                    <i class="fas fa-copy"></i>
                </button>
                ${file.has_secrets ? `
                <button onclick="showJSFileDetail(${index})"
                        style="padding: 0.375rem 0.75rem; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600; transition: transform 0.2s;"
                        onmouseover="this.style.transform='scale(1.05)'"
                        onmouseout="this.style.transform='scale(1)'"
                        title="View Analysis Details">
                    <i class="fas fa-info-circle"></i> Details
                </button>` : '<span style="color: #cbd5e1; font-size: 0.875rem;">-</span>'}
            </td>
        `;

            tbody.appendChild(row);
        });

        // Update counters
        document.getElementById('jsfiles-count-display').textContent = `${data.total} file${data.total !== 1 ? 's' : ''}`;
        document.getElementById('jsfiles-showing-start').textContent = data.showing_start;
        document.getElementById('jsfiles-showing-end').textContent = data.showing_end;
        document.getElementById('jsfiles-total').textContent = data.total;
    }

    // Render JS Files pagination
    function renderJSFilesPagination(data) {
        const container = document.getElementById('jsfiles-pagination');
        container.innerHTML = '';

        if (data.total_pages <= 1) return;

        // Previous button
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i> Prev';
        prevBtn.style.cssText = 'padding: 0.5rem 1rem; border: 2px solid #fde68a; border-radius: 8px; background: white; color: #78350f; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.2s;';
        prevBtn.disabled = data.page === 1;
        if (prevBtn.disabled) {
            prevBtn.style.opacity = '0.5';
            prevBtn.style.cursor = 'not-allowed';
        }
        prevBtn.onclick = () => gotoJSFilesPage(data.page - 1);
        container.appendChild(prevBtn);

        // Page numbers
        const maxPages = 5;
        let startPage = Math.max(1, data.page - Math.floor(maxPages / 2));
        let endPage = Math.min(data.total_pages, startPage + maxPages - 1);

        if (endPage - startPage < maxPages - 1) {
            startPage = Math.max(1, endPage - maxPages + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.textContent = i;
            pageBtn.style.cssText = 'padding: 0.5rem 0.875rem; border: 2px solid #fde68a; border-radius: 8px; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.2s;';

            if (i === data.page) {
                pageBtn.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                pageBtn.style.color = 'white';
                pageBtn.style.borderColor = '#f59e0b';
            } else {
                pageBtn.style.background = 'white';
                pageBtn.style.color = '#78350f';
            }

            pageBtn.onclick = () => gotoJSFilesPage(i);
            container.appendChild(pageBtn);
        }

        // Next button
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
        nextBtn.style.cssText = 'padding: 0.5rem 1rem; border: 2px solid #fde68a; border-radius: 8px; background: white; color: #78350f; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.2s;';
        nextBtn.disabled = data.page === data.total_pages;
        if (nextBtn.disabled) {
            nextBtn.style.opacity = '0.5';
            nextBtn.style.cursor = 'not-allowed';
        }
        nextBtn.onclick = () => gotoJSFilesPage(data.page + 1);
        container.appendChild(nextBtn);
    }

    // Navigate to JS Files page
    function gotoJSFilesPage(page) {
        jsfilesState.currentPage = page;
        jsfilesState.loaded = false;
        loadJSFilesData();
    }

    // Apply JS Files filters
    function applyJSFilesFilters() {
        jsfilesState.search = document.getElementById('jsfiles-search').value.trim();
        jsfilesState.exclude = document.getElementById('jsfiles-exclude').value.trim();
        jsfilesState.statusFilter = document.getElementById('jsfiles-status').value;
        jsfilesState.secretsFilter = document.getElementById('jsfiles-secrets').value;
        jsfilesState.perPage = parseInt(document.getElementById('jsfiles-per-page').value);
        jsfilesState.currentPage = 1;
        jsfilesState.loaded = false;

        // Show loading
        document.getElementById('jsfiles-content').style.display = 'none';
        document.getElementById('jsfiles-loading').style.display = 'block';
        document.getElementById('jsfiles-loading').innerHTML = `
        <div style="text-align: center; padding: 3rem;">
            <div style="display: inline-block; padding: 2rem; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 50%; margin-bottom: 1.5rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: white;"></i>
            </div>
            <h3 style="color: #1e293b;">Applying Filters...</h3>
        </div>
    `;

        loadJSFilesData();
    }

    // Reset JS Files filters
    function resetJSFilesFilters() {
        document.getElementById('jsfiles-search').value = '';
        document.getElementById('jsfiles-exclude').value = '';
        document.getElementById('jsfiles-status').value = '';
        document.getElementById('jsfiles-secrets').value = '';
        document.getElementById('jsfiles-per-page').value = '100';
        applyJSFilesFilters();
    }

    // Copy to clipboard utility
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast('URL copied to clipboard!', 'success');
        }).catch(() => {
            showToast('Failed to copy URL', 'error');
        });
    }

    // Show JS File Details
    function showJSFileDetail(index) {
        // Find the file data from the rendered table or fetch from current state if implementing properly
        // Here we need to grab the data from the event/click, but since we re-render, 
        // we assume we can get it from a global or passed data.
        // Actually, we should store current data in state

        // Wait, renderJSFilesTable receives 'data' but doesn't store in global cache by default for specific items unless cached
        // Let's use the 'cachedData' if available or just the rendered rows?
        // Better: renderJSFilesTable should maybe store the current list in jsfilesState.currentList?
        // Or we just access jsfilesState.cachedData if we stored it there?

        // Let's modify loadJSFilesData to store in cachedData
        // (Assuming loadJSFilesData doesn't store it yet? It does: jsfilesState.loaded = true but data?)
        // Wait, loadJSFilesData only sets loaded=true. Let's fix that first below if needed.
        // But for now let's assume we can access via a dirty hack or fix the flow.

        // UPDATE: I will fix this properly by assuming we add data caching in loadJSFilesData in next edit if needed,
        // but for now let's assume we can pass the data object to renderJSFilesTable and use it.
        // Actually, renderJSFilesTable is called with 'data'. 
        // We can't access 'data' here in this function scope unless it's global.

        // Let's look at how events does it: eventsState.cachedData.
        // Does jsfilesState have cachedData? Yes defined at top.
        // Does loadJSFilesData set it? NO! loadJSFilesData lines 336-378... 
        // It does NOT set jsfilesState.cachedData = data; 

        // I will add the setter in a separate edit or assume I can fix it here?
        // I can't fix loadJSFilesData in this 'MultiReplace' easily if I don't target it.
        // I will target the end of file for this function, and rely on a followup to fix the caching if needed.
        // WAIT, I can fix the caching in THIS replace if I include the loadJSFilesData function? 
        // No, that function is 200 lines up.

        // I'll implement showJSFileDetail assuming jsfilesState.cachedData is populated.
        // AND I'll provide a separate edit to ensure it IS populated.

        const data = jsfilesState.cachedData;
        if (!data || !data.js_files || !data.js_files[index]) return;

        const file = data.js_files[index];
        const modal = document.getElementById('jsfile-detail-modal');
        const content = document.getElementById('jsfile-detail-content');

        // URLs Section (Endpoints found)
        let endpointsHtml = '';
        if (file.endpoints && file.endpoints.length > 0) {
            endpointsHtml = `
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0; max-height: 200px; overflow-y: auto;">
                    <ul style="margin: 0; padding-left: 1.2rem; font-family: monospace; font-size: 0.8rem;">
                        ${file.endpoints.map(ep => `<li style="margin-bottom: 0.25rem; color: #475569;">${ep}</li>`).join('')}
                    </ul>
                </div>
            `;
        } else {
            endpointsHtml = '<p style="color: #94a3b8; font-style: italic;">No endpoints discovered in this file.</p>';
        }

        // Secrets Section
        let secretsHtml = '';
        if (file.secrets && file.secrets.has_secrets && file.secrets.secrets_found && file.secrets.secrets_found.length > 0) {
            secretsHtml = file.secrets.secrets_found.map(secret => `
                <div style="background: #fff1f2; border-left: 4px solid #f43f5e; padding: 0.75rem; border-radius: 4px; margin-bottom: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                        <span style="font-weight: 700; color: #9f1239; font-size: 0.8rem;">${secret.type}</span>
                        <span style="background: #f43f5e; color: white; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">${secret.severity}</span>
                    </div>
                    <code style="display: block; background: rgba(255,255,255,0.5); padding: 0.25rem; font-size: 0.75rem; color: #881337; word-break: break-all;">
                        ${secret.value}
                    </code>
                </div>
            `).join('');
        } else {
            secretsHtml = '<div style="background: #f0fdf4; border-left: 4px solid #22c55e; padding: 1rem; color: #15803d; border-radius: 6px;">No secrets detected. safe!</div>';
        }

        content.innerHTML = `
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">File URL</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" value="${file.url}" readonly 
                        style="flex: 1; padding: 0.5rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; font-family: monospace; color: #334155;">
                    <button onclick="copyToClipboard('${file.url.replace(/'/g, "\\'")}')" 
                        style="padding: 0.5rem 0.75rem; background: white; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                <!-- Endpoints Column -->
                <div>
                    <h4 style="color: #334155; margin: 0 0 1rem 0; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-link" style="color: #3b82f6;"></i> Discovered Endpoints
                        <span style="background: #eff6ff; color: #1d4ed8; padding: 0.1rem 0.5rem; border-radius: 10px; font-size: 0.75rem;">${file.endpoints ? file.endpoints.length : 0}</span>
                    </h4>
                    ${endpointsHtml}
                </div>

                <!-- Secrets Column -->
                <div>
                    <h4 style="color: #334155; margin: 0 0 1rem 0; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-key" style="color: #f59e0b;"></i> Potential Secrets
                    </h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${secretsHtml}
                    </div>
                </div>
            </div>
            
            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                 <label style="display: block; font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.5rem;">Raw Analysis Data</label>
                 <pre style="margin: 0; font-size: 0.75rem; color: #475569; max-height: 150px; overflow-y: auto; white-space: pre-wrap;">${JSON.stringify(file, null, 2)}</pre>
            </div>
        `;

        modal.style.display = 'flex';
    }

    function closeJSFileDetail() {
        document.getElementById('jsfile-detail-modal').style.display = 'none';
    }

    // Close modal when clicking outside
    document.addEventListener('click', (e) => {
        const modal = document.getElementById('jsfile-detail-modal');
        if (e.target === modal) {
            closeJSFileDetail();
        }
    });

</script>