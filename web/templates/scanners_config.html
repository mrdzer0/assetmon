{% extends "base.html" %}

{% block title %}Scanner Configuration - Asset Monitor{% endblock %}

{% block content %}
<div class="scanners-config-page">
    <div class="page-header">
        <h2><i class="fas fa-cogs"></i> Scanner Configuration</h2>
        <p class="text-muted">Configure scanning tools and their parameters</p>
    </div>

    <!-- Scan Mode Configuration -->
    <div class="section"
        style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border: 1px solid #667eea40;">
        <div class="section-header" onclick="toggleSection('scan-modes')">
            <h3><i class="fas fa-tasks"></i> Scan Mode Configuration</h3>
            <i class="fas fa-chevron-down toggle-icon" id="scan-modes-icon"></i>
        </div>
        <div class="section-body" id="scan-modes-body">
            <p class="text-muted" style="margin-bottom: 1rem;">Configure which modules run in Normal (Daily) and Weekly
                scheduled scans</p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                <!-- Normal Scan -->
                <div style="background: white; border-radius: 10px; padding: 1rem; border: 1px solid #e2e8f0;">
                    <h4 style="margin: 0 0 1rem 0; color: #3b82f6; font-size: 1rem;">
                        <i class="fas fa-clock"></i> Normal Scan (Daily)
                    </h4>
                    <div class="toggle-group" style="gap: 0.5rem;">
                        <label class="toggle-item" style="padding: 0.4rem 0;">
                            <input type="checkbox" id="normal-subdomains" checked disabled style="opacity: 0.6;">
                            <span class="toggle-label"><strong>Subdomain Discovery</strong></span>
                            <span style="color: #64748b; font-size: 0.75rem; margin-left: 0.5rem;">(Always)</span>
                        </label>
                        <label class="toggle-item" style="padding: 0.4rem 0;">
                            <input type="checkbox" id="normal-dns" checked disabled style="opacity: 0.6;">
                            <span class="toggle-label"><strong>DNS Resolution</strong></span>
                            <span style="color: #64748b; font-size: 0.75rem; margin-left: 0.5rem;">(Always)</span>
                        </label>
                        <label class="toggle-item" style="padding: 0.4rem 0;">
                            <input type="checkbox" id="normal-http" checked disabled style="opacity: 0.6;">
                            <span class="toggle-label"><strong>HTTP Probing</strong></span>
                            <span style="color: #64748b; font-size: 0.75rem; margin-left: 0.5rem;">(Always)</span>
                        </label>
                        <label class="toggle-item" style="padding: 0.4rem 0;">
                            <input type="checkbox" id="normal-ports" onchange="configChanged()">
                            <span class="toggle-label"><strong>Port Scanning</strong></span>
                        </label>
                        <label class="toggle-item" style="padding: 0.4rem 0;">
                            <input type="checkbox" id="normal-endpoints" onchange="configChanged()">
                            <span class="toggle-label"><strong>Endpoint Discovery</strong></span>
                        </label>
                        <label class="toggle-item" style="padding: 0.4rem 0;">
                            <input type="checkbox" id="normal-shodan" onchange="configChanged()">
                            <span class="toggle-label"><strong>Shodan Lookup</strong></span>
                        </label>
                        <label class="toggle-item" style="padding: 0.4rem 0;">
                            <input type="checkbox" id="normal-nuclei" onchange="configChanged()">
                            <span class="toggle-label"><strong>Nuclei Scan</strong></span>
                        </label>
                    </div>
                </div>

                <!-- Weekly Scan -->
                <div style="background: white; border-radius: 10px; padding: 1rem; border: 1px solid #e2e8f0;">
                    <h4 style="margin: 0 0 1rem 0; color: #8b5cf6; font-size: 1rem;">
                        <i class="fas fa-calendar-week"></i> Weekly Scan
                    </h4>
                    <div class="toggle-group" style="gap: 0.5rem;">
                        <label class="toggle-item" style="padding: 0.4rem 0;">
                            <input type="checkbox" id="weekly-subdomains" checked disabled style="opacity: 0.6;">
                            <span class="toggle-label"><strong>Subdomain Discovery</strong></span>
                            <span style="color: #64748b; font-size: 0.75rem; margin-left: 0.5rem;">(Always)</span>
                        </label>
                        <label class="toggle-item" style="padding: 0.4rem 0;">
                            <input type="checkbox" id="weekly-dns" checked disabled style="opacity: 0.6;">
                            <span class="toggle-label"><strong>DNS Resolution</strong></span>
                            <span style="color: #64748b; font-size: 0.75rem; margin-left: 0.5rem;">(Always)</span>
                        </label>
                        <label class="toggle-item" style="padding: 0.4rem 0;">
                            <input type="checkbox" id="weekly-http" checked disabled style="opacity: 0.6;">
                            <span class="toggle-label"><strong>HTTP Probing</strong></span>
                            <span style="color: #64748b; font-size: 0.75rem; margin-left: 0.5rem;">(Always)</span>
                        </label>
                        <label class="toggle-item" style="padding: 0.4rem 0;">
                            <input type="checkbox" id="weekly-ports" checked onchange="configChanged()">
                            <span class="toggle-label"><strong>Port Scanning</strong></span>
                        </label>
                        <label class="toggle-item" style="padding: 0.4rem 0;">
                            <input type="checkbox" id="weekly-endpoints" checked onchange="configChanged()">
                            <span class="toggle-label"><strong>Endpoint Discovery</strong></span>
                        </label>
                        <label class="toggle-item" style="padding: 0.4rem 0;">
                            <input type="checkbox" id="weekly-shodan" checked onchange="configChanged()">
                            <span class="toggle-label"><strong>Shodan Lookup</strong></span>
                        </label>
                        <label class="toggle-item" style="padding: 0.4rem 0;">
                            <input type="checkbox" id="weekly-nuclei" checked onchange="configChanged()">
                            <span class="toggle-label"><strong>Nuclei Scan</strong></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tool Status Section -->
    <div class="section">
        <div class="section-header" onclick="toggleSection('tools-status')">
            <h3><i class="fas fa-tools"></i> Tool Status</h3>
            <i class="fas fa-chevron-down toggle-icon" id="tools-status-icon"></i>
        </div>
        <div class="section-body" id="tools-status-body">
            <div class="tool-status-grid" id="toolStatusGrid">
                <p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading tool status...</p>
            </div>
        </div>
    </div>

    <!-- Subdomain Discovery -->
    <div class="section">
        <div class="section-header" onclick="toggleSection('subdomain')">
            <h3><i class="fas fa-sitemap"></i> Subdomain Discovery</h3>
            <i class="fas fa-chevron-down toggle-icon" id="subdomain-icon"></i>
        </div>
        <div class="section-body" id="subdomain-body">
            <div class="toggle-group">
                <label class="toggle-item">
                    <input type="checkbox" id="subfinder-enabled" onchange="configChanged()">
                    <span class="toggle-label"><strong>Subfinder</strong> - Fast passive subdomain enumeration</span>
                </label>
                <label class="toggle-item">
                    <input type="checkbox" id="assetfinder-enabled" onchange="configChanged()">
                    <span class="toggle-label"><strong>Assetfinder</strong> - Find related subdomains</span>
                </label>
                <label class="toggle-item">
                    <input type="checkbox" id="amass-enabled" onchange="configChanged()">
                    <span class="toggle-label"><strong>Amass</strong> - Comprehensive OSINT (slower)</span>
                </label>
                <label class="toggle-item">
                    <input type="checkbox" id="crtsh-enabled" onchange="configChanged()">
                    <span class="toggle-label"><strong>crt.sh</strong> - Certificate transparency logs</span>
                </label>
                <label class="toggle-item">
                    <input type="checkbox" id="chaos-enabled" onchange="configChanged()">
                    <span class="toggle-label"><strong>Chaos</strong> - ProjectDiscovery's public subdomain
                        dataset</span>
                </label>
            </div>
        </div>
    </div>

    <!-- DNS Resolution -->
    <div class="section">
        <div class="section-header" onclick="toggleSection('dns')">
            <h3><i class="fas fa-network-wired"></i> DNS Resolution</h3>
            <i class="fas fa-chevron-down toggle-icon" id="dns-icon"></i>
        </div>
        <div class="section-body" id="dns-body">
            <div class="form-group">
                <label>Rate Limit (queries/second)</label>
                <input type="number" id="dns-rate-limit" class="form-control" min="10" max="1000"
                    onchange="configChanged()">
            </div>
            <div class="form-group">
                <label>Record Types</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" data-record="A" checked onchange="configChanged()"> A</label>
                    <label><input type="checkbox" data-record="AAAA" onchange="configChanged()"> AAAA</label>
                    <label><input type="checkbox" data-record="CNAME" checked onchange="configChanged()"> CNAME</label>
                    <label><input type="checkbox" data-record="MX" onchange="configChanged()"> MX</label>
                    <label><input type="checkbox" data-record="TXT" onchange="configChanged()"> TXT</label>
                </div>
            </div>
        </div>
    </div>

    <!-- HTTP Probing -->
    <div class="section">
        <div class="section-header" onclick="toggleSection('http')">
            <h3><i class="fas fa-globe"></i> HTTP Probing</h3>
            <i class="fas fa-chevron-down toggle-icon" id="http-icon"></i>
        </div>
        <div class="section-body" id="http-body">
            <div class="form-row">
                <div class="form-group">
                    <label>Threads</label>
                    <input type="number" id="http-threads" class="form-control" min="1" max="200"
                        onchange="configChanged()">
                </div>
                <div class="form-group">
                    <label>Timeout (seconds)</label>
                    <input type="number" id="http-timeout" class="form-control" min="1" max="60"
                        onchange="configChanged()">
                </div>
            </div>
            <label class="toggle-item">
                <input type="checkbox" id="http-follow-redirects" onchange="configChanged()">
                <span class="toggle-label">Follow Redirects</span>
            </label>
        </div>
    </div>

    <!-- Port Scanning -->
    <div class="section">
        <div class="section-header" onclick="toggleSection('ports')">
            <h3><i class="fas fa-ethernet"></i> Port Scanning (Naabu)</h3>
            <i class="fas fa-chevron-down toggle-icon" id="ports-icon"></i>
        </div>
        <div class="section-body" id="ports-body">
            <label class="toggle-item" style="margin-bottom: 1rem;">
                <input type="checkbox" id="ports-enabled" onchange="configChanged()">
                <span class="toggle-label"><strong>Enable Port Scanning</strong></span>
            </label>
            <div class="form-group">
                <label>Ports to Scan (comma-separated)</label>
                <input type="text" id="ports-list" class="form-control" placeholder="8080,8443,3000,..."
                    onchange="configChanged()">
                <small class="text-muted">Ports 80 and 443 are excluded (already scanned by httpx)</small>
            </div>
            <div class="form-group">
                <label>Rate (packets/second)</label>
                <input type="number" id="ports-rate" class="form-control" min="100" max="5000"
                    onchange="configChanged()">
            </div>
            <label class="toggle-item" style="margin-top: 1rem;">
                <input type="checkbox" id="ports-screenshot" onchange="configChanged()">
                <span class="toggle-label"><strong>Enable Screenshots</strong></span>
            </label>
            <small class="text-muted" style="display: block; margin-left: 2.5rem;">Capture screenshots of discovered
                services (requires Chrome/Chromium)</small>
        </div>
    </div>

    <!-- Nuclei Scanning -->
    <div class="section">
        <div class="section-header" onclick="toggleSection('nuclei')">
            <h3><i class="fas fa-shield-alt"></i> Vulnerability Scanning (Nuclei)</h3>
            <i class="fas fa-chevron-down toggle-icon" id="nuclei-icon"></i>
        </div>
        <div class="section-body" id="nuclei-body">
            <label class="toggle-item" style="margin-bottom: 1rem;">
                <input type="checkbox" id="nuclei-enabled" onchange="configChanged()">
                <span class="toggle-label"><strong>Enable Nuclei Scanning</strong></span>
            </label>
            <div class="form-group">
                <label>Severity Filter</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" data-severity="critical" onchange="configChanged()"> Critical</label>
                    <label><input type="checkbox" data-severity="high" onchange="configChanged()"> High</label>
                    <label><input type="checkbox" data-severity="medium" onchange="configChanged()"> Medium</label>
                    <label><input type="checkbox" data-severity="low" onchange="configChanged()"> Low</label>
                    <label><input type="checkbox" data-severity="info" onchange="configChanged()"> Info</label>
                </div>
            </div>
            <div class="form-group">
                <label>Custom Templates Path (optional)</label>
                <input type="text" id="nuclei-templates" class="form-control" placeholder="/path/to/templates"
                    onchange="configChanged()">
                <small class="text-muted">Leave empty to use default Nuclei templates</small>
            </div>
            <div class="form-group">
                <label>Concurrency</label>
                <input type="number" id="nuclei-concurrency" class="form-control" min="1" max="100"
                    onchange="configChanged()">
            </div>
        </div>
    </div>

    <!-- Endpoint Discovery -->
    <div class="section">
        <div class="section-header" onclick="toggleSection('endpoints')">
            <h3><i class="fas fa-link"></i> Endpoint Discovery</h3>
            <i class="fas fa-chevron-down toggle-icon" id="endpoints-icon"></i>
        </div>
        <div class="section-body" id="endpoints-body">
            <div class="toggle-group">
                <label class="toggle-item">
                    <input type="checkbox" id="waybackurls-enabled" onchange="configChanged()">
                    <span class="toggle-label"><strong>Waybackurls</strong> - URLs from Wayback Machine</span>
                </label>
                <label class="toggle-item">
                    <input type="checkbox" id="gau-enabled" onchange="configChanged()">
                    <span class="toggle-label"><strong>GAU</strong> - Get All URLs from various sources</span>
                </label>
                <label class="toggle-item">
                    <input type="checkbox" id="katana-enabled" onchange="configChanged()">
                    <span class="toggle-label"><strong>Katana</strong> - Active crawling and endpoint discovery</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Shodan -->
    <div class="section">
        <div class="section-header" onclick="toggleSection('shodan')">
            <h3><i class="fas fa-search"></i> Shodan Integration</h3>
            <i class="fas fa-chevron-down toggle-icon" id="shodan-icon"></i>
        </div>
        <div class="section-body" id="shodan-body">
            <label class="toggle-item">
                <input type="checkbox" id="shodan-enabled" onchange="configChanged()">
                <span class="toggle-label"><strong>Enable Shodan</strong> - Port/CVE intelligence from Shodan</span>
            </label>
            <small class="text-muted">API key is configured in the main settings page</small>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-bar">
        <button class="btn btn-secondary" onclick="resetToDefaults()">
            <i class="fas fa-undo"></i> Reset to Defaults
        </button>
        <button class="btn btn-primary" id="saveBtn" onclick="saveAllConfigs()" disabled>
            <i class="fas fa-save"></i> Save Changes
        </button>
    </div>
</div>

<style>
    .scanners-config-page {
        max-width: 800px;
        margin: 0 auto;
    }

    .section {
        background: white;
        border-radius: 8px;
        margin-bottom: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        cursor: pointer;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        transition: background 0.2s;
    }

    .section-header:hover {
        background: #f1f5f9;
    }

    .section-header h3 {
        margin: 0;
        font-size: 1rem;
        color: #334155;
    }

    .section-body {
        padding: 1.5rem;
    }

    .section-body.collapsed {
        display: none;
    }

    .toggle-icon {
        transition: transform 0.2s;
        color: #94a3b8;
    }

    .toggle-icon.collapsed {
        transform: rotate(-90deg);
    }

    .toggle-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .toggle-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 6px;
        transition: background 0.2s;
    }

    .toggle-item:hover {
        background: #f8fafc;
    }

    .toggle-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .toggle-label {
        color: #64748b;
    }

    .toggle-label strong {
        color: #334155;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #475569;
    }

    .form-group .form-control {
        display: block;
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 0.9rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .checkbox-group label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: normal;
        cursor: pointer;
    }

    .tool-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 0.75rem;
    }

    .tool-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        background: #f8fafc;
    }

    .tool-status.installed {
        background: #dcfce7;
    }

    .tool-status.missing {
        background: #fee2e2;
    }

    .tool-status i.fa-check-circle {
        color: #22c55e;
    }

    .tool-status i.fa-times-circle {
        color: #ef4444;
    }

    .action-bar {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        padding: 1rem 0;
        border-top: 1px solid #e2e8f0;
        margin-top: 1rem;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #3b82f6;
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background: #2563eb;
    }

    .btn-primary:disabled {
        background: #93c5fd;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: #e2e8f0;
        color: #475569;
    }

    .btn-secondary:hover {
        background: #cbd5e1;
    }
</style>

{% endblock %}

{% block extra_js %}
<script>
    let configs = {};
    let hasChanges = false;

    document.addEventListener('DOMContentLoaded', () => {
        loadConfigs();
        loadToolStatus();
    });

    function toggleSection(section) {
        const body = document.getElementById(`${section}-body`);
        const icon = document.getElementById(`${section}-icon`);
        body.classList.toggle('collapsed');
        icon.classList.toggle('collapsed');
    }

    function loadConfigs() {
        fetch('/api/settings/scanners')
            .then(r => r.json())
            .then(data => {
                configs = data;
                populateForm(data);
            })
            .catch(err => {
                console.error('Failed to load configs:', err);
                showToast('Failed to load configurations', 'error');
            });
    }

    function loadToolStatus() {
        fetch('/api/settings/tools-status')
            .then(r => r.json())
            .then(data => {
                const grid = document.getElementById('toolStatusGrid');
                grid.innerHTML = '';
                for (const [tool, info] of Object.entries(data)) {
                    const div = document.createElement('div');
                    div.className = `tool-status ${info.installed ? 'installed' : 'missing'}`;
                    div.innerHTML = `
                        <i class="fas ${info.installed ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                        <strong>${tool}</strong>
                    `;
                    grid.appendChild(div);
                }
            })
            .catch(err => {
                console.error('Failed to load tool status:', err);
            });
    }

    function populateForm(data) {
        // Subdomain sources
        const subdomain = data.subdomain_sources?.value || {};
        document.getElementById('subfinder-enabled').checked = subdomain.subfinder?.enabled ?? true;
        document.getElementById('assetfinder-enabled').checked = subdomain.assetfinder?.enabled ?? true;
        document.getElementById('amass-enabled').checked = subdomain.amass?.enabled ?? false;
        document.getElementById('crtsh-enabled').checked = subdomain.crtsh?.enabled ?? true;
        document.getElementById('chaos-enabled').checked = subdomain.chaos?.enabled ?? true;

        // DNS config
        const dns = data.dns_config?.value || {};
        document.getElementById('dns-rate-limit').value = dns.rate_limit ?? 100;
        const recordTypes = dns.record_types || ['A', 'AAAA', 'CNAME', 'MX', 'TXT'];
        document.querySelectorAll('[data-record]').forEach(cb => {
            cb.checked = recordTypes.includes(cb.dataset.record);
        });

        // HTTP config
        const http = data.http_config?.value || {};
        document.getElementById('http-threads').value = http.threads ?? 50;
        document.getElementById('http-timeout').value = http.timeout ?? 10;
        document.getElementById('http-follow-redirects').checked = http.follow_redirects ?? true;

        // Port config
        const ports = data.port_config?.value || {};
        document.getElementById('ports-enabled').checked = ports.enabled ?? true;
        document.getElementById('ports-list').value = ports.ports ?? '8080,8443,8000,8888,3000,3443,5000,9000,9443,4443,2083,2087';
        document.getElementById('ports-rate').value = ports.rate ?? 500;
        document.getElementById('ports-screenshot').checked = ports.screenshot_enabled ?? false;

        // Nuclei config
        const nuclei = data.nuclei_config?.value || {};
        document.getElementById('nuclei-enabled').checked = nuclei.enabled ?? true;
        const severities = nuclei.severity_filter || ['critical', 'high', 'medium'];
        document.querySelectorAll('[data-severity]').forEach(cb => {
            cb.checked = severities.includes(cb.dataset.severity);
        });
        document.getElementById('nuclei-templates').value = nuclei.templates_path ?? '';
        document.getElementById('nuclei-concurrency').value = nuclei.concurrency ?? 25;

        // Endpoint sources
        const endpoints = data.endpoint_sources?.value || {};
        document.getElementById('waybackurls-enabled').checked = endpoints.waybackurls?.enabled ?? true;
        document.getElementById('gau-enabled').checked = endpoints.gau?.enabled ?? true;
        document.getElementById('katana-enabled').checked = endpoints.katana?.enabled ?? true;

        // Shodan config
        const shodan = data.shodan_config?.value || {};
        document.getElementById('shodan-enabled').checked = shodan.enabled ?? true;

        // Scan modes config
        const scanModes = data.scan_modes?.value || {};
        // Normal mode (optional modules)
        document.getElementById('normal-ports').checked = scanModes.normal?.ports ?? false;
        document.getElementById('normal-endpoints').checked = scanModes.normal?.endpoints ?? false;
        document.getElementById('normal-shodan').checked = scanModes.normal?.shodan ?? false;
        document.getElementById('normal-nuclei').checked = scanModes.normal?.nuclei ?? false;
        // Weekly mode (all enabled by default)
        document.getElementById('weekly-ports').checked = scanModes.weekly?.ports ?? true;
        document.getElementById('weekly-endpoints').checked = scanModes.weekly?.endpoints ?? true;
        document.getElementById('weekly-shodan').checked = scanModes.weekly?.shodan ?? true;
        document.getElementById('weekly-nuclei').checked = scanModes.weekly?.nuclei ?? true;
    }

    function configChanged() {
        hasChanges = true;
        document.getElementById('saveBtn').disabled = false;
    }

    function gatherConfigs() {
        // Gather selected record types
        const recordTypes = [];
        document.querySelectorAll('[data-record]:checked').forEach(cb => {
            recordTypes.push(cb.dataset.record);
        });

        // Gather severity filter
        const severities = [];
        document.querySelectorAll('[data-severity]:checked').forEach(cb => {
            severities.push(cb.dataset.severity);
        });

        return {
            subdomain_sources: {
                subfinder: { enabled: document.getElementById('subfinder-enabled').checked },
                assetfinder: { enabled: document.getElementById('assetfinder-enabled').checked },
                amass: { enabled: document.getElementById('amass-enabled').checked },
                crtsh: { enabled: document.getElementById('crtsh-enabled').checked },
                chaos: { enabled: document.getElementById('chaos-enabled').checked }
            },
            dns_config: {
                rate_limit: parseInt(document.getElementById('dns-rate-limit').value) || 100,
                record_types: recordTypes
            },
            http_config: {
                threads: parseInt(document.getElementById('http-threads').value) || 50,
                timeout: parseInt(document.getElementById('http-timeout').value) || 10,
                follow_redirects: document.getElementById('http-follow-redirects').checked
            },
            port_config: {
                enabled: document.getElementById('ports-enabled').checked,
                ports: document.getElementById('ports-list').value,
                rate: parseInt(document.getElementById('ports-rate').value) || 500,
                screenshot_enabled: document.getElementById('ports-screenshot').checked
            },
            nuclei_config: {
                enabled: document.getElementById('nuclei-enabled').checked,
                severity_filter: severities,
                templates_path: document.getElementById('nuclei-templates').value,
                concurrency: parseInt(document.getElementById('nuclei-concurrency').value) || 25
            },
            endpoint_sources: {
                waybackurls: { enabled: document.getElementById('waybackurls-enabled').checked },
                gau: { enabled: document.getElementById('gau-enabled').checked },
                katana: { enabled: document.getElementById('katana-enabled').checked }
            },
            shodan_config: {
                enabled: document.getElementById('shodan-enabled').checked
            },
            scan_modes: {
                normal: {
                    ports: document.getElementById('normal-ports').checked,
                    endpoints: document.getElementById('normal-endpoints').checked,
                    shodan: document.getElementById('normal-shodan').checked,
                    nuclei: document.getElementById('normal-nuclei').checked
                },
                weekly: {
                    ports: document.getElementById('weekly-ports').checked,
                    endpoints: document.getElementById('weekly-endpoints').checked,
                    shodan: document.getElementById('weekly-shodan').checked,
                    nuclei: document.getElementById('weekly-nuclei').checked
                }
            }
        };
    }

    function saveAllConfigs() {
        const btn = document.getElementById('saveBtn');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        btn.disabled = true;

        const configs = gatherConfigs();
        const body = {};
        for (const [key, value] of Object.entries(configs)) {
            body[key] = { value: value };
        }

        fetch('/api/settings/scanners', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        })
            .then(r => r.json())
            .then(data => {
                showToast(`Saved ${data.count} configurations`, 'success');
                hasChanges = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            })
            .catch(err => {
                console.error('Failed to save:', err);
                showToast('Failed to save configurations', 'error');
                btn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                btn.disabled = false;
            });
    }

    function resetToDefaults() {
        if (!confirm('Reset all scanner configurations to defaults?')) return;

        fetch('/api/settings/scanners/reset', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                showToast('Reset to defaults', 'success');
                loadConfigs();
                hasChanges = false;
                document.getElementById('saveBtn').disabled = true;
            })
            .catch(err => {
                console.error('Failed to reset:', err);
                showToast('Failed to reset configurations', 'error');
            });
    }
</script>
{% endblock %}